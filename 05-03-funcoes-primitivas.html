<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="pt-br" xml:lang="pt-br">
<head>
<!-- 2022-10-23 dom 23:28 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Funções primitivas</title>
<meta name="author" content="Lucas S. Vieira" />
<meta name="generator" content="Org Mode" />
<style>
  #content { max-width: 60em; margin: auto; }
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #e6e6e6;
    border-radius: 3px;
    background-color: #f2f2f2;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
  }
  pre.src:before {
    display: none;
    position: absolute;
    top: -8px;
    right: 12px;
    padding: 3px;
    color: #555;
    background-color: #f2f2f299;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-authinfo::before { content: 'Authinfo'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { }
</style>
<link rel="stylesheet" type="text/css" href="./main.css" />
<link rel="stylesheet" type="text/css" href="./syntax.css" />
<link id="theme-css" rel="stylesheet" type="text/css" href="./dark-theme.css" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta property="og:image" content="../img/cat-i-mage.jpg">
<meta name="theme-color" content="#14171e">
</head>
<body>
<div id="org-div-home-and-up">
 <a accesskey="h" href="05-axiomas.html"> UP </a>
 |
 <a accesskey="H" href="index.html"> HOME </a>
</div><div id="content" class="content">
<h1 class="title">Funções primitivas</h1>
<div id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#orgd26fe14">1. Importações</a></li>
<li><a href="#org212ab3c">2. <code>(cons x y)</code></a></li>
<li><a href="#orge7a5fdd">3. <code>(car x)</code></a></li>
<li><a href="#orgb1f4437">4. <code>(cdr x)</code></a></li>
<li><a href="#orgd599729">5. <code>(copy x)</code></a></li>
<li><a href="#org2cfa17f">6. <code>(length x)</code></a></li>
<li><a href="#orgf28f30f">7. <code>(depth x)</code></a></li>
<li><a href="#orgdf22f9d">8. <code>(type x)</code></a></li>
<li><a href="#org626882e">9. <code>(intern x)</code></a></li>
<li><a href="#orgdedea08">10. <code>(name x)</code></a></li>
<li><a href="#orgf5be62a">11. <code>(get-environment type)</code></a></li>
<li><a href="#org76b33f1">12. <code>(coin)</code></a></li>
<li><a href="#org414a441">13. <code>(sys com . args)</code></a></li>
<li><a href="#orgf7a2f5e">14. <code>(format fmt . rest)</code></a></li>
<li><a href="#orgc8ddf92">15. <code>(err fmt . rest)</code></a></li>
<li><a href="#orgfff673b">16. <code>(warn fmt . rest)</code></a></li>
<li><a href="#org0d440f3">17. <code>(list . rest)</code></a></li>
<li><a href="#orged2ac09">18. <code>(append . rest)</code></a></li>
<li><a href="#orgc41b0f4">19. <code>(last x)</code></a></li>
<li><a href="#org6697d56">20. <code>(reverse x)</code></a></li>
<li><a href="#orge8ea921">21. <code>(nthcdr n lst)</code></a></li>
<li><a href="#org6c6c88c">22. <code>(nth n lst)</code></a></li>
<li><a href="#orgfd8c4c0">23. <code>(macroexpand-1 x)</code></a></li>
<li><a href="#org5284f8a">24. <span class="todo TODO">TODO</span> <code>(macroexpand x)</code></a></li>
<li><a href="#orgaea254e">25. <code>(not x)</code></a></li>
<li><a href="#orgd382459">26. <code>(gensym)</code></a></li>
<li><a href="#org0e58517">27. Funções numéricas</a>
<ul>
<li><a href="#org926f802">27.1. <code>(number-coerce x subtype)</code></a></li>
<li><a href="#org21a5e79">27.2. <code>(real-part x)</code></a></li>
<li><a href="#org03ed51b">27.3. <code>(imag-part x)</code></a></li>
<li><a href="#org33aab02">27.4. <code>(numer x)</code></a></li>
<li><a href="#org76eb121">27.5. <code>(denom x)</code></a></li>
<li><a href="#org317c11b">27.6. <code>(richest-number-type x y)</code></a></li>
<li><a href="#orgfdc67db">27.7. <code>(rich-number-coerce x y)</code></a></li>
<li><a href="#orga04262f">27.8. <code>(iota n)</code></a></li>
</ul>
</li>
<li><a href="#orgb4b2bd3">28. <span class="todo TODO">TODO</span> Funções de comparação</a>
<ul>
<li><a href="#org67cdc05">28.1. Funções de ajuda e ferramentas</a>
<ul>
<li><a href="#org1b77933">28.1.1. Ajudante de coerções aritméticas</a></li>
<li><a href="#org2be9dc1">28.1.2. Tipos de despacho de aritmética</a></li>
<li><a href="#orge7213bc">28.1.3. Ajudante de despacho de aritmética</a></li>
<li><a href="#org0de633e">28.1.4. Comparação por igualdade</a></li>
<li><a href="#org8bfc5c1">28.1.5. Comparação de maior que / menor que</a></li>
</ul>
</li>
<li><a href="#org0244a0a">28.2. <code>(= x y . rest)</code></a></li>
<li><a href="#org60804c5">28.3. <code>(float= x y)</code></a></li>
<li><a href="#org14e3a1c">28.4. <code>(&gt; x y . rest)</code></a></li>
<li><a href="#org2124622">28.5. <code>(&lt; x y . rest)</code></a></li>
<li><a href="#orge793585">28.6. <code>(&gt;= x y . rest)</code></a></li>
<li><a href="#orge837e09">28.7. <code>(&lt;= x y . rest)</code></a></li>
</ul>
</li>
<li><a href="#orgb3cb4f9">29. Funções aritméticas</a>
<ul>
<li><a href="#org2efa026">29.1. Funções de ajuda e ferramentas</a>
<ul>
<li><a href="#org82e3635">29.1.1. Ajudante de soma</a></li>
<li><a href="#org189ca58">29.1.2. Ajudante de subtração</a></li>
<li><a href="#orgafa0365">29.1.3. Ajudante de multiplicação</a></li>
<li><a href="#org229d514">29.1.4. Ajudante de divisão</a></li>
</ul>
</li>
<li><a href="#orgc2bb12a">29.2. <code>(+ . rest)</code></a></li>
<li><a href="#orgbad963c">29.3. <code>(- . rest)</code></a></li>
<li><a href="#orgf807765">29.4. <code>(* . rest)</code></a></li>
<li><a href="#org454baf2">29.5. <code>(/ . rest)</code></a></li>
</ul>
</li>
<li><a href="#org847d885">30. Funções de streams</a>
<ul>
<li><a href="#orgece963d">30.1. Funções auxiliares</a>
<ul>
<li><a href="#org6e22c52">30.1.1. Desempacotamento de um File</a></li>
<li><a href="#org882ec1a">30.1.2. Testes de stream padrão</a></li>
</ul>
</li>
<li><a href="#org1403921">30.2. <code>(open-stream dir path)</code></a></li>
<li><a href="#orge4b63fe">30.3. <code>(close-stream x)</code></a></li>
<li><a href="#orge3ad0b5">30.4. <code>(stat x)</code></a></li>
<li><a href="#org6b5a5d1">30.5. <code>(read-char stream)</code></a></li>
<li><a href="#orgfe70f6b">30.6. <code>(peek-char stream)</code></a></li>
<li><a href="#orgb718d2a">30.7. <code>(write-char c stream)</code></a></li>
<li><a href="#org3eadbe1">30.8. <code>(write-string str stream)</code></a></li>
<li><a href="#org0705a60">30.9. <code>(write x stream)</code></a></li>
<li><a href="#orgeb9cc1c">30.10. <span class="todo TODO">TODO</span> <code>(read stream)</code></a></li>
</ul>
</li>
<li><a href="#org8a331f2">31. Funções de entrada e saída</a>
<ul>
<li><a href="#org976e6e6">31.1. <code>(terpri)</code></a></li>
<li><a href="#orga07aa3a">31.2. <code>(display x)</code></a></li>
<li><a href="#org243fde1">31.3. <span class="todo TODO">TODO</span> <code>(pretty-display x)</code></a></li>
<li><a href="#org13e79a7">31.4. <code>(print fmt . args)</code></a></li>
<li><a href="#orgf195a19">31.5. <span class="todo TODO">TODO</span> <code>(load path)</code></a></li>
</ul>
</li>
<li><a href="#org13cc223">32. Funções de vetores</a>
<ul>
<li><a href="#org16dba35">32.1. <code>(vec-type vec)</code></a></li>
<li><a href="#org7ceaa49">32.2. <code>(vec-push x vec)</code></a></li>
<li><a href="#orgf44e962">32.3. <code>(vec-insert pos x vec)</code></a></li>
<li><a href="#orgf8f51a5">32.4. <code>(vec-coerce vec type)</code></a></li>
<li><a href="#org95912f7">32.5. <code>(vector . rest)</code></a></li>
<li><a href="#orgf5a691b">32.6. <code>(vec-length vec)</code></a></li>
<li><a href="#org26b724f">32.7. <code>(vec-pop vec)</code></a></li>
<li><a href="#orgd8d5a46">32.8. <code>(vec-deq vec)</code></a></li>
<li><a href="#org212cdde">32.9. <code>(vec-at x vec)</code></a></li>
<li><a href="#orga58bee7">32.10. <code>(vec-set pos x vec)</code></a></li>
<li><a href="#org67d495f">32.11. <code>(vec-remove vec pos)</code></a></li>
</ul>
</li>
<li><a href="#org2f40199">33. Funções customizadas</a>
<ul>
<li><a href="#orgc4e8ef5">33.1. <code>(gc)</code></a></li>
<li><a href="#org53d9558">33.2. <code>(print-env type)</code></a></li>
<li><a href="#org425fb20">33.3. <code>(stack-state)</code></a></li>
</ul>
</li>
<li><a href="#org8f8802f">34. Registro em contexto global</a></li>
</ul>
</div>
</div>
<p>
Arquivo: <code>axioms/primitives.rs</code>.
</p>


<div id="outline-container-orgd26fe14" class="outline-2">
<h2 id="orgd26fe14"><span class="section-number-2">1.</span> Importações</h2>
<div class="outline-text-2" id="text-1">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #6a9955;">//</span><span style="color: #6a9955;">use std::fs::File;</span>
<span style="color: #569cd6;">use</span> <span style="color: #569cd6;">gc</span>::<span style="color: #4ec9b0;">Gc</span>;
<span style="color: #569cd6;">use</span> <span style="color: #569cd6;">crate</span>::<span style="color: #569cd6;">core</span>::{
    <span style="color: #4ec9b0;">Maj</span>,
    <span style="color: #4ec9b0;">MajState</span>
};
<span style="color: #569cd6;">use</span> <span style="color: #569cd6;">super</span>::<span style="color: #569cd6;">predicates</span>::{
    maj_eq,
    maj_nilp,
    maj_consp,
    maj_errorp,
    maj_stringp,
    maj_numberp,
    maj_vectorp,
    maj_proper_list_p
};
<span style="color: #569cd6;">use</span> <span style="color: #569cd6;">crate</span>::{ maj_list, maj_destructure_args };
<span style="color: #569cd6;">use</span> <span style="color: #569cd6;">super</span>::<span style="color: #4ec9b0;">MajRawSym</span>;
<span style="color: #569cd6;">use</span> <span style="color: #569cd6;">num_traits</span>::<span style="color: #4ec9b0;">FromPrimitive</span>;
<span style="color: #569cd6;">use</span> <span style="color: #569cd6;">crate</span>::<span style="color: #569cd6;">axioms</span>::<span style="color: #569cd6;">utils</span>::{ simplify_frac, simplify_frac_coerce };
<span style="color: #569cd6;">use</span> <span style="color: #569cd6;">crate</span>::<span style="color: #569cd6;">core</span>::<span style="color: #569cd6;">types</span>::<span style="color: #4ec9b0;">MajVectorType</span>;
</pre>
</div>
</div>
</div>

<div id="outline-container-org212ab3c" class="outline-2">
<h2 id="org212ab3c"><span class="section-number-2">2.</span> <code>(cons x y)</code></h2>
<div class="outline-text-2" id="text-2">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #569cd6;">pub</span> <span style="color: #569cd6;">fn</span> <span style="color: #dcdcaa;">maj_cons</span>(<span style="color: #9cdcfe;">x</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;, <span style="color: #9cdcfe;">y</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;) -&gt; <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt; {
    <span style="color: #569cd6;">if</span> maj_errorp(x.clone()).to_bool() {
        x
    } <span style="color: #569cd6;">else</span> <span style="color: #569cd6;">if</span> maj_errorp(y.clone()).to_bool() {
        y
    } <span style="color: #569cd6;">else</span> {
        <span style="color: #4ec9b0;">Maj</span>::cons(x, y)
    }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orge7a5fdd" class="outline-2">
<h2 id="orge7a5fdd"><span class="section-number-2">3.</span> <code>(car x)</code></h2>
<div class="outline-text-2" id="text-3">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #569cd6;">pub</span> <span style="color: #569cd6;">fn</span> <span style="color: #dcdcaa;">maj_car</span>(<span style="color: #9cdcfe;">x</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;) -&gt; <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt; {
    <span style="color: #569cd6;">match</span> <span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span>*x.clone() {
        <span style="color: #4ec9b0;">Maj</span>::<span style="color: #4ec9b0;">Sym</span>(_) =&gt; {
            <span style="color: #569cd6;">if</span> maj_nilp(x.clone()).to_bool() {
                <span style="color: #569cd6;">return</span> <span style="color: #4ec9b0;">Maj</span>::nil();
            }
        },
        <span style="color: #4ec9b0;">Maj</span>::<span style="color: #4ec9b0;">Cons</span> { car, <span style="color: #9cdcfe;">cdr</span>: _ } =&gt; {
            <span style="color: #569cd6;">return</span> car.clone();
        },
        _ =&gt; {}
    }
    maj_err(<span style="color: #4ec9b0;">Maj</span>::string(<span style="color: #ce9178;">"{} is not a cons cell"</span>),
            <span style="color: #c586c0;">maj_list!</span>(x))
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgb1f4437" class="outline-2">
<h2 id="orgb1f4437"><span class="section-number-2">4.</span> <code>(cdr x)</code></h2>
<div class="outline-text-2" id="text-4">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #569cd6;">pub</span> <span style="color: #569cd6;">fn</span> <span style="color: #dcdcaa;">maj_cdr</span>(<span style="color: #9cdcfe;">x</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;) -&gt; <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt; {
    <span style="color: #569cd6;">match</span> <span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span>*x.clone() {
        <span style="color: #4ec9b0;">Maj</span>::<span style="color: #4ec9b0;">Sym</span>(_) =&gt; {
            <span style="color: #569cd6;">if</span> maj_nilp(x.clone()).to_bool() {
                <span style="color: #569cd6;">return</span> <span style="color: #4ec9b0;">Maj</span>::nil();
            }
        },
        <span style="color: #4ec9b0;">Maj</span>::<span style="color: #4ec9b0;">Cons</span> { <span style="color: #9cdcfe;">car</span>: _, cdr } =&gt; {
            <span style="color: #569cd6;">return</span> cdr.clone();
        },
        _ =&gt; {}
    }
    maj_err(<span style="color: #4ec9b0;">Maj</span>::string(<span style="color: #ce9178;">"{} is not a cons cell"</span>),
            <span style="color: #c586c0;">maj_list!</span>(x))
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgd599729" class="outline-2">
<h2 id="orgd599729"><span class="section-number-2">5.</span> <code>(copy x)</code></h2>
<div class="outline-text-2" id="text-5">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #569cd6;">pub</span> <span style="color: #569cd6;">fn</span> <span style="color: #dcdcaa;">maj_copy</span>(<span style="color: #9cdcfe;">x</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;) -&gt; <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt; {
    <span style="color: #569cd6;">match</span> <span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span>*x.clone() {
        <span style="color: #4ec9b0;">Maj</span>::<span style="color: #4ec9b0;">Cons</span> { car, cdr } =&gt; {
            <span style="color: #4ec9b0;">Maj</span>::cons(car.clone(), cdr.clone())
        }
        _ =&gt; maj_err(
            <span style="color: #4ec9b0;">Maj</span>::string(<span style="color: #ce9178;">"{} is not a cons cell"</span>),
            <span style="color: #c586c0;">maj_list!</span>(x))
    }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org2cfa17f" class="outline-2">
<h2 id="org2cfa17f"><span class="section-number-2">6.</span> <code>(length x)</code></h2>
<div class="outline-text-2" id="text-6">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #569cd6;">pub</span> <span style="color: #569cd6;">fn</span> <span style="color: #dcdcaa;">maj_length</span>(<span style="color: #9cdcfe;">x</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;) -&gt; <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt; {
    <span style="color: #569cd6;">if</span> maj_nilp(x.clone()).to_bool() {
        <span style="color: #4ec9b0;">Maj</span>::integer(0)
    } <span style="color: #569cd6;">else</span> <span style="color: #569cd6;">if</span> !maj_consp(x.clone()).to_bool() {
        maj_err(
            <span style="color: #4ec9b0;">Maj</span>::string(<span style="color: #ce9178;">"{} is not a proper list"</span>),
            <span style="color: #c586c0;">maj_list!</span>(x.clone()))
    } <span style="color: #569cd6;">else</span> {
        <span style="color: #569cd6;">let</span> <span style="color: #569cd6;">mut</span> <span style="color: #9cdcfe;">itr</span>    = x.clone();
        <span style="color: #569cd6;">let</span> <span style="color: #569cd6;">mut</span> <span style="color: #9cdcfe;">length</span> = 0;
        <span style="color: #569cd6;">while</span> maj_consp(itr.clone()).to_bool() {
            length += 1;
            itr = maj_cdr(itr);
        }
        <span style="color: #4ec9b0;">Maj</span>::integer(length)
    }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgf28f30f" class="outline-2">
<h2 id="orgf28f30f"><span class="section-number-2">7.</span> <code>(depth x)</code></h2>
<div class="outline-text-2" id="text-7">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #569cd6;">fn</span> <span style="color: #dcdcaa;">maj_depth_helper</span>(<span style="color: #9cdcfe;">x</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;) -&gt; <span style="color: #4ec9b0;">i64</span> {
    <span style="color: #569cd6;">use</span> <span style="color: #569cd6;">std</span>::cmp;
    <span style="color: #569cd6;">if</span> !maj_consp(x.clone()).to_bool() {
        0
    } <span style="color: #569cd6;">else</span> {
        1 + <span style="color: #569cd6;">cmp</span>::max(maj_depth_helper(maj_car(x.clone())),
                     maj_depth_helper(maj_cdr(x)))
    }
}
</pre>
</div>

<div class="org-src-container">
<pre class="src src-rust"><span style="color: #569cd6;">pub</span> <span style="color: #569cd6;">fn</span> <span style="color: #dcdcaa;">maj_depth</span>(<span style="color: #9cdcfe;">x</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;) -&gt; <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt; {
    <span style="color: #569cd6;">use</span> <span style="color: #569cd6;">crate</span>::<span style="color: #569cd6;">axioms</span>::<span style="color: #569cd6;">predicates</span>::maj_atomp;
    <span style="color: #569cd6;">if</span> maj_nilp(x.clone()).to_bool() {
        <span style="color: #4ec9b0;">Maj</span>::integer(0)
    } <span style="color: #569cd6;">else</span> <span style="color: #569cd6;">if</span> maj_atomp(x.clone()).to_bool() {
        maj_err(<span style="color: #4ec9b0;">Maj</span>::string(
            <span style="color: #ce9178;">"{} is an atom"</span>), <span style="color: #c586c0;">maj_list!</span>(x))
    } <span style="color: #569cd6;">else</span> {
        <span style="color: #4ec9b0;">Maj</span>::integer(maj_depth_helper(x))
    }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgdf22f9d" class="outline-2">
<h2 id="orgdf22f9d"><span class="section-number-2">8.</span> <code>(type x)</code></h2>
<div class="outline-text-2" id="text-8">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #569cd6;">pub</span> <span style="color: #569cd6;">fn</span> <span style="color: #dcdcaa;">maj_type</span>(<span style="color: #569cd6;">mut</span> <span style="color: #9cdcfe;">state</span>: <span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> <span style="color: #4ec9b0;">MajState</span>, <span style="color: #9cdcfe;">x</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;) -&gt; <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt; {
    <span style="color: #569cd6;">use</span> <span style="color: #569cd6;">crate</span>::<span style="color: #569cd6;">core</span>::<span style="color: #569cd6;">types</span>::<span style="color: #4ec9b0;">MajNumber</span>;
    <span style="color: #4ec9b0;">Maj</span>::symbol(
        <span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state,
        <span style="color: #569cd6;">match</span> <span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span>*x {
            <span style="color: #4ec9b0;">Maj</span>::<span style="color: #4ec9b0;">Sym</span>(_)              =&gt;<span style="color: #ce9178;">"symbol"</span>,
            <span style="color: #4ec9b0;">Maj</span>::<span style="color: #4ec9b0;">Cons</span> {
                <span style="color: #9cdcfe;">car</span>: _, <span style="color: #9cdcfe;">cdr</span>: _
            }                        =&gt; <span style="color: #ce9178;">"cons"</span>,
            <span style="color: #4ec9b0;">Maj</span>::<span style="color: #4ec9b0;">Stream</span>(_)           =&gt; <span style="color: #ce9178;">"stream"</span>,
            <span style="color: #4ec9b0;">Maj</span>::<span style="color: #4ec9b0;">Char</span>(_)             =&gt; <span style="color: #ce9178;">"char"</span>,
            <span style="color: #4ec9b0;">Maj</span>::<span style="color: #4ec9b0;">Number</span>(num) =&gt; {
                <span style="color: #569cd6;">match</span> num.clone() {
                    <span style="color: #4ec9b0;">MajNumber</span>::<span style="color: #4ec9b0;">Integer</span>(_)     =&gt; <span style="color: #ce9178;">"integer"</span>,
                    <span style="color: #4ec9b0;">MajNumber</span>::<span style="color: #4ec9b0;">Float</span>(_)       =&gt; <span style="color: #ce9178;">"float"</span>,
                    <span style="color: #4ec9b0;">MajNumber</span>::<span style="color: #4ec9b0;">Fraction</span>(_, _) =&gt; <span style="color: #ce9178;">"fraction"</span>,
                    <span style="color: #4ec9b0;">MajNumber</span>::<span style="color: #4ec9b0;">Complex</span> {
                        <span style="color: #9cdcfe;">real</span>: _, <span style="color: #9cdcfe;">imag</span>: _
                    }                         =&gt; <span style="color: #ce9178;">"complex"</span>,
                }
            },
            <span style="color: #4ec9b0;">Maj</span>::<span style="color: #4ec9b0;">Vector</span>(_)            =&gt; <span style="color: #ce9178;">"vector"</span>,
        })
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org626882e" class="outline-2">
<h2 id="org626882e"><span class="section-number-2">9.</span> <code>(intern x)</code></h2>
<div class="outline-text-2" id="text-9">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #569cd6;">pub</span> <span style="color: #569cd6;">fn</span> <span style="color: #dcdcaa;">maj_intern</span>(<span style="color: #569cd6;">mut</span> <span style="color: #9cdcfe;">state</span>: <span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> <span style="color: #4ec9b0;">MajState</span>, <span style="color: #9cdcfe;">x</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;) -&gt; <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt; {
    <span style="color: #569cd6;">match</span> x.clone().stringify() {
        <span style="color: #4ec9b0;">Some</span>(string) =&gt; {
            <span style="color: #569cd6;">if</span> string == <span style="color: #ce9178;">""</span> {
                <span style="color: #4ec9b0;">Maj</span>::nil()
            } <span style="color: #569cd6;">else</span> {
                <span style="color: #4ec9b0;">Maj</span>::symbol(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, <span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span>string)
            }
        },
        <span style="color: #4ec9b0;">None</span> =&gt; {
            maj_err(<span style="color: #4ec9b0;">Maj</span>::string(<span style="color: #ce9178;">"{} is not a string"</span>),
                    <span style="color: #c586c0;">maj_list!</span>(x))
        },
    }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgdedea08" class="outline-2">
<h2 id="orgdedea08"><span class="section-number-2">10.</span> <code>(name x)</code></h2>
<div class="outline-text-2" id="text-10">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #569cd6;">pub</span> <span style="color: #569cd6;">fn</span> <span style="color: #dcdcaa;">maj_name</span>(<span style="color: #9cdcfe;">state</span>: <span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #4ec9b0;">MajState</span>, <span style="color: #9cdcfe;">x</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;) -&gt; <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt; {
    <span style="color: #569cd6;">use</span> <span style="color: #569cd6;">crate</span>::<span style="color: #569cd6;">printing</span>::maj_format;
    <span style="color: #569cd6;">if</span> <span style="color: #569cd6;">let</span> <span style="color: #4ec9b0;">Maj</span>::<span style="color: #4ec9b0;">Sym</span>(_) = <span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span>*x.clone() {
        <span style="color: #4ec9b0;">Maj</span>::string(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span>maj_format(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span>state, x))
    } <span style="color: #569cd6;">else</span> {
        maj_err(<span style="color: #4ec9b0;">Maj</span>::string(<span style="color: #ce9178;">"{} is not a symbol"</span>),
                <span style="color: #c586c0;">maj_list!</span>(x.clone()))
    }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgf5be62a" class="outline-2">
<h2 id="orgf5be62a"><span class="section-number-2">11.</span> <code>(get-environment type)</code></h2>
<div class="outline-text-2" id="text-11">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #569cd6;">pub</span> <span style="color: #569cd6;">fn</span> <span style="color: #dcdcaa;">maj_get_environment</span>(
    <span style="color: #569cd6;">mut</span> <span style="color: #9cdcfe;">state</span>: <span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> <span style="color: #4ec9b0;">MajState</span>,
    <span style="color: #9cdcfe;">type_sym</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;,
    <span style="color: #9cdcfe;">env</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;
) -&gt; <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt; {
    <span style="color: #569cd6;">if</span> maj_eq(type_sym.clone(),
              <span style="color: #4ec9b0;">Maj</span>::symbol(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, <span style="color: #ce9178;">"lexical"</span>))
        .to_bool()
    {
        env
    } <span style="color: #569cd6;">else</span> <span style="color: #569cd6;">if</span> maj_eq(type_sym.clone(),
                     <span style="color: #4ec9b0;">Maj</span>::symbol(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, <span style="color: #ce9178;">"global"</span>))
        .to_bool()
    {
        state.get_global_env()
    } <span style="color: #569cd6;">else</span> {
        maj_err(
            <span style="color: #4ec9b0;">Maj</span>::string(<span style="color: #ce9178;">"Unknown environment type {}"</span>),
            <span style="color: #c586c0;">maj_list!</span>(type_sym))
    }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org76b33f1" class="outline-2">
<h2 id="org76b33f1"><span class="section-number-2">12.</span> <code>(coin)</code></h2>
<div class="outline-text-2" id="text-12">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #569cd6;">pub</span> <span style="color: #569cd6;">fn</span> <span style="color: #dcdcaa;">maj_coin</span>() -&gt; <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt; {
    <span style="color: #569cd6;">use</span> <span style="color: #569cd6;">rand</span>::random;

    <span style="color: #569cd6;">if</span> random() {
        <span style="color: #4ec9b0;">Maj</span>::t()
    } <span style="color: #569cd6;">else</span> {
        <span style="color: #4ec9b0;">Maj</span>::nil()
    }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org414a441" class="outline-2">
<h2 id="org414a441"><span class="section-number-2">13.</span> <code>(sys com . args)</code></h2>
<div class="outline-text-2" id="text-13">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #569cd6;">pub</span> <span style="color: #569cd6;">fn</span> <span style="color: #dcdcaa;">maj_sys</span>(<span style="color: #9cdcfe;">com</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;, <span style="color: #9cdcfe;">args</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;) -&gt; <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt; {
    <span style="color: #569cd6;">use</span> <span style="color: #569cd6;">std</span>::<span style="color: #569cd6;">process</span>::<span style="color: #4ec9b0;">Command</span>;

    <span style="color: #569cd6;">if</span> !maj_stringp(com.clone()).to_bool() {
        <span style="color: #569cd6;">return</span> maj_err(
            <span style="color: #4ec9b0;">Maj</span>::string(<span style="color: #ce9178;">"{} is not a string"</span>),
            <span style="color: #c586c0;">maj_list!</span>(com));
    }

    <span style="color: #569cd6;">let</span> <span style="color: #569cd6;">mut</span> <span style="color: #9cdcfe;">comm</span> = <span style="color: #4ec9b0;">Command</span>::new(com.stringify().unwrap());

    <span style="color: #569cd6;">let</span> <span style="color: #569cd6;">mut</span> <span style="color: #9cdcfe;">itr</span> = args.clone();
    <span style="color: #569cd6;">while</span> !maj_nilp(itr.clone()).to_bool() {
        <span style="color: #569cd6;">if</span> <span style="color: #569cd6;">let</span> <span style="color: #4ec9b0;">Maj</span>::<span style="color: #4ec9b0;">Cons</span> { car, cdr } = <span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span>*itr.clone() {
            <span style="color: #569cd6;">if</span> !maj_stringp(car.clone()).to_bool() {
                <span style="color: #569cd6;">return</span> maj_err(
                    <span style="color: #4ec9b0;">Maj</span>::string(<span style="color: #ce9178;">"{} is not a string"</span>),
                    <span style="color: #c586c0;">maj_list!</span>(car.clone()));
            } <span style="color: #569cd6;">else</span> {
                <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">_</span> = comm.arg(car.clone()
                                 .stringify()
                                 .unwrap());
                itr = cdr.clone();
            }
        } <span style="color: #569cd6;">else</span> {};
    }

    <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">result</span> = <span style="color: #569cd6;">match</span> comm.status() {
        <span style="color: #4ec9b0;">Ok</span>(res) =&gt; res.code(),
        <span style="color: #4ec9b0;">Err</span>(_)  =&gt; <span style="color: #4ec9b0;">None</span>,
    };

    <span style="color: #569cd6;">match</span> result {
        <span style="color: #4ec9b0;">Some</span>(code) =&gt; <span style="color: #4ec9b0;">Maj</span>::integer(code <span style="color: #569cd6;">as</span> <span style="color: #4ec9b0;">i64</span>),
        <span style="color: #4ec9b0;">None</span> =&gt; maj_err(
            <span style="color: #4ec9b0;">Maj</span>::string(<span style="color: #ce9178;">"Error executing command {} {}"</span>),
            <span style="color: #c586c0;">maj_list!</span>(com, args)),
    }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgf7a2f5e" class="outline-2">
<h2 id="orgf7a2f5e"><span class="section-number-2">14.</span> <code>(format fmt . rest)</code></h2>
<div class="outline-text-2" id="text-14">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #569cd6;">pub</span> <span style="color: #569cd6;">fn</span> <span style="color: #dcdcaa;">maj_format_prim</span>(
    <span style="color: #9cdcfe;">state</span>: <span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #4ec9b0;">MajState</span>,
    <span style="color: #9cdcfe;">fmt</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;,
    <span style="color: #9cdcfe;">rest</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;
) -&gt; <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt; {
    <span style="color: #569cd6;">if</span> <span style="color: #569cd6;">let</span> <span style="color: #4ec9b0;">Some</span>(rfmt) = fmt.stringify() {
        <span style="color: #569cd6;">let</span> <span style="color: #569cd6;">mut</span> <span style="color: #9cdcfe;">buffer</span> = <span style="color: #4ec9b0;">String</span>::new();
        <span style="color: #569cd6;">let</span> <span style="color: #569cd6;">mut</span> <span style="color: #9cdcfe;">expect_closebracket</span> = <span style="color: #569cd6;">false</span>;
        <span style="color: #569cd6;">let</span> <span style="color: #569cd6;">mut</span> <span style="color: #9cdcfe;">gulp_next</span> = <span style="color: #569cd6;">false</span>;
        <span style="color: #569cd6;">let</span> <span style="color: #569cd6;">mut</span> <span style="color: #9cdcfe;">curr_arg</span> = rest.clone();
        <span style="color: #569cd6;">for</span> <span style="color: #9cdcfe;">c</span> <span style="color: #569cd6;">in</span> rfmt.chars() {
            <span style="color: #569cd6;">if</span> gulp_next {
                buffer.push(c);
                gulp_next = <span style="color: #569cd6;">false</span>;
            } <span style="color: #569cd6;">else</span> <span style="color: #569cd6;">if</span> expect_closebracket {
                <span style="color: #569cd6;">if</span> c == <span style="color: #ce9178;">'}'</span> {
                    <span style="color: #569cd6;">use</span> <span style="color: #569cd6;">crate</span>::<span style="color: #569cd6;">printing</span>::maj_format;
                    expect_closebracket = <span style="color: #569cd6;">false</span>;
                    <span style="color: #569cd6;">if</span> maj_nilp(curr_arg.clone()).to_bool() {
                        <span style="color: #569cd6;">return</span> maj_err(
                            <span style="color: #4ec9b0;">Maj</span>::string(<span style="color: #ce9178;">"Missing arguments on format"</span>),
                            <span style="color: #4ec9b0;">Maj</span>::nil());
                    }
                    <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">cafirst</span> = maj_car(curr_arg.clone());
                    <span style="color: #569cd6;">let</span> <span style="color: #569cd6;">mut</span> <span style="color: #9cdcfe;">formatted</span> =
                        <span style="color: #569cd6;">if</span> <span style="color: #569cd6;">let</span> <span style="color: #4ec9b0;">Maj</span>::<span style="color: #4ec9b0;">Char</span>(c) = <span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span>*cafirst.clone() {
                            <span style="color: #4ec9b0;">String</span>::from(<span style="color: #c586c0;">format!</span>(<span style="color: #ce9178;">"</span><span style="color: #ce9178; font-style: italic;">{}</span><span style="color: #ce9178;">"</span>, c))
                        } <span style="color: #569cd6;">else</span> {
                            maj_format(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span>state, cafirst)
                        };
                    <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">len</span> = formatted.len();
                    <span style="color: #569cd6;">if</span> (len &gt;= 2)
                        &amp;&amp; (formatted.chars().nth(0).unwrap() == <span style="color: #ce9178;">'"'</span>)
                        &amp;&amp; (formatted.chars().last().unwrap() == <span style="color: #ce9178;">'"'</span>) {
                            formatted =
                                <span style="color: #4ec9b0;">String</span>::from(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span>formatted[1..(len-1)]);
                        }
                    buffer.push_str(formatted.as_str());
                    curr_arg = maj_cdr(curr_arg);
                }
            } <span style="color: #569cd6;">else</span> {
                <span style="color: #569cd6;">match</span> c {
                    <span style="color: #ce9178;">'{'</span> =&gt; expect_closebracket = <span style="color: #569cd6;">true</span>,
                    <span style="color: #ce9178;">'\\'</span> =&gt; gulp_next = <span style="color: #569cd6;">true</span>,
                    <span style="color: #ce9178;">'}'</span> =&gt; {
                        <span style="color: #569cd6;">return</span> maj_err(
                            <span style="color: #4ec9b0;">Maj</span>::string(
                                <span style="color: #ce9178;">"Unmatched closing curly brace in {}"</span>),
                            <span style="color: #c586c0;">maj_list!</span>(fmt));
                    },
                    _ =&gt; buffer.push(c),
                }
            }
        }
        <span style="color: #569cd6;">if</span> expect_closebracket {
            <span style="color: #569cd6;">return</span> maj_err(
                <span style="color: #4ec9b0;">Maj</span>::string(<span style="color: #ce9178;">"Unmatched opening curly brace in {}"</span>),
                <span style="color: #c586c0;">maj_list!</span>(fmt));
        }
        <span style="color: #4ec9b0;">Maj</span>::string(buffer.as_ref())
    } <span style="color: #569cd6;">else</span> {
        maj_err(<span style="color: #4ec9b0;">Maj</span>::string(<span style="color: #ce9178;">"{} is not a string"</span>),
                <span style="color: #c586c0;">maj_list!</span>(fmt))
    }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc8ddf92" class="outline-2">
<h2 id="orgc8ddf92"><span class="section-number-2">15.</span> <code>(err fmt . rest)</code></h2>
<div class="outline-text-2" id="text-15">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #569cd6;">pub</span> <span style="color: #569cd6;">fn</span> <span style="color: #dcdcaa;">maj_err</span>(<span style="color: #9cdcfe;">fmt</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;, <span style="color: #9cdcfe;">rest</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;) -&gt; <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt; {
    <span style="color: #569cd6;">use</span> <span style="color: #569cd6;">crate</span>::maj_dotted_list;

    <span style="color: #569cd6;">if</span> !maj_stringp(fmt.clone()).to_bool() {
        <span style="color: #c586c0;">panic!</span>(<span style="color: #ce9178;">"Cannot throw error: {} is not a string"</span>, fmt);
    } <span style="color: #569cd6;">else</span> <span style="color: #569cd6;">if</span> !maj_proper_list_p(rest.clone()).to_bool() {
        <span style="color: #c586c0;">panic!</span>(<span style="color: #ce9178;">"Cannot throw error: {} is not a proper list"</span>, rest);
    }

    <span style="color: #c586c0;">maj_dotted_list!</span>(<span style="color: #4ec9b0;">Maj</span>::lit(), <span style="color: #4ec9b0;">Maj</span>::error(), fmt, rest)
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgfff673b" class="outline-2">
<h2 id="orgfff673b"><span class="section-number-2">16.</span> <code>(warn fmt . rest)</code></h2>
<div class="outline-text-2" id="text-16">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #569cd6;">pub</span> <span style="color: #569cd6;">fn</span> <span style="color: #dcdcaa;">maj_warn</span>(<span style="color: #569cd6;">mut</span> <span style="color: #9cdcfe;">state</span>: <span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> <span style="color: #4ec9b0;">MajState</span>, <span style="color: #9cdcfe;">fmt</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;,
                <span style="color: #9cdcfe;">rest</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;, <span style="color: #9cdcfe;">env</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;
) -&gt; <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt; {
    <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">format</span> = maj_format_prim(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span>state, fmt, rest);
    <span style="color: #569cd6;">if</span> maj_errorp(format.clone()).to_bool() {
        format
    } <span style="color: #569cd6;">else</span> {
        <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">stderr</span> = <span style="color: #4ec9b0;">Maj</span>::symbol(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, <span style="color: #ce9178;">"*stderr*"</span>);
        <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">stderr</span> = state.lookup(env, stderr);
        <span style="color: #569cd6;">if</span> maj_errorp(stderr.clone()).to_bool() {
            stderr
        } <span style="color: #569cd6;">else</span> {
            maj_write_string(
                <span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, format, stderr.clone());
            maj_write_char(
                <span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, <span style="color: #4ec9b0;">Maj</span>::character(<span style="color: #ce9178;">'\n'</span>), stderr);
            <span style="color: #4ec9b0;">Maj</span>::nil()
        }
    }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org0d440f3" class="outline-2">
<h2 id="org0d440f3"><span class="section-number-2">17.</span> <code>(list . rest)</code></h2>
<div class="outline-text-2" id="text-17">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #c586c0;">#[inline]</span>
<span style="color: #569cd6;">pub</span> <span style="color: #569cd6;">fn</span> <span style="color: #dcdcaa;">maj_list</span>(<span style="color: #9cdcfe;">rest</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;) -&gt; <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt; {
    rest
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orged2ac09" class="outline-2">
<h2 id="orged2ac09"><span class="section-number-2">18.</span> <code>(append . rest)</code></h2>
<div class="outline-text-2" id="text-18">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #569cd6;">pub</span> <span style="color: #569cd6;">fn</span> <span style="color: #dcdcaa;">maj_append</span>(<span style="color: #9cdcfe;">rest</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;) -&gt; <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt; {
    <span style="color: #569cd6;">use</span> <span style="color: #569cd6;">crate</span>::maj_dotted_list;
    <span style="color: #569cd6;">use</span> <span style="color: #569cd6;">crate</span>::<span style="color: #569cd6;">axioms</span>::<span style="color: #569cd6;">predicates</span>::maj_atomp;
    <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">car</span>  = maj_car(rest.clone());
    <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">cdr</span>  = maj_cdr(rest.clone());
    <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">cadr</span> = maj_car(cdr.clone());
    <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">cddr</span> = maj_cdr(cdr.clone());

    <span style="color: #569cd6;">if</span> maj_nilp(cdr.clone()).to_bool() {
        <span style="color: #569cd6;">return</span> car;
    }

    <span style="color: #569cd6;">let</span> <span style="color: #569cd6;">mut</span> <span style="color: #9cdcfe;">itr</span> = car.clone();
    <span style="color: #569cd6;">let</span> <span style="color: #569cd6;">mut</span> <span style="color: #9cdcfe;">v</span> = <span style="color: #4ec9b0;">Vec</span>::new();
    <span style="color: #569cd6;">while</span> !maj_nilp(itr.clone()).to_bool() {
        <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">cdar</span> = maj_cdr(itr.clone());
        <span style="color: #569cd6;">if</span> maj_atomp(cdar.clone()).to_bool()
            &amp;&amp; !maj_nilp(cdar.clone()).to_bool() {
                <span style="color: #569cd6;">return</span> maj_err(
                    <span style="color: #4ec9b0;">Maj</span>::string(<span style="color: #ce9178;">"Cannot append to dotted list"</span>),
                    <span style="color: #4ec9b0;">Maj</span>::nil());
            }
        v.push(maj_car(itr.clone()));
        itr = cdar;
    }
    itr = cadr.clone();
    <span style="color: #569cd6;">for</span> <span style="color: #9cdcfe;">obj</span> <span style="color: #569cd6;">in</span> v.iter().rev() {
        itr = <span style="color: #4ec9b0;">Maj</span>::cons(obj.clone(), itr.clone());
    }
    maj_append(<span style="color: #c586c0;">maj_dotted_list!</span>(itr.clone(), cddr))
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc41b0f4" class="outline-2">
<h2 id="orgc41b0f4"><span class="section-number-2">19.</span> <code>(last x)</code></h2>
<div class="outline-text-2" id="text-19">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #569cd6;">pub</span> <span style="color: #569cd6;">fn</span> <span style="color: #dcdcaa;">maj_last</span>(<span style="color: #9cdcfe;">x</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;) -&gt; <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt; {
    <span style="color: #569cd6;">if</span> !maj_consp(x.clone()).to_bool() {
        <span style="color: #569cd6;">return</span> maj_err(
            <span style="color: #4ec9b0;">Maj</span>::string(<span style="color: #ce9178;">"{} is not a cons"</span>),
            <span style="color: #c586c0;">maj_list!</span>(x));
    }

    <span style="color: #569cd6;">let</span> <span style="color: #569cd6;">mut</span> <span style="color: #9cdcfe;">itr</span> = x;
    <span style="color: #569cd6;">loop</span> {
        <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">cdr</span> = maj_cdr(itr.clone());
        <span style="color: #569cd6;">if</span> !maj_consp(cdr.clone()).to_bool() {
            <span style="color: #569cd6;">return</span> itr;
        }
        itr = cdr;
    }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org6697d56" class="outline-2">
<h2 id="org6697d56"><span class="section-number-2">20.</span> <code>(reverse x)</code></h2>
<div class="outline-text-2" id="text-20">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #569cd6;">pub</span> <span style="color: #569cd6;">fn</span> <span style="color: #dcdcaa;">maj_reverse</span>(<span style="color: #9cdcfe;">x</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;) -&gt; <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt; {
    <span style="color: #569cd6;">use</span> <span style="color: #569cd6;">crate</span>::<span style="color: #569cd6;">axioms</span>::<span style="color: #569cd6;">predicates</span>::maj_atomp;
    <span style="color: #569cd6;">if</span> !maj_consp(x.clone()).to_bool() {
        <span style="color: #569cd6;">return</span> maj_err(
            <span style="color: #4ec9b0;">Maj</span>::string(<span style="color: #ce9178;">"{} is not a cons"</span>),
            <span style="color: #c586c0;">maj_list!</span>(x));
    }

    <span style="color: #569cd6;">let</span> <span style="color: #569cd6;">mut</span> <span style="color: #9cdcfe;">itr</span> = x.clone();
    <span style="color: #569cd6;">let</span> <span style="color: #569cd6;">mut</span> <span style="color: #9cdcfe;">newlist</span> = <span style="color: #4ec9b0;">Maj</span>::nil();
    <span style="color: #569cd6;">while</span> !maj_nilp(itr.clone()).to_bool() {
        newlist = <span style="color: #4ec9b0;">Maj</span>::cons(maj_car(itr.clone()), newlist);
        itr = maj_cdr(itr);
        <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">is_atom</span> = maj_atomp(itr.clone()).to_bool();
        <span style="color: #569cd6;">if</span> is_atom &amp;&amp; !maj_nilp(itr.clone()).to_bool() {
            <span style="color: #569cd6;">return</span> maj_err(
                <span style="color: #4ec9b0;">Maj</span>::string(<span style="color: #ce9178;">"Not a proper list: {}"</span>),
                <span style="color: #c586c0;">maj_list!</span>(x));
        }
    }
    newlist
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orge8ea921" class="outline-2">
<h2 id="orge8ea921"><span class="section-number-2">21.</span> <code>(nthcdr n lst)</code></h2>
<div class="outline-text-2" id="text-21">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #569cd6;">pub</span> <span style="color: #569cd6;">fn</span> <span style="color: #dcdcaa;">maj_nthcdr</span>(<span style="color: #9cdcfe;">n</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;, <span style="color: #9cdcfe;">lst</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;) -&gt; <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt; {
    <span style="color: #569cd6;">use</span> <span style="color: #569cd6;">crate</span>::<span style="color: #569cd6;">axioms</span>::<span style="color: #569cd6;">predicates</span>::maj_integerp;
    <span style="color: #569cd6;">if</span> maj_nilp(lst.clone()).to_bool() {
        <span style="color: #569cd6;">return</span> <span style="color: #4ec9b0;">Maj</span>::nil();
    }

    <span style="color: #569cd6;">if</span> !maj_integerp(n.clone()).to_bool() {
        <span style="color: #569cd6;">return</span> maj_err(<span style="color: #4ec9b0;">Maj</span>::string(<span style="color: #ce9178;">"{} is not an integer"</span>),
                       <span style="color: #c586c0;">maj_list!</span>(n))
    }

    <span style="color: #569cd6;">let</span> <span style="color: #569cd6;">mut</span> <span style="color: #9cdcfe;">num</span> = n.to_integer().unwrap();
    <span style="color: #569cd6;">if</span> num &lt; 0 {
        <span style="color: #569cd6;">return</span> maj_err(<span style="color: #4ec9b0;">Maj</span>::string(<span style="color: #ce9178;">"{} is not a valid index"</span>),
                       <span style="color: #c586c0;">maj_list!</span>(n));
    }

    <span style="color: #569cd6;">let</span> <span style="color: #569cd6;">mut</span> <span style="color: #9cdcfe;">iter</span> = lst.clone();
    <span style="color: #569cd6;">loop</span> {
        <span style="color: #569cd6;">if</span> !maj_consp(iter.clone()).to_bool() &amp;&amp;
            !maj_nilp(iter.clone()).to_bool()
        {
            <span style="color: #569cd6;">return</span> maj_err(<span style="color: #4ec9b0;">Maj</span>::string(<span style="color: #ce9178;">"{} is not a list"</span>),
                           <span style="color: #c586c0;">maj_list!</span>(iter));
        }
        <span style="color: #569cd6;">if</span> num &lt;= 0 { <span style="color: #569cd6;">break</span>; }
        num -= 1;
        iter = maj_cdr(iter);
    }
    iter
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org6c6c88c" class="outline-2">
<h2 id="org6c6c88c"><span class="section-number-2">22.</span> <code>(nth n lst)</code></h2>
<div class="outline-text-2" id="text-22">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #569cd6;">pub</span> <span style="color: #569cd6;">fn</span> <span style="color: #dcdcaa;">maj_nth</span>(<span style="color: #9cdcfe;">n</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;, <span style="color: #9cdcfe;">lst</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;) -&gt; <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt; {
    <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">cons</span> = maj_nthcdr(n, lst);
    <span style="color: #569cd6;">if</span> maj_errorp(cons.clone()).to_bool() {
        cons
    } <span style="color: #569cd6;">else</span> {
        maj_car(cons)
    }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgfd8c4c0" class="outline-2">
<h2 id="orgfd8c4c0"><span class="section-number-2">23.</span> <code>(macroexpand-1 x)</code></h2>
<div class="outline-text-2" id="text-23">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #569cd6;">pub</span> <span style="color: #569cd6;">fn</span> <span style="color: #dcdcaa;">maj_macroexpand_1</span>(<span style="color: #569cd6;">mut</span> <span style="color: #9cdcfe;">state</span>: <span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> <span style="color: #4ec9b0;">MajState</span>,
                         <span style="color: #9cdcfe;">expr</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;,
                         <span style="color: #9cdcfe;">env</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;) -&gt; (<span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;, <span style="color: #4ec9b0;">bool</span>) {
    <span style="color: #569cd6;">use</span> <span style="color: #569cd6;">crate</span>::<span style="color: #569cd6;">evaluator</span>::<span style="color: #569cd6;">application</span>::expand_macro;

    <span style="color: #569cd6;">if</span> !maj_consp(expr.clone()).to_bool() {
        <span style="color: #569cd6;">return</span> (expr, <span style="color: #569cd6;">true</span>);
    }

    <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">mac</span> = maj_car(expr.clone());
    <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">args</span> = maj_cdr(expr.clone());

    <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">mac</span> = state.lookup(env.clone(), mac);
    expand_macro(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, mac, args, env)
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org5284f8a" class="outline-2">
<h2 id="org5284f8a"><span class="section-number-2">24.</span> <span class="todo TODO">TODO</span> <code>(macroexpand x)</code></h2>
</div>

<div id="outline-container-orgaea254e" class="outline-2">
<h2 id="orgaea254e"><span class="section-number-2">25.</span> <code>(not x)</code></h2>
<div class="outline-text-2" id="text-25">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #c586c0;">#[inline]</span>
<span style="color: #569cd6;">pub</span> <span style="color: #569cd6;">fn</span> <span style="color: #dcdcaa;">maj_not</span>(<span style="color: #9cdcfe;">x</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;) -&gt; <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt; {
    maj_nilp(x)
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgd382459" class="outline-2">
<h2 id="orgd382459"><span class="section-number-2">26.</span> <code>(gensym)</code></h2>
<div class="outline-text-2" id="text-26">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #c586c0;">#[inline]</span>
<span style="color: #569cd6;">pub</span> <span style="color: #569cd6;">fn</span> <span style="color: #dcdcaa;">maj_gensym</span>(<span style="color: #569cd6;">mut</span> <span style="color: #9cdcfe;">state</span>: <span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> <span style="color: #4ec9b0;">MajState</span>) -&gt; <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt; {
    <span style="color: #4ec9b0;">Maj</span>::gensym(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state)
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org0e58517" class="outline-2">
<h2 id="org0e58517"><span class="section-number-2">27.</span> Funções numéricas</h2>
<div class="outline-text-2" id="text-27">
</div>
<div id="outline-container-org926f802" class="outline-3">
<h3 id="org926f802"><span class="section-number-3">27.1.</span> <code>(number-coerce x subtype)</code></h3>
<div class="outline-text-3" id="text-27-1">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #569cd6;">pub</span> <span style="color: #569cd6;">fn</span> <span style="color: #dcdcaa;">maj_number_coerce</span>(
    <span style="color: #569cd6;">mut</span> <span style="color: #9cdcfe;">state</span>: <span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> <span style="color: #4ec9b0;">MajState</span>,
    <span style="color: #9cdcfe;">subtype</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;,
    <span style="color: #9cdcfe;">number</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;
) -&gt; <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt; {
    <span style="color: #569cd6;">use</span> <span style="color: #569cd6;">crate</span>::<span style="color: #569cd6;">printing</span>::maj_format;
    <span style="color: #569cd6;">use</span> <span style="color: #569cd6;">crate</span>::<span style="color: #569cd6;">axioms</span>::<span style="color: #569cd6;">predicates</span>::maj_symbolp;

    <span style="color: #569cd6;">if</span> !maj_numberp(number.clone()).to_bool() {
        <span style="color: #569cd6;">return</span> maj_err(<span style="color: #4ec9b0;">Maj</span>::string(<span style="color: #ce9178;">"{} is not a number"</span>),
                       <span style="color: #c586c0;">maj_list!</span>(number));
    }

    <span style="color: #569cd6;">if</span> !maj_symbolp(subtype.clone()).to_bool() {
        <span style="color: #569cd6;">return</span> maj_err(<span style="color: #4ec9b0;">Maj</span>::string(<span style="color: #ce9178;">"{} is not a symbol"</span>),
                       <span style="color: #c586c0;">maj_list!</span>(subtype));
    }


    <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">number_type</span> = maj_type(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, number.clone());
    <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">number_type</span> = number_type.to_raw_sym().unwrap();
    <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">number_type</span> = <span style="color: #4ec9b0;">FromPrimitive</span>::from_u64(number_type)
        .unwrap();

    <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">coerce_type</span> = subtype.to_raw_sym().unwrap();
    <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">coerce_type</span> = <span style="color: #4ec9b0;">FromPrimitive</span>::from_u64(coerce_type);

    <span style="color: #569cd6;">match</span> number_type {
        <span style="color: #4ec9b0;">MajRawSym</span>::<span style="color: #4ec9b0;">Integer</span> =&gt; <span style="color: #569cd6;">match</span> coerce_type {
            <span style="color: #4ec9b0;">Some</span>(<span style="color: #4ec9b0;">MajRawSym</span>::<span style="color: #4ec9b0;">Integer</span>) =&gt; number,
            <span style="color: #4ec9b0;">Some</span>(<span style="color: #4ec9b0;">MajRawSym</span>::<span style="color: #4ec9b0;">Float</span>) =&gt; {
                <span style="color: #4ec9b0;">Maj</span>::float(number.to_forced_float().unwrap())
            },
            <span style="color: #4ec9b0;">Some</span>(<span style="color: #4ec9b0;">MajRawSym</span>::<span style="color: #4ec9b0;">Fraction</span>) =&gt; {
                <span style="color: #4ec9b0;">Maj</span>::fraction(number.to_integer().unwrap(), 1)
            },
            <span style="color: #4ec9b0;">Some</span>(<span style="color: #4ec9b0;">MajRawSym</span>::<span style="color: #4ec9b0;">Complex</span>) =&gt; {
                <span style="color: #4ec9b0;">Maj</span>::complex(number.clone(), <span style="color: #4ec9b0;">Maj</span>::float(0.0))
            },
            _ =&gt; maj_err(
                <span style="color: #4ec9b0;">Maj</span>::string(<span style="color: #ce9178;">"{} is not a number subtype"</span>),
                <span style="color: #c586c0;">maj_list!</span>(subtype)),
        },
        <span style="color: #4ec9b0;">MajRawSym</span>::<span style="color: #4ec9b0;">Float</span> =&gt; <span style="color: #569cd6;">match</span> coerce_type {
            <span style="color: #4ec9b0;">Some</span>(<span style="color: #4ec9b0;">MajRawSym</span>::<span style="color: #4ec9b0;">Integer</span>) =&gt; {
                <span style="color: #4ec9b0;">Maj</span>::integer(number
                             .to_float()
                             .unwrap()
                             .trunc()
                             <span style="color: #569cd6;">as</span> <span style="color: #4ec9b0;">i64</span>)
            },
            <span style="color: #4ec9b0;">Some</span>(<span style="color: #4ec9b0;">MajRawSym</span>::<span style="color: #4ec9b0;">Float</span>) =&gt; number,
            <span style="color: #4ec9b0;">Some</span>(<span style="color: #4ec9b0;">MajRawSym</span>::<span style="color: #4ec9b0;">Fraction</span>) =&gt; {
                <span style="color: #569cd6;">let</span> <span style="color: #569cd6;">mut</span> <span style="color: #9cdcfe;">buffer</span> = maj_format(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span>state, number);
                <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">dot_index</span> = buffer.find(<span style="color: #ce9178;">'.'</span>).unwrap();
                <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">denom_pow</span> = (buffer.len() - dot_index - 1) <span style="color: #569cd6;">as</span> <span style="color: #4ec9b0;">u32</span>;
                <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">denom</span> = 10_<span style="color: #4ec9b0;">i64</span>.pow(denom_pow);
                buffer.remove(dot_index);
                <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">frac</span> =
                    <span style="color: #4ec9b0;">Maj</span>::fraction(buffer.parse().unwrap(), denom);
                simplify_frac(frac).unwrap()
            },
            <span style="color: #4ec9b0;">Some</span>(<span style="color: #4ec9b0;">MajRawSym</span>::<span style="color: #4ec9b0;">Complex</span>) =&gt; {
                <span style="color: #4ec9b0;">Maj</span>::complex(number.clone(), <span style="color: #4ec9b0;">Maj</span>::float(0.0))
            },
            _ =&gt; maj_err(
                <span style="color: #4ec9b0;">Maj</span>::string(<span style="color: #ce9178;">"{} is not a number subtype"</span>),
                <span style="color: #c586c0;">maj_list!</span>(subtype)),
        },
        <span style="color: #4ec9b0;">MajRawSym</span>::<span style="color: #4ec9b0;">Fraction</span> =&gt; <span style="color: #569cd6;">match</span> coerce_type {
            <span style="color: #4ec9b0;">Some</span>(<span style="color: #4ec9b0;">MajRawSym</span>::<span style="color: #4ec9b0;">Integer</span>) =&gt; {
                <span style="color: #4ec9b0;">Maj</span>::integer(number.to_forced_float()
                             .unwrap()
                             .trunc()
                             <span style="color: #569cd6;">as</span> <span style="color: #4ec9b0;">i64</span>)
            },
            <span style="color: #4ec9b0;">Some</span>(<span style="color: #4ec9b0;">MajRawSym</span>::<span style="color: #4ec9b0;">Float</span>) =&gt; {
                <span style="color: #4ec9b0;">Maj</span>::float(number.to_forced_float()
                           .unwrap())
            },
            <span style="color: #4ec9b0;">Some</span>(<span style="color: #4ec9b0;">MajRawSym</span>::<span style="color: #4ec9b0;">Fraction</span>) =&gt; number,
            <span style="color: #4ec9b0;">Some</span>(<span style="color: #4ec9b0;">MajRawSym</span>::<span style="color: #4ec9b0;">Complex</span>) =&gt; {
                <span style="color: #4ec9b0;">Maj</span>::complex(number.clone(), <span style="color: #4ec9b0;">Maj</span>::float(0.0))
            },
            _ =&gt; maj_err(
                <span style="color: #4ec9b0;">Maj</span>::string(<span style="color: #ce9178;">"{} is not a number subtype"</span>),
                <span style="color: #c586c0;">maj_list!</span>(subtype)),
        },
        <span style="color: #4ec9b0;">MajRawSym</span>::<span style="color: #4ec9b0;">Complex</span> =&gt; <span style="color: #569cd6;">match</span> coerce_type {
            <span style="color: #4ec9b0;">Some</span>(<span style="color: #4ec9b0;">MajRawSym</span>::<span style="color: #4ec9b0;">Integer</span>) |
            <span style="color: #4ec9b0;">Some</span>(<span style="color: #4ec9b0;">MajRawSym</span>::<span style="color: #4ec9b0;">Float</span>)   |
            <span style="color: #4ec9b0;">Some</span>(<span style="color: #4ec9b0;">MajRawSym</span>::<span style="color: #4ec9b0;">Fraction</span>) =&gt; {
                <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">realpart</span> = maj_real_part(number);
                maj_number_coerce(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, subtype, realpart)
            },
            <span style="color: #4ec9b0;">Some</span>(<span style="color: #4ec9b0;">MajRawSym</span>::<span style="color: #4ec9b0;">Complex</span>) =&gt; number,
            _ =&gt; maj_err(
                <span style="color: #4ec9b0;">Maj</span>::string(<span style="color: #ce9178;">"{} is not a number subtype"</span>),
                <span style="color: #c586c0;">maj_list!</span>(subtype)),
        },
        _ =&gt; <span style="color: #c586c0;">panic!</span>(<span style="color: #ce9178;">"Symbol is not a number subtype"</span>),
    }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org21a5e79" class="outline-3">
<h3 id="org21a5e79"><span class="section-number-3">27.2.</span> <code>(real-part x)</code></h3>
<div class="outline-text-3" id="text-27-2">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #569cd6;">pub</span> <span style="color: #569cd6;">fn</span> <span style="color: #dcdcaa;">maj_real_part</span>(<span style="color: #9cdcfe;">x</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;) -&gt; <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt; {
    <span style="color: #569cd6;">use</span> <span style="color: #569cd6;">crate</span>::<span style="color: #569cd6;">core</span>::<span style="color: #569cd6;">types</span>::<span style="color: #4ec9b0;">MajNumber</span>;
    <span style="color: #569cd6;">match</span> <span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span>*x.clone() {
        <span style="color: #4ec9b0;">Maj</span>::<span style="color: #4ec9b0;">Number</span>(num) =&gt; {
            <span style="color: #569cd6;">match</span> <span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span>num.clone() {
                <span style="color: #4ec9b0;">MajNumber</span>::<span style="color: #4ec9b0;">Complex</span> {
                    real,
                    <span style="color: #9cdcfe;">imag</span>: _
                } =&gt; {
                    <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">real</span> = <span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span>*real.clone();
                    <span style="color: #4ec9b0;">Gc</span>::new(<span style="color: #4ec9b0;">Maj</span>::<span style="color: #4ec9b0;">Number</span>(real.clone()))
                },
                _ =&gt; maj_err(<span style="color: #4ec9b0;">Maj</span>::string(
                    <span style="color: #ce9178;">"{} is not a complex number"</span>),
                    <span style="color: #c586c0;">maj_list!</span>(x)),
            }
        },
        _ =&gt; maj_err(<span style="color: #4ec9b0;">Maj</span>::string(<span style="color: #ce9178;">"{} is not a number"</span>),
                     <span style="color: #c586c0;">maj_list!</span>(x)),
    }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org03ed51b" class="outline-3">
<h3 id="org03ed51b"><span class="section-number-3">27.3.</span> <code>(imag-part x)</code></h3>
<div class="outline-text-3" id="text-27-3">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #569cd6;">pub</span> <span style="color: #569cd6;">fn</span> <span style="color: #dcdcaa;">maj_imag_part</span>(<span style="color: #9cdcfe;">x</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;) -&gt; <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt; {
    <span style="color: #569cd6;">use</span> <span style="color: #569cd6;">crate</span>::<span style="color: #569cd6;">core</span>::<span style="color: #569cd6;">types</span>::<span style="color: #4ec9b0;">MajNumber</span>;
    <span style="color: #569cd6;">match</span> <span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span>*x.clone() {
        <span style="color: #4ec9b0;">Maj</span>::<span style="color: #4ec9b0;">Number</span>(num) =&gt; {
            <span style="color: #569cd6;">match</span> <span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span>num.clone() {
                <span style="color: #4ec9b0;">MajNumber</span>::<span style="color: #4ec9b0;">Complex</span> {
                    <span style="color: #9cdcfe;">real</span>: _,
                    imag
                } =&gt; {
                    <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">imag</span> = <span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span>*imag.clone();
                    <span style="color: #4ec9b0;">Gc</span>::new(<span style="color: #4ec9b0;">Maj</span>::<span style="color: #4ec9b0;">Number</span>(imag.clone()))
                },
                _ =&gt; maj_err(<span style="color: #4ec9b0;">Maj</span>::string(
                    <span style="color: #ce9178;">"{} is not a complex number"</span>),
                    <span style="color: #c586c0;">maj_list!</span>(x)),
            }
        },
        _ =&gt; maj_err(<span style="color: #4ec9b0;">Maj</span>::string(<span style="color: #ce9178;">"{} is not a number"</span>),
                     <span style="color: #c586c0;">maj_list!</span>(x)),
    }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org33aab02" class="outline-3">
<h3 id="org33aab02"><span class="section-number-3">27.4.</span> <code>(numer x)</code></h3>
<div class="outline-text-3" id="text-27-4">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #569cd6;">pub</span> <span style="color: #569cd6;">fn</span> <span style="color: #dcdcaa;">maj_numer</span>(<span style="color: #9cdcfe;">x</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;) -&gt; <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt; {
    <span style="color: #569cd6;">if</span> !maj_numberp(x.clone()).to_bool() {
        maj_err(<span style="color: #4ec9b0;">Maj</span>::string(<span style="color: #ce9178;">"{} is not a number"</span>),
                <span style="color: #c586c0;">maj_list!</span>(x))
    } <span style="color: #569cd6;">else</span> {
        <span style="color: #569cd6;">match</span> x.clone().to_fraction() {
            <span style="color: #4ec9b0;">Some</span>((numer, _)) =&gt; <span style="color: #4ec9b0;">Maj</span>::integer(numer),
            <span style="color: #4ec9b0;">None</span> =&gt; maj_err(<span style="color: #4ec9b0;">Maj</span>::string(<span style="color: #ce9178;">"{} is not a fraction"</span>),
                            <span style="color: #c586c0;">maj_list!</span>(x)),
        }
    }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org76eb121" class="outline-3">
<h3 id="org76eb121"><span class="section-number-3">27.5.</span> <code>(denom x)</code></h3>
<div class="outline-text-3" id="text-27-5">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #569cd6;">pub</span> <span style="color: #569cd6;">fn</span> <span style="color: #dcdcaa;">maj_denom</span>(<span style="color: #9cdcfe;">x</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;) -&gt; <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt; {
    <span style="color: #569cd6;">if</span> !maj_numberp(x.clone()).to_bool() {
        maj_err(<span style="color: #4ec9b0;">Maj</span>::string(<span style="color: #ce9178;">"{} is not a number"</span>),
                <span style="color: #c586c0;">maj_list!</span>(x))
    } <span style="color: #569cd6;">else</span> {
        <span style="color: #569cd6;">match</span> x.clone().to_fraction() {
            <span style="color: #4ec9b0;">Some</span>((_, denom)) =&gt; <span style="color: #4ec9b0;">Maj</span>::integer(denom),
            <span style="color: #4ec9b0;">None</span> =&gt; maj_err(<span style="color: #4ec9b0;">Maj</span>::string(<span style="color: #ce9178;">"{} is not a fraction"</span>),
                            <span style="color: #c586c0;">maj_list!</span>(x)),
        }
    }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org317c11b" class="outline-3">
<h3 id="org317c11b"><span class="section-number-3">27.6.</span> <code>(richest-number-type x y)</code></h3>
<div class="outline-text-3" id="text-27-6">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #569cd6;">pub</span> <span style="color: #569cd6;">fn</span> <span style="color: #dcdcaa;">maj_richest_number_type</span>(
    <span style="color: #569cd6;">mut</span> <span style="color: #9cdcfe;">state</span>: <span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> <span style="color: #4ec9b0;">MajState</span>,
    <span style="color: #9cdcfe;">x</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;,
    <span style="color: #9cdcfe;">y</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;
) -&gt; <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt; {
    <span style="color: #569cd6;">if</span> !maj_numberp(x.clone()).to_bool() {
        <span style="color: #569cd6;">return</span> maj_err(<span style="color: #4ec9b0;">Maj</span>::string(<span style="color: #ce9178;">"{} is not a number"</span>),
                       <span style="color: #c586c0;">maj_list!</span>(x));
    }
    <span style="color: #569cd6;">if</span> !maj_numberp(y.clone()).to_bool() {
        <span style="color: #569cd6;">return</span> maj_err(<span style="color: #4ec9b0;">Maj</span>::string(<span style="color: #ce9178;">"{} is not a number"</span>),
                       <span style="color: #c586c0;">maj_list!</span>(y));
    }

    <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">x_type</span> = maj_type(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, x.clone());
    <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">x_type_sym</span> = x_type.to_raw_sym().unwrap();
    <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">x_type_sym</span> = <span style="color: #4ec9b0;">FromPrimitive</span>::from_u64(x_type_sym).unwrap();

    <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">y_type</span> = maj_type(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, y.clone());
    <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">y_type_sym</span> = y_type.to_raw_sym().unwrap();
    <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">y_type_sym</span> = <span style="color: #4ec9b0;">FromPrimitive</span>::from_u64(y_type_sym).unwrap();

    <span style="color: #569cd6;">match</span> x_type_sym {
        <span style="color: #4ec9b0;">MajRawSym</span>::<span style="color: #4ec9b0;">Integer</span> =&gt; {
            <span style="color: #569cd6;">match</span> y_type_sym {
                <span style="color: #4ec9b0;">MajRawSym</span>::<span style="color: #4ec9b0;">Integer</span>  |
                <span style="color: #4ec9b0;">MajRawSym</span>::<span style="color: #4ec9b0;">Float</span>    |
                <span style="color: #4ec9b0;">MajRawSym</span>::<span style="color: #4ec9b0;">Fraction</span> |
                <span style="color: #4ec9b0;">MajRawSym</span>::<span style="color: #4ec9b0;">Complex</span>  =&gt; y_type,
                _ =&gt; <span style="color: #c586c0;">unimplemented!</span>(
                    <span style="color: #ce9178;">"Usage of unknown number subtype"</span>),
            }
        },
        <span style="color: #4ec9b0;">MajRawSym</span>::<span style="color: #4ec9b0;">Float</span> =&gt; {
            <span style="color: #569cd6;">match</span> y_type_sym {
                <span style="color: #4ec9b0;">MajRawSym</span>::<span style="color: #4ec9b0;">Integer</span>  =&gt; x_type,
                <span style="color: #4ec9b0;">MajRawSym</span>::<span style="color: #4ec9b0;">Float</span>    |
                <span style="color: #4ec9b0;">MajRawSym</span>::<span style="color: #4ec9b0;">Fraction</span> |
                <span style="color: #4ec9b0;">MajRawSym</span>::<span style="color: #4ec9b0;">Complex</span>  =&gt; y_type,
                _ =&gt; <span style="color: #c586c0;">unimplemented!</span>(
                    <span style="color: #ce9178;">"Usage of unknown number subtype"</span>),
            }
        },
        <span style="color: #4ec9b0;">MajRawSym</span>::<span style="color: #4ec9b0;">Fraction</span> =&gt; {
            <span style="color: #569cd6;">match</span> y_type_sym {
                <span style="color: #4ec9b0;">MajRawSym</span>::<span style="color: #4ec9b0;">Integer</span> |
                <span style="color: #4ec9b0;">MajRawSym</span>::<span style="color: #4ec9b0;">Float</span>   |
                <span style="color: #4ec9b0;">MajRawSym</span>::<span style="color: #4ec9b0;">Fraction</span> =&gt; x_type,
                <span style="color: #4ec9b0;">MajRawSym</span>::<span style="color: #4ec9b0;">Complex</span>  =&gt; y_type,
                _ =&gt; <span style="color: #c586c0;">unimplemented!</span>(
                    <span style="color: #ce9178;">"Usage of unknown number subtype"</span>),
            }
        },
        <span style="color: #4ec9b0;">MajRawSym</span>::<span style="color: #4ec9b0;">Complex</span> =&gt; {
            <span style="color: #569cd6;">match</span> y_type_sym {
                <span style="color: #4ec9b0;">MajRawSym</span>::<span style="color: #4ec9b0;">Integer</span>  |
                <span style="color: #4ec9b0;">MajRawSym</span>::<span style="color: #4ec9b0;">Float</span>    |
                <span style="color: #4ec9b0;">MajRawSym</span>::<span style="color: #4ec9b0;">Fraction</span> |
                <span style="color: #4ec9b0;">MajRawSym</span>::<span style="color: #4ec9b0;">Complex</span>  =&gt; x_type,
                _ =&gt; <span style="color: #c586c0;">unimplemented!</span>(
                    <span style="color: #ce9178;">"Usage of unknown number subtype"</span>),
            }
        },
        _ =&gt; <span style="color: #c586c0;">unimplemented!</span>(<span style="color: #ce9178;">"Usage of unknown number subtype"</span>),
    }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgfdc67db" class="outline-3">
<h3 id="orgfdc67db"><span class="section-number-3">27.7.</span> <code>(rich-number-coerce x y)</code></h3>
<div class="outline-text-3" id="text-27-7">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #569cd6;">pub</span> <span style="color: #569cd6;">fn</span> <span style="color: #dcdcaa;">maj_rich_number_coerce</span>(
    <span style="color: #569cd6;">mut</span> <span style="color: #9cdcfe;">state</span>: <span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> <span style="color: #4ec9b0;">MajState</span>,
    <span style="color: #9cdcfe;">x</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;,
    <span style="color: #9cdcfe;">y</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;
) -&gt; <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt; {
    <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">best_type</span> = maj_richest_number_type(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state,
                                            x.clone(),
                                            y.clone());
    <span style="color: #569cd6;">if</span> maj_errorp(best_type.clone()).to_bool() {
        <span style="color: #569cd6;">return</span> best_type;
    }
    <span style="color: #c586c0;">maj_list!</span>(maj_number_coerce(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state,
                                best_type.clone(), x),
              maj_number_coerce(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, best_type, y))
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orga04262f" class="outline-3">
<h3 id="orga04262f"><span class="section-number-3">27.8.</span> <code>(iota n)</code></h3>
<div class="outline-text-3" id="text-27-8">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #c586c0;">#[inline]</span>
<span style="color: #569cd6;">pub</span> <span style="color: #569cd6;">fn</span> <span style="color: #dcdcaa;">maj_iota</span>(<span style="color: #9cdcfe;">n</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;) -&gt; <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt; {
    <span style="color: #569cd6;">use</span> <span style="color: #569cd6;">crate</span>::<span style="color: #569cd6;">axioms</span>::<span style="color: #569cd6;">predicates</span>::maj_integerp;
    <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">common_err</span> = maj_err(
        <span style="color: #4ec9b0;">Maj</span>::string(<span style="color: #ce9178;">"iota expects a positive integer number"</span>),
        <span style="color: #4ec9b0;">Maj</span>::nil());
    <span style="color: #569cd6;">if</span> !maj_integerp(n.clone()).to_bool() {
        common_err
    } <span style="color: #569cd6;">else</span> {
        <span style="color: #569cd6;">let</span> <span style="color: #569cd6;">mut</span> <span style="color: #9cdcfe;">num</span> = n.to_integer().unwrap();
        <span style="color: #569cd6;">if</span> num &lt; 0 {
            common_err
        } <span style="color: #569cd6;">else</span> {
            <span style="color: #569cd6;">let</span> <span style="color: #569cd6;">mut</span> <span style="color: #9cdcfe;">list</span> = <span style="color: #4ec9b0;">Maj</span>::nil();
            <span style="color: #569cd6;">while</span> num &gt; 0 {
                list = <span style="color: #4ec9b0;">Maj</span>::cons(<span style="color: #4ec9b0;">Maj</span>::integer(num - 1), list);
                num -= 1;
            }
            list
        }
    }
}
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgb4b2bd3" class="outline-2">
<h2 id="orgb4b2bd3"><span class="section-number-2">28.</span> <span class="todo TODO">TODO</span> Funções de comparação</h2>
<div class="outline-text-2" id="text-28">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #569cd6;">use</span> <span style="color: #569cd6;">crate</span>::<span style="color: #569cd6;">axioms</span>::<span style="color: #569cd6;">predicates</span>::maj_zerop;
</pre>
</div>
</div>

<div id="outline-container-org67cdc05" class="outline-3">
<h3 id="org67cdc05"><span class="section-number-3">28.1.</span> Funções de ajuda e ferramentas</h3>
<div class="outline-text-3" id="text-28-1">
</div>
<div id="outline-container-org1b77933" class="outline-4">
<h4 id="org1b77933"><span class="section-number-4">28.1.1.</span> Ajudante de coerções aritméticas</h4>
<div class="outline-text-4" id="text-28-1-1">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #569cd6;">fn</span> <span style="color: #dcdcaa;">maj_arithm_coercion_helper</span>(
    <span style="color: #569cd6;">mut</span> <span style="color: #9cdcfe;">state</span>: <span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> <span style="color: #4ec9b0;">MajState</span>,
    <span style="color: #9cdcfe;">x</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;,
    <span style="color: #9cdcfe;">y</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;
) -&gt; <span style="color: #4ec9b0;">Result</span>&lt;(<span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;, <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;, <span style="color: #4ec9b0;">MajRawSym</span>), <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;&gt; {
    <span style="color: #569cd6;">if</span> !maj_numberp(x.clone()).to_bool() {
        <span style="color: #569cd6;">return</span> <span style="color: #4ec9b0;">Err</span>(maj_err(
            <span style="color: #4ec9b0;">Maj</span>::string(<span style="color: #ce9178;">"{} is not a number"</span>),
            <span style="color: #c586c0;">maj_list!</span>(x)));
    }
    <span style="color: #569cd6;">if</span> !maj_numberp(y.clone()).to_bool() {
        <span style="color: #569cd6;">return</span> <span style="color: #4ec9b0;">Err</span>(maj_err(
            <span style="color: #4ec9b0;">Maj</span>::string(<span style="color: #ce9178;">"{} is not a number"</span>),
            <span style="color: #c586c0;">maj_list!</span>(y)));
    }
    <span style="color: #6a9955;">// </span><span style="color: #6a9955;">Perform rich coercion</span>
    <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">coerced</span> = maj_rich_number_coerce(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, x, y);
    <span style="color: #569cd6;">if</span> maj_errorp(coerced.clone()).to_bool() {
        <span style="color: #569cd6;">return</span> <span style="color: #4ec9b0;">Err</span>(coerced);
    }
    <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">x</span> = maj_car(coerced.clone());
    <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">y</span> = maj_car(maj_cdr(coerced));
    <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">ntype</span> = maj_type(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, x.clone());

    <span style="color: #4ec9b0;">Ok</span>((x, y,
        <span style="color: #4ec9b0;">FromPrimitive</span>::from_u64(ntype.to_raw_sym()
                                .unwrap())
        .unwrap()))
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org2be9dc1" class="outline-4">
<h4 id="org2be9dc1"><span class="section-number-4">28.1.2.</span> Tipos de despacho de aritmética</h4>
<div class="outline-text-4" id="text-28-1-2">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #c586c0;">#[derive(Debug)]</span>
<span style="color: #569cd6;">enum</span> <span style="color: #4ec9b0;">MajArithmFnType</span> {
    <span style="color: #4ec9b0;">Equals</span>,
    <span style="color: #4ec9b0;">Greater</span>,
    <span style="color: #4ec9b0;">Lesser</span>,
    <span style="color: #4ec9b0;">Plus</span>,
    <span style="color: #4ec9b0;">Minus</span>,
    <span style="color: #4ec9b0;">Multiply</span>,
    <span style="color: #4ec9b0;">Divide</span>,
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orge7213bc" class="outline-4">
<h4 id="orge7213bc"><span class="section-number-4">28.1.3.</span> Ajudante de despacho de aritmética</h4>
<div class="outline-text-4" id="text-28-1-3">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #569cd6;">fn</span> <span style="color: #dcdcaa;">maj_arithm_dispatch</span>(
    <span style="color: #569cd6;">mut</span> <span style="color: #9cdcfe;">state</span>: <span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> <span style="color: #4ec9b0;">MajState</span>,
    <span style="color: #9cdcfe;">env</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;,
    <span style="color: #9cdcfe;">fntype</span>: <span style="color: #4ec9b0;">MajArithmFnType</span>,
    <span style="color: #9cdcfe;">x</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;,
    <span style="color: #9cdcfe;">y</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;,
    <span style="color: #9cdcfe;">rest</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;,
    <span style="color: #9cdcfe;">accum</span>: <span style="color: #4ec9b0;">bool</span>
) -&gt; <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt; {
    <span style="color: #569cd6;">let</span> <span style="color: #569cd6;">mut</span> <span style="color: #9cdcfe;">origy</span> = y.clone();
    <span style="color: #569cd6;">match</span> maj_arithm_coercion_helper(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, x, y.clone()) {
        <span style="color: #4ec9b0;">Err</span>(e) =&gt; e,
        <span style="color: #4ec9b0;">Ok</span>((x, y, ntype)) =&gt; {
            <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">result</span> =
                <span style="color: #569cd6;">match</span> fntype {
                    <span style="color: #4ec9b0;">MajArithmFnType</span>::<span style="color: #4ec9b0;">Equals</span> =&gt; {
                        maj_arithm_internal_eq(
                            <span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, env.clone(),
                            x, y, ntype)
                    },
                    <span style="color: #4ec9b0;">MajArithmFnType</span>::<span style="color: #4ec9b0;">Greater</span> =&gt; {
                        maj_arithm_internal_gl(
                            x, y, ntype, <span style="color: #569cd6;">true</span>)
                    },
                    <span style="color: #4ec9b0;">MajArithmFnType</span>::<span style="color: #4ec9b0;">Lesser</span> =&gt; {
                        maj_arithm_internal_gl(
                            x, y, ntype, <span style="color: #569cd6;">false</span>)
                    },
                    <span style="color: #4ec9b0;">MajArithmFnType</span>::<span style="color: #4ec9b0;">Plus</span> =&gt; {
                        maj_arithm_internal_sum(
                            <span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, env.clone(),
                            x, y, ntype)
                    },
                    <span style="color: #4ec9b0;">MajArithmFnType</span>::<span style="color: #4ec9b0;">Minus</span> =&gt; {
                        maj_arithm_internal_subtract(
                            <span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, env.clone(),
                            x, y, ntype)
                    },
                    <span style="color: #4ec9b0;">MajArithmFnType</span>::<span style="color: #4ec9b0;">Multiply</span> =&gt; {
                        maj_arithm_internal_multiply(
                            <span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, env.clone(),
                            x, y, ntype)
                    },
                    <span style="color: #4ec9b0;">MajArithmFnType</span>::<span style="color: #4ec9b0;">Divide</span> =&gt; {
                        maj_arithm_internal_divide(
                            <span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, env.clone(),
                            x, y, ntype)
                    },
                };

            <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">result</span> = <span style="color: #569cd6;">match</span> result {
                <span style="color: #4ec9b0;">Ok</span>(b) =&gt; b,
                <span style="color: #4ec9b0;">Err</span>(e) =&gt; <span style="color: #569cd6;">return</span> e,
            };

            <span style="color: #569cd6;">if</span> accum {
                origy = result.clone();
            }

            <span style="color: #569cd6;">if</span> !maj_nilp(rest.clone()).to_bool() {
                maj_arithm_dispatch(
                    <span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, env,
                    fntype,
                    origy,
                    maj_car(rest.clone()),
                    maj_cdr(rest),
                    accum)
            } <span style="color: #569cd6;">else</span> {
                result
            }
        }
    }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org0de633e" class="outline-4">
<h4 id="org0de633e"><span class="section-number-4">28.1.4.</span> Comparação por igualdade</h4>
<div class="outline-text-4" id="text-28-1-4">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #569cd6;">fn</span> <span style="color: #dcdcaa;">maj_arithm_internal_eq</span>(
    <span style="color: #569cd6;">mut</span> <span style="color: #9cdcfe;">state</span>: <span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> <span style="color: #4ec9b0;">MajState</span>,
    <span style="color: #9cdcfe;">env</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;,
    <span style="color: #9cdcfe;">x</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;,
    <span style="color: #9cdcfe;">y</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;,
    <span style="color: #9cdcfe;">ntype</span>: <span style="color: #4ec9b0;">MajRawSym</span>
) -&gt; <span style="color: #4ec9b0;">Result</span>&lt;<span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;, <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;&gt; {
    <span style="color: #569cd6;">match</span> ntype {
        <span style="color: #4ec9b0;">MajRawSym</span>::<span style="color: #4ec9b0;">Integer</span> =&gt; {
            <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">x</span> = x.to_integer().unwrap();
            <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">y</span> = y.to_integer().unwrap();
            <span style="color: #4ec9b0;">Ok</span>(<span style="color: #569cd6;">if</span> x == y { <span style="color: #4ec9b0;">Maj</span>::t() } <span style="color: #569cd6;">else</span> { <span style="color: #4ec9b0;">Maj</span>::nil() })
        },
        <span style="color: #4ec9b0;">MajRawSym</span>::<span style="color: #4ec9b0;">Fraction</span> =&gt; {
            <span style="color: #569cd6;">let</span> (n1, d1) = x.to_fraction().unwrap();
            <span style="color: #569cd6;">let</span> (n2, d2) = y.to_fraction().unwrap();
            <span style="color: #4ec9b0;">Ok</span>(<span style="color: #569cd6;">if</span> (n1 == n2) &amp;&amp; (d1 == d2) {
                <span style="color: #4ec9b0;">Maj</span>::t()
            } <span style="color: #569cd6;">else</span> {
                <span style="color: #4ec9b0;">Maj</span>::nil()
            })
        },
        <span style="color: #4ec9b0;">MajRawSym</span>::<span style="color: #4ec9b0;">Complex</span> =&gt; {
            <span style="color: #6a9955;">// </span><span style="color: #6a9955;">Compara&#231;&#227;o recursiva.</span>
            <span style="color: #6a9955;">// </span><span style="color: #6a9955;">Ah... eu posso realmente comparar esses</span>
            <span style="color: #6a9955;">// </span><span style="color: #6a9955;">n&#250;meros dessa forma?</span>
            <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">r1</span> = maj_real_part(x.clone());
            <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">i1</span> = maj_imag_part(x);
            <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">r2</span> = maj_real_part(y.clone());
            <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">i2</span> = maj_imag_part(y);
            <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">res</span> =
                maj_arithm_eq(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, env.clone(),
                              r1, r2,
                              <span style="color: #4ec9b0;">Maj</span>::nil()).to_bool() &amp;&amp;
                maj_arithm_eq(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, env.clone(),
                              i1, i2,
                              <span style="color: #4ec9b0;">Maj</span>::nil()).to_bool();
            <span style="color: #4ec9b0;">Ok</span>(<span style="color: #569cd6;">if</span> res { <span style="color: #4ec9b0;">Maj</span>::t() } <span style="color: #569cd6;">else</span> { <span style="color: #4ec9b0;">Maj</span>::nil() })
        },
        <span style="color: #4ec9b0;">MajRawSym</span>::<span style="color: #4ec9b0;">Float</span> =&gt; {
            <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">fres</span> =
                maj_arithm_floateq(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, env.clone(),
                                   x, y);
            <span style="color: #569cd6;">if</span> maj_errorp(fres.clone()).to_bool() {
                <span style="color: #569cd6;">return</span> <span style="color: #4ec9b0;">Err</span>(fres);
            }
            <span style="color: #4ec9b0;">Ok</span>(fres)
        },
        t =&gt; <span style="color: #c586c0;">panic!</span>(<span style="color: #ce9178;">"{:?} is not a number subtype"</span>, t),
    }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org8bfc5c1" class="outline-4">
<h4 id="org8bfc5c1"><span class="section-number-4">28.1.5.</span> Comparação de maior que / menor que</h4>
<div class="outline-text-4" id="text-28-1-5">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #569cd6;">fn</span> <span style="color: #dcdcaa;">maj_arithm_internal_gl</span>(
    <span style="color: #9cdcfe;">x</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;,
    <span style="color: #9cdcfe;">y</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;,
    <span style="color: #9cdcfe;">ntype</span>: <span style="color: #4ec9b0;">MajRawSym</span>,
    <span style="color: #9cdcfe;">is_greater</span>: <span style="color: #4ec9b0;">bool</span>
) -&gt; <span style="color: #4ec9b0;">Result</span>&lt;<span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;, <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;&gt; {
    <span style="color: #569cd6;">match</span> ntype {
        <span style="color: #4ec9b0;">MajRawSym</span>::<span style="color: #4ec9b0;">Integer</span> =&gt; {
            <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">x</span> = x.to_integer().unwrap();
            <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">y</span> = y.to_integer().unwrap();
            <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">res</span> = <span style="color: #569cd6;">if</span> is_greater {
                x &gt; y
            } <span style="color: #569cd6;">else</span> {
                x &lt; y
            };
            <span style="color: #4ec9b0;">Ok</span>(<span style="color: #569cd6;">if</span> res { <span style="color: #4ec9b0;">Maj</span>::t() } <span style="color: #569cd6;">else</span> { <span style="color: #4ec9b0;">Maj</span>::nil() })
        },
        <span style="color: #4ec9b0;">MajRawSym</span>::<span style="color: #4ec9b0;">Float</span> =&gt; {
            <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">x</span> = x.to_float().unwrap();
            <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">y</span> = y.to_float().unwrap();
            <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">res</span> = <span style="color: #569cd6;">if</span> is_greater {
                x &gt; y
            } <span style="color: #569cd6;">else</span> {
                x &lt; y
            };
            <span style="color: #4ec9b0;">Ok</span>(<span style="color: #569cd6;">if</span> res { <span style="color: #4ec9b0;">Maj</span>::t() } <span style="color: #569cd6;">else</span> { <span style="color: #4ec9b0;">Maj</span>::nil() })
        },
        <span style="color: #4ec9b0;">MajRawSym</span>::<span style="color: #4ec9b0;">Fraction</span> =&gt; {
            <span style="color: #6a9955;">// </span><span style="color: #6a9955;">Use common denominator test</span>
            <span style="color: #569cd6;">let</span> (n1, d1) = x.to_fraction().unwrap();
            <span style="color: #569cd6;">let</span> (n2, d2) = y.to_fraction().unwrap();
            <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">res</span> = <span style="color: #569cd6;">if</span> is_greater {
                (n1 * d2) &gt; (n2 * d1)
            } <span style="color: #569cd6;">else</span> {
                (n1 * d2) &lt; (n2 * d1)
            };
            <span style="color: #4ec9b0;">Ok</span>(<span style="color: #569cd6;">if</span> res { <span style="color: #4ec9b0;">Maj</span>::t() } <span style="color: #569cd6;">else</span> { <span style="color: #4ec9b0;">Maj</span>::nil() })
        },
        <span style="color: #4ec9b0;">MajRawSym</span>::<span style="color: #4ec9b0;">Complex</span> =&gt;
            <span style="color: #4ec9b0;">Err</span>(maj_err(<span style="color: #4ec9b0;">Maj</span>::string(
                <span style="color: #ce9178;">"The set of complex numbers can't be an ordered field"</span>),
                        <span style="color: #4ec9b0;">Maj</span>::nil())),
        t =&gt; <span style="color: #c586c0;">panic!</span>(<span style="color: #ce9178;">"{:?} is not a number subtype"</span>, t),
    }
}
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org0244a0a" class="outline-3">
<h3 id="org0244a0a"><span class="section-number-3">28.2.</span> <code>(= x y . rest)</code></h3>
<div class="outline-text-3" id="text-28-2">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #569cd6;">pub</span> <span style="color: #569cd6;">fn</span> <span style="color: #dcdcaa;">maj_arithm_eq</span>(
    <span style="color: #569cd6;">mut</span> <span style="color: #9cdcfe;">state</span>: <span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> <span style="color: #4ec9b0;">MajState</span>,
    <span style="color: #9cdcfe;">env</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;,
    <span style="color: #9cdcfe;">x</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;,
    <span style="color: #9cdcfe;">y</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;,
    <span style="color: #9cdcfe;">rest</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;
) -&gt; <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt; {
    maj_arithm_dispatch(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, env,
                        <span style="color: #4ec9b0;">MajArithmFnType</span>::<span style="color: #4ec9b0;">Equals</span>,
                        x, y, rest, <span style="color: #569cd6;">false</span>)
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org60804c5" class="outline-3">
<h3 id="org60804c5"><span class="section-number-3">28.3.</span> <code>(float= x y)</code></h3>
<div class="outline-text-3" id="text-28-3">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #569cd6;">pub</span> <span style="color: #569cd6;">fn</span> <span style="color: #dcdcaa;">maj_arithm_floateq</span>(
    <span style="color: #569cd6;">mut</span> <span style="color: #9cdcfe;">state</span>: <span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> <span style="color: #4ec9b0;">MajState</span>,
    <span style="color: #9cdcfe;">env</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;,
    <span style="color: #9cdcfe;">x</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;,
    <span style="color: #9cdcfe;">y</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;
) -&gt; <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt; {
    <span style="color: #569cd6;">use</span> <span style="color: #569cd6;">crate</span>::<span style="color: #569cd6;">axioms</span>::<span style="color: #569cd6;">predicates</span>::maj_floatp;
    <span style="color: #569cd6;">use</span> <span style="color: #569cd6;">core</span>::<span style="color: #4ec9b0;">f64</span>;
    <span style="color: #569cd6;">use</span> <span style="color: #569cd6;">float_cmp</span>::approx_eq;
    <span style="color: #569cd6;">if</span> !maj_floatp(x.clone()).to_bool() {
        <span style="color: #569cd6;">return</span> maj_err(<span style="color: #4ec9b0;">Maj</span>::string(<span style="color: #ce9178;">"{} is not a float number"</span>),
                       <span style="color: #c586c0;">maj_list!</span>(x));
    } <span style="color: #569cd6;">else</span> <span style="color: #569cd6;">if</span> !maj_floatp(y.clone()).to_bool() {
        <span style="color: #569cd6;">return</span> maj_err(<span style="color: #4ec9b0;">Maj</span>::string(<span style="color: #ce9178;">"{} is not a float number"</span>),
                       <span style="color: #c586c0;">maj_list!</span>(y));
    }

    <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">ulps</span> = <span style="color: #4ec9b0;">Maj</span>::symbol(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, <span style="color: #ce9178;">"*ulps*"</span>);
    <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">ulps</span> = state.lookup(env, ulps);
    <span style="color: #569cd6;">if</span> maj_errorp(ulps.clone()).to_bool() {
        <span style="color: #569cd6;">return</span> ulps;
    }
    <span style="color: #569cd6;">if</span> <span style="color: #569cd6;">let</span> <span style="color: #4ec9b0;">Some</span>(u) = ulps.to_integer() {
        <span style="color: #569cd6;">if</span> u &lt; 0 {
            maj_err(
                <span style="color: #4ec9b0;">Maj</span>::string(<span style="color: #ce9178;">"*ulps* cannot be smaller than 0"</span>),
                <span style="color: #4ec9b0;">Maj</span>::nil())
        } <span style="color: #569cd6;">else</span> {
            <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">x</span> = x.to_float().unwrap();
            <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">y</span> = y.to_float().unwrap();
            <span style="color: #569cd6;">if</span> <span style="color: #c586c0;">approx_eq!</span>(<span style="color: #4ec9b0;">f64</span>, x, y, ulps = u) {
                <span style="color: #4ec9b0;">Maj</span>::t()
            } <span style="color: #569cd6;">else</span> {
                <span style="color: #4ec9b0;">Maj</span>::nil()
            }
        }
    } <span style="color: #569cd6;">else</span> {
        maj_err(<span style="color: #4ec9b0;">Maj</span>::string(<span style="color: #ce9178;">"*ulps* is not an integer"</span>),
                <span style="color: #4ec9b0;">Maj</span>::nil())
    }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org14e3a1c" class="outline-3">
<h3 id="org14e3a1c"><span class="section-number-3">28.4.</span> <code>(&gt; x y . rest)</code></h3>
<div class="outline-text-3" id="text-28-4">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #569cd6;">pub</span> <span style="color: #569cd6;">fn</span> <span style="color: #dcdcaa;">maj_arithm_greater</span>(
    <span style="color: #569cd6;">mut</span> <span style="color: #9cdcfe;">state</span>: <span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> <span style="color: #4ec9b0;">MajState</span>,
    <span style="color: #9cdcfe;">x</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;,
    <span style="color: #9cdcfe;">y</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;,
    <span style="color: #9cdcfe;">rest</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;
) -&gt; <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt; {
    maj_arithm_dispatch(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, <span style="color: #4ec9b0;">Maj</span>::nil(),
                        <span style="color: #4ec9b0;">MajArithmFnType</span>::<span style="color: #4ec9b0;">Greater</span>,
                        x, y, rest, <span style="color: #569cd6;">false</span>)
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org2124622" class="outline-3">
<h3 id="org2124622"><span class="section-number-3">28.5.</span> <code>(&lt; x y . rest)</code></h3>
<div class="outline-text-3" id="text-28-5">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #569cd6;">pub</span> <span style="color: #569cd6;">fn</span> <span style="color: #dcdcaa;">maj_arithm_lesser</span>(
    <span style="color: #569cd6;">mut</span> <span style="color: #9cdcfe;">state</span>: <span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> <span style="color: #4ec9b0;">MajState</span>,
    <span style="color: #9cdcfe;">x</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;,
    <span style="color: #9cdcfe;">y</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;,
    <span style="color: #9cdcfe;">rest</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;
) -&gt; <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt; {
    maj_arithm_dispatch(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, <span style="color: #4ec9b0;">Maj</span>::nil(),
                        <span style="color: #4ec9b0;">MajArithmFnType</span>::<span style="color: #4ec9b0;">Lesser</span>,
                        x, y, rest, <span style="color: #569cd6;">false</span>)
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orge793585" class="outline-3">
<h3 id="orge793585"><span class="section-number-3">28.6.</span> <code>(&gt;= x y . rest)</code></h3>
<div class="outline-text-3" id="text-28-6">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #569cd6;">pub</span> <span style="color: #569cd6;">fn</span> <span style="color: #dcdcaa;">maj_arithm_geq</span>(
    <span style="color: #569cd6;">mut</span> <span style="color: #9cdcfe;">state</span>: <span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> <span style="color: #4ec9b0;">MajState</span>,
    <span style="color: #9cdcfe;">env</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;,
    <span style="color: #9cdcfe;">x</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;,
    <span style="color: #9cdcfe;">y</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;,
    <span style="color: #9cdcfe;">rest</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;
) -&gt; <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt; {
    <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">result</span> = maj_arithm_greater(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state,
                                    x.clone(), y.clone(),
                                    rest.clone());
    <span style="color: #569cd6;">if</span> maj_errorp(result.clone()).to_bool() {
        result
    } <span style="color: #569cd6;">else</span> <span style="color: #569cd6;">if</span> result.to_bool() {
        <span style="color: #4ec9b0;">Maj</span>::t()
    } <span style="color: #569cd6;">else</span> {
        maj_arithm_eq(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, env, x, y, rest)
    }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orge837e09" class="outline-3">
<h3 id="orge837e09"><span class="section-number-3">28.7.</span> <code>(&lt;= x y . rest)</code></h3>
<div class="outline-text-3" id="text-28-7">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #569cd6;">pub</span> <span style="color: #569cd6;">fn</span> <span style="color: #dcdcaa;">maj_arithm_leq</span>(
    <span style="color: #569cd6;">mut</span> <span style="color: #9cdcfe;">state</span>: <span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> <span style="color: #4ec9b0;">MajState</span>,
    <span style="color: #9cdcfe;">env</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;,
    <span style="color: #9cdcfe;">x</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;,
    <span style="color: #9cdcfe;">y</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;,
    <span style="color: #9cdcfe;">rest</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;
) -&gt; <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt; {
    <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">result</span> = maj_arithm_lesser(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state,
                                   x.clone(), y.clone(),
                                   rest.clone());
    <span style="color: #569cd6;">if</span> maj_errorp(result.clone()).to_bool() {
        result
    } <span style="color: #569cd6;">else</span> <span style="color: #569cd6;">if</span> result.to_bool() {
        <span style="color: #4ec9b0;">Maj</span>::t()
    } <span style="color: #569cd6;">else</span> {
        maj_arithm_eq(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, env, x, y, rest)
    }
}
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgb3cb4f9" class="outline-2">
<h2 id="orgb3cb4f9"><span class="section-number-2">29.</span> Funções aritméticas</h2>
<div class="outline-text-2" id="text-29">
</div>
<div id="outline-container-org2efa026" class="outline-3">
<h3 id="org2efa026"><span class="section-number-3">29.1.</span> Funções de ajuda e ferramentas</h3>
<div class="outline-text-3" id="text-29-1">
</div>
<div id="outline-container-org82e3635" class="outline-4">
<h4 id="org82e3635"><span class="section-number-4">29.1.1.</span> Ajudante de soma</h4>
<div class="outline-text-4" id="text-29-1-1">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #569cd6;">fn</span> <span style="color: #dcdcaa;">maj_arithm_internal_sum</span>(
    <span style="color: #569cd6;">mut</span> <span style="color: #9cdcfe;">state</span>: <span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> <span style="color: #4ec9b0;">MajState</span>,
    <span style="color: #9cdcfe;">env</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;,
    <span style="color: #9cdcfe;">x</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;,
    <span style="color: #9cdcfe;">y</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;,
    <span style="color: #9cdcfe;">ntype</span>: <span style="color: #4ec9b0;">MajRawSym</span>
) -&gt; <span style="color: #4ec9b0;">Result</span>&lt;<span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;, <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;&gt; {
    <span style="color: #569cd6;">match</span> ntype {
        <span style="color: #4ec9b0;">MajRawSym</span>::<span style="color: #4ec9b0;">Integer</span> =&gt; {
            <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">x</span> = x.to_integer().unwrap();
            <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">y</span> = y.to_integer().unwrap();
            <span style="color: #4ec9b0;">Ok</span>(<span style="color: #4ec9b0;">Maj</span>::integer(x + y))
        },
        <span style="color: #4ec9b0;">MajRawSym</span>::<span style="color: #4ec9b0;">Float</span> =&gt; {
            <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">x</span> = x.to_float().unwrap();
            <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">y</span> = y.to_float().unwrap();
            <span style="color: #4ec9b0;">Ok</span>(<span style="color: #4ec9b0;">Maj</span>::float(x + y))
        },
        <span style="color: #4ec9b0;">MajRawSym</span>::<span style="color: #4ec9b0;">Fraction</span> =&gt; {
            <span style="color: #569cd6;">let</span> (nx, dx) = x.to_fraction().unwrap();
            <span style="color: #569cd6;">let</span> (ny, dy) = y.to_fraction().unwrap();
            <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">dr</span> = dx * dy;
            <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">nr</span> = (nx * dy) + (ny * dx);
            simplify_frac_coerce(<span style="color: #4ec9b0;">Maj</span>::fraction(nr, dr))
        },
        <span style="color: #4ec9b0;">MajRawSym</span>::<span style="color: #4ec9b0;">Complex</span> =&gt; {
            <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">xr</span> = maj_real_part(x.clone());
            <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">xi</span> = maj_imag_part(x);
            <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">yr</span> = maj_real_part(y.clone());
            <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">yi</span> = maj_imag_part(y);
            <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">real</span> = maj_arithm_plus(
                <span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, env.clone(),
                <span style="color: #c586c0;">maj_list!</span>(xr, yr));
            <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">imag</span> = maj_arithm_plus(
                <span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, env, <span style="color: #c586c0;">maj_list!</span>(xi, yi));
            <span style="color: #4ec9b0;">Ok</span>(<span style="color: #4ec9b0;">Maj</span>::complex(real, imag))
        },
        t =&gt; <span style="color: #c586c0;">panic!</span>(<span style="color: #ce9178;">"{:?} is not a number subtype"</span>, t),
    }
}
</pre>
</div>
</div>

<ol class="org-ol">
<li><a id="orgdfd88ee"></a>Ajudante de conjugado<br />
<div class="outline-text-5" id="text-29-1-1-1">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #569cd6;">fn</span> <span style="color: #dcdcaa;">maj_conjugate</span>(
    <span style="color: #569cd6;">mut</span> <span style="color: #9cdcfe;">state</span>: <span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> <span style="color: #4ec9b0;">MajState</span>,
    <span style="color: #9cdcfe;">env</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;,
    <span style="color: #9cdcfe;">x</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;
) -&gt; <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt; {
    <span style="color: #569cd6;">use</span> <span style="color: #569cd6;">crate</span>::<span style="color: #569cd6;">axioms</span>::<span style="color: #569cd6;">predicates</span>::maj_complexp;
    <span style="color: #569cd6;">if</span> !maj_complexp(x.clone()).to_bool() {
        x
    } <span style="color: #569cd6;">else</span> {
        <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">realpart</span> = maj_real_part(x.clone());
        <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">imagpart</span> = maj_imag_part(x);
        <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">imagpart</span> = maj_arithm_times(
            <span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, env,
            <span style="color: #c586c0;">maj_list!</span>(imagpart, <span style="color: #4ec9b0;">Maj</span>::integer(-1)));
        <span style="color: #569cd6;">if</span> maj_errorp(imagpart.clone()).to_bool() {
            imagpart
        } <span style="color: #569cd6;">else</span> {
            <span style="color: #4ec9b0;">Maj</span>::complex(realpart, imagpart)
        }
    }
}
</pre>
</div>
</div>
</li>
</ol>
</div>

<div id="outline-container-org189ca58" class="outline-4">
<h4 id="org189ca58"><span class="section-number-4">29.1.2.</span> Ajudante de subtração</h4>
<div class="outline-text-4" id="text-29-1-2">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #569cd6;">fn</span> <span style="color: #dcdcaa;">maj_arithm_internal_subtract</span>(
    <span style="color: #569cd6;">mut</span> <span style="color: #9cdcfe;">state</span>: <span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> <span style="color: #4ec9b0;">MajState</span>,
    <span style="color: #9cdcfe;">env</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;,
    <span style="color: #9cdcfe;">x</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;,
    <span style="color: #9cdcfe;">y</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;,
    <span style="color: #9cdcfe;">ntype</span>: <span style="color: #4ec9b0;">MajRawSym</span>
) -&gt; <span style="color: #4ec9b0;">Result</span>&lt;<span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;, <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;&gt; {
    <span style="color: #569cd6;">match</span> ntype {
        <span style="color: #4ec9b0;">MajRawSym</span>::<span style="color: #4ec9b0;">Integer</span> =&gt; {
            <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">x</span> = x.to_integer().unwrap();
            <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">y</span> = y.to_integer().unwrap();
            <span style="color: #4ec9b0;">Ok</span>(<span style="color: #4ec9b0;">Maj</span>::integer(x - y))
        },
        <span style="color: #4ec9b0;">MajRawSym</span>::<span style="color: #4ec9b0;">Float</span> =&gt; {
            <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">x</span> = x.to_float().unwrap();
            <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">y</span> = y.to_float().unwrap();
            <span style="color: #4ec9b0;">Ok</span>(<span style="color: #4ec9b0;">Maj</span>::float(x - y))
        },
        <span style="color: #4ec9b0;">MajRawSym</span>::<span style="color: #4ec9b0;">Fraction</span> =&gt; {
            <span style="color: #569cd6;">let</span> (nx, dx) = x.to_fraction().unwrap();
            <span style="color: #569cd6;">let</span> (ny, dy) = y.to_fraction().unwrap();
            <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">dr</span> = dx * dy;
            <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">nr</span> = (nx * dy) - (ny * dx);
            simplify_frac_coerce(<span style="color: #4ec9b0;">Maj</span>::fraction(nr, dr))
        },
        <span style="color: #4ec9b0;">MajRawSym</span>::<span style="color: #4ec9b0;">Complex</span> =&gt; {
            <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">xr</span> = maj_real_part(x.clone());
            <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">xi</span> = maj_imag_part(x);
            <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">yr</span> = maj_real_part(y.clone());
            <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">yi</span> = maj_imag_part(y);
            <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">real</span> = maj_arithm_minus(
                <span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, env.clone(),
                <span style="color: #c586c0;">maj_list!</span>(xr, yr));
            <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">imag</span> = maj_arithm_minus(
                <span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, env, <span style="color: #c586c0;">maj_list!</span>(xi, yi));
            <span style="color: #4ec9b0;">Ok</span>(<span style="color: #4ec9b0;">Maj</span>::complex(real, imag))
        },
        t =&gt; <span style="color: #c586c0;">panic!</span>(<span style="color: #ce9178;">"{:?} is not a number subtype"</span>, t),
    }
}
</pre>
</div>
</div>

<ol class="org-ol">
<li><a id="orge4931c4"></a>Ajudante de negação<br />
<div class="outline-text-5" id="text-29-1-2-1">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #569cd6;">fn</span> <span style="color: #dcdcaa;">maj_negate</span>(
    <span style="color: #569cd6;">mut</span> <span style="color: #9cdcfe;">state</span>: <span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> <span style="color: #4ec9b0;">MajState</span>,
    <span style="color: #9cdcfe;">env</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;,
    <span style="color: #9cdcfe;">x</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;
) -&gt; <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt; {
    maj_arithm_times(
        <span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, env,
        <span style="color: #c586c0;">maj_list!</span>(x, <span style="color: #4ec9b0;">Maj</span>::integer(-1)))
}
</pre>
</div>
</div>
</li>
</ol>
</div>

<div id="outline-container-orgafa0365" class="outline-4">
<h4 id="orgafa0365"><span class="section-number-4">29.1.3.</span> Ajudante de multiplicação</h4>
<div class="outline-text-4" id="text-29-1-3">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #569cd6;">fn</span> <span style="color: #dcdcaa;">maj_arithm_internal_multiply</span>(
    <span style="color: #569cd6;">mut</span> <span style="color: #9cdcfe;">state</span>: <span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> <span style="color: #4ec9b0;">MajState</span>,
    <span style="color: #9cdcfe;">env</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;,
    <span style="color: #9cdcfe;">x</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;,
    <span style="color: #9cdcfe;">y</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;,
    <span style="color: #9cdcfe;">ntype</span>: <span style="color: #4ec9b0;">MajRawSym</span>
) -&gt; <span style="color: #4ec9b0;">Result</span>&lt;<span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;, <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;&gt; {
    <span style="color: #569cd6;">match</span> ntype {
        <span style="color: #4ec9b0;">MajRawSym</span>::<span style="color: #4ec9b0;">Integer</span> =&gt; {
            <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">x</span> = x.to_integer().unwrap();
            <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">y</span> = y.to_integer().unwrap();
            <span style="color: #4ec9b0;">Ok</span>(<span style="color: #4ec9b0;">Maj</span>::integer(x * y))
        },
        <span style="color: #4ec9b0;">MajRawSym</span>::<span style="color: #4ec9b0;">Float</span> =&gt; {
            <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">x</span> = x.to_float().unwrap();
            <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">y</span> = y.to_float().unwrap();
            <span style="color: #4ec9b0;">Ok</span>(<span style="color: #4ec9b0;">Maj</span>::float(x * y))
        },
        <span style="color: #4ec9b0;">MajRawSym</span>::<span style="color: #4ec9b0;">Fraction</span> =&gt; {
            <span style="color: #569cd6;">let</span> (nx, dx) = x.to_fraction().unwrap();
            <span style="color: #569cd6;">let</span> (ny, dy) = y.to_fraction().unwrap();
            <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">nr</span> = nx * ny;
            <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">dr</span> = dx * dy;
            simplify_frac_coerce(<span style="color: #4ec9b0;">Maj</span>::fraction(nr, dr))
        },
        <span style="color: #4ec9b0;">MajRawSym</span>::<span style="color: #4ec9b0;">Complex</span> =&gt; {
            <span style="color: #4ec9b0;">Ok</span>(maj_arithm_internal_complex_mult(
                <span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, env, x, y))
        },
        t =&gt; <span style="color: #c586c0;">panic!</span>(<span style="color: #ce9178;">"{:?} is not a number subtype"</span>, t),
    }
}
</pre>
</div>

<div class="org-src-container">
<pre class="src src-rust"><span style="color: #569cd6;">fn</span> <span style="color: #dcdcaa;">maj_arithm_internal_complex_mult</span>(
    <span style="color: #569cd6;">mut</span> <span style="color: #9cdcfe;">state</span>: <span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> <span style="color: #4ec9b0;">MajState</span>,
    <span style="color: #9cdcfe;">env</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;,
    <span style="color: #9cdcfe;">x</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;,
    <span style="color: #9cdcfe;">y</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;
) -&gt; <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt; {
    <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">xr</span> = maj_real_part(x.clone());
    <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">xi</span> = maj_imag_part(x);
    <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">yr</span> = maj_real_part(y.clone());
    <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">yi</span> = maj_imag_part(y);

    <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">firsts</span> = maj_arithm_times(
        <span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, env.clone(),
        <span style="color: #c586c0;">maj_list!</span>(xr.clone(), yr.clone()));
    <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">outers</span> = <span style="color: #4ec9b0;">Maj</span>::complex(
        <span style="color: #4ec9b0;">Maj</span>::integer(0),
        maj_arithm_times(
            <span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, env.clone(),
            <span style="color: #c586c0;">maj_list!</span>(xr.clone(), yi.clone())));
    <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">inners</span> = <span style="color: #4ec9b0;">Maj</span>::complex(
        <span style="color: #4ec9b0;">Maj</span>::integer(0),
        maj_arithm_times(
            <span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, env.clone(),
            <span style="color: #c586c0;">maj_list!</span>(xi.clone(), yr.clone())));
    <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">lasts</span> = maj_arithm_times(
        <span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, env.clone(),
        <span style="color: #c586c0;">maj_list!</span>(xi, yi));
    <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">lasts</span> = maj_negate(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, env.clone(), lasts);

    maj_arithm_plus(
        <span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, env,
        <span style="color: #c586c0;">maj_list!</span>(firsts, outers, inners, lasts))
}
</pre>
</div>
</div>

<ol class="org-ol">
<li><a id="org00c7411"></a>Ajudante de dedução de sinal<br />
<div class="outline-text-5" id="text-29-1-3-1">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #569cd6;">fn</span> <span style="color: #dcdcaa;">maj_signum</span>(
    <span style="color: #569cd6;">mut</span> <span style="color: #9cdcfe;">state</span>: <span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> <span style="color: #4ec9b0;">MajState</span>,
    <span style="color: #9cdcfe;">env</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;,
    <span style="color: #9cdcfe;">x</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;
) -&gt; <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt; {
    <span style="color: #569cd6;">if</span> maj_zerop(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, env, x.clone()).to_bool() {
        x
    } <span style="color: #569cd6;">else</span> <span style="color: #569cd6;">if</span> maj_arithm_lesser(
        <span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state,
        x.clone(),
        <span style="color: #4ec9b0;">Maj</span>::integer(0),
        <span style="color: #4ec9b0;">Maj</span>::nil()).to_bool() {
        <span style="color: #4ec9b0;">Maj</span>::integer(-1)
    } <span style="color: #569cd6;">else</span> {
        <span style="color: #4ec9b0;">Maj</span>::integer(1)
    }
}
</pre>
</div>
</div>
</li>
</ol>
</div>

<div id="outline-container-org229d514" class="outline-4">
<h4 id="org229d514"><span class="section-number-4">29.1.4.</span> Ajudante de divisão</h4>
<div class="outline-text-4" id="text-29-1-4">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #569cd6;">fn</span> <span style="color: #dcdcaa;">maj_arithm_internal_divide</span>(
    <span style="color: #569cd6;">mut</span> <span style="color: #9cdcfe;">state</span>: <span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> <span style="color: #4ec9b0;">MajState</span>,
    <span style="color: #9cdcfe;">env</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;,
    <span style="color: #9cdcfe;">x</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;,
    <span style="color: #9cdcfe;">y</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;,
    <span style="color: #9cdcfe;">ntype</span>: <span style="color: #4ec9b0;">MajRawSym</span>
) -&gt; <span style="color: #4ec9b0;">Result</span>&lt;<span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;, <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;&gt; {
    <span style="color: #569cd6;">match</span> ntype {
        <span style="color: #4ec9b0;">MajRawSym</span>::<span style="color: #4ec9b0;">Integer</span> =&gt; {
            <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">x</span> = x.to_integer().unwrap();
            <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">y</span> = y.to_integer().unwrap();
            <span style="color: #569cd6;">if</span> y == 0 {
                <span style="color: #4ec9b0;">Err</span>(maj_err(<span style="color: #4ec9b0;">Maj</span>::string(<span style="color: #ce9178;">"Division by zero"</span>),
                            <span style="color: #4ec9b0;">Maj</span>::nil()))
            } <span style="color: #569cd6;">else</span> {
                <span style="color: #4ec9b0;">Ok</span>(<span style="color: #569cd6;">if</span> x % y == 0 {
                    <span style="color: #4ec9b0;">Maj</span>::integer(x / y)
                } <span style="color: #569cd6;">else</span> {
                    simplify_frac_coerce(<span style="color: #4ec9b0;">Maj</span>::fraction(x, y)).unwrap()
                })
            }
        },
        <span style="color: #4ec9b0;">MajRawSym</span>::<span style="color: #4ec9b0;">Float</span> =&gt; {
            <span style="color: #569cd6;">if</span> maj_zerop(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, env, y.clone()).to_bool() {
                <span style="color: #4ec9b0;">Err</span>(maj_err(<span style="color: #4ec9b0;">Maj</span>::string(<span style="color: #ce9178;">"Division by zero"</span>),
                            <span style="color: #4ec9b0;">Maj</span>::nil()))
            } <span style="color: #569cd6;">else</span> {
                <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">x</span> = x.to_float().unwrap();
                <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">y</span> = y.to_float().unwrap();
                <span style="color: #4ec9b0;">Ok</span>(<span style="color: #4ec9b0;">Maj</span>::float(x / y))
            }
        },
        <span style="color: #4ec9b0;">MajRawSym</span>::<span style="color: #4ec9b0;">Fraction</span> =&gt; {
            <span style="color: #569cd6;">let</span> (nx, dx) = x.to_fraction().unwrap();
            <span style="color: #569cd6;">let</span> (ny, dy) = y.to_fraction().unwrap();
            <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">nr</span> = nx * dy;
            <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">dr</span> = dx * ny;
            <span style="color: #6a9955;">// </span><span style="color: #6a9955;">Division by zero verified by this function</span>
            simplify_frac_coerce(<span style="color: #4ec9b0;">Maj</span>::fraction(nr, dr))
        },
        <span style="color: #4ec9b0;">MajRawSym</span>::<span style="color: #4ec9b0;">Complex</span> =&gt; {
            <span style="color: #569cd6;">return</span> maj_arithm_internal_complex_div(
                <span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, env, x, y);
        },
        t =&gt; <span style="color: #c586c0;">panic!</span>(<span style="color: #ce9178;">"{:?} is not a number subtype"</span>, t),
    }
}
</pre>
</div>

<div class="org-src-container">
<pre class="src src-rust"><span style="color: #569cd6;">fn</span> <span style="color: #dcdcaa;">maj_arithm_internal_complex_div</span>(
    <span style="color: #569cd6;">mut</span> <span style="color: #9cdcfe;">state</span>: <span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> <span style="color: #4ec9b0;">MajState</span>,
    <span style="color: #9cdcfe;">env</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;,
    <span style="color: #9cdcfe;">x</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;,
    <span style="color: #9cdcfe;">y</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;
) -&gt; <span style="color: #4ec9b0;">Result</span>&lt;<span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;, <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;&gt; {
    <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">yconj</span> = maj_arithm_plus(
        <span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, env.clone(),
        <span style="color: #c586c0;">maj_list!</span>(y.clone()));

    <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">dividend</span> = maj_arithm_times(
        <span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, env.clone(),
        <span style="color: #c586c0;">maj_list!</span>(x, yconj.clone()));
    <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">divisor</span> = maj_arithm_times(
        <span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, env.clone(),
        <span style="color: #c586c0;">maj_list!</span>(y, yconj.clone()));

    <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">divisor</span> = maj_real_part(divisor);
    <span style="color: #569cd6;">if</span> maj_zerop(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state,
                 env.clone(),
                 divisor.clone()
    ).to_bool() {
        <span style="color: #569cd6;">return</span> <span style="color: #4ec9b0;">Err</span>(maj_err(<span style="color: #4ec9b0;">Maj</span>::string(<span style="color: #ce9178;">"Division by zero"</span>),
                           <span style="color: #4ec9b0;">Maj</span>::nil()));
    }

    <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">dividend_r</span> = maj_real_part(dividend.clone());
    <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">dividend_i</span> = maj_imag_part(dividend);

    <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">realpart</span> = maj_arithm_divide(
        <span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, env.clone(),
        <span style="color: #c586c0;">maj_list!</span>(dividend_r, divisor.clone()));
    <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">imagpart</span> = maj_arithm_divide(
        <span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, env.clone(),
        <span style="color: #c586c0;">maj_list!</span>(dividend_i, divisor.clone()));
    <span style="color: #4ec9b0;">Ok</span>(<span style="color: #4ec9b0;">Maj</span>::complex(realpart, imagpart))
}
</pre>
</div>
</div>

<ol class="org-ol">
<li><a id="org9f09798"></a>Ajudante de recíproco<br />
<div class="outline-text-5" id="text-29-1-4-1">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #569cd6;">fn</span> <span style="color: #dcdcaa;">maj_reciprocal</span>(
    <span style="color: #569cd6;">mut</span> <span style="color: #9cdcfe;">state</span>: <span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> <span style="color: #4ec9b0;">MajState</span>,
    <span style="color: #9cdcfe;">env</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;,
    <span style="color: #9cdcfe;">x</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;
) -&gt; <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt; {
    <span style="color: #569cd6;">if</span> maj_zerop(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, env.clone(), x.clone()).to_bool() {
        maj_err(<span style="color: #4ec9b0;">Maj</span>::string(<span style="color: #ce9178;">"Division by zero"</span>),
                <span style="color: #4ec9b0;">Maj</span>::nil())
    } <span style="color: #569cd6;">else</span> {
        maj_arithm_divide(
            <span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, env,
            <span style="color: #c586c0;">maj_list!</span>(<span style="color: #4ec9b0;">Maj</span>::fraction(1, 1), x.clone()))
    }
}
</pre>
</div>
</div>
</li>
</ol>
</div>
</div>

<div id="outline-container-orgc2bb12a" class="outline-3">
<h3 id="orgc2bb12a"><span class="section-number-3">29.2.</span> <code>(+ . rest)</code></h3>
<div class="outline-text-3" id="text-29-2">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #569cd6;">pub</span> <span style="color: #569cd6;">fn</span> <span style="color: #dcdcaa;">maj_arithm_plus</span>(
    <span style="color: #569cd6;">mut</span> <span style="color: #9cdcfe;">state</span>: <span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> <span style="color: #4ec9b0;">MajState</span>,
    <span style="color: #9cdcfe;">env</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;,
    <span style="color: #9cdcfe;">rest</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;
) -&gt; <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt; {
    <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">len</span> = maj_length(rest.clone());
    <span style="color: #569cd6;">if</span> maj_errorp(len.clone()).to_bool() {
        <span style="color: #569cd6;">return</span> len;
    }
    <span style="color: #569cd6;">match</span> len.to_integer().unwrap() {
        0 =&gt; <span style="color: #4ec9b0;">Maj</span>::integer(1),
        1 =&gt; {
            <span style="color: #c586c0;">maj_destructure_args!</span>(rest, x);
            <span style="color: #569cd6;">if</span> !maj_numberp(x.clone()).to_bool() {
                maj_err(<span style="color: #4ec9b0;">Maj</span>::string(<span style="color: #ce9178;">"{} is not a number"</span>),
                        <span style="color: #c586c0;">maj_list!</span>(x))
            } <span style="color: #569cd6;">else</span> {
                maj_conjugate(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, env, x)
            }
        },
        _ =&gt; {
            <span style="color: #c586c0;">maj_destructure_args!</span>(rest, x, r1, y, rest);
            <span style="color: #569cd6;">if</span> !maj_numberp(x.clone()).to_bool() {
                maj_err(<span style="color: #4ec9b0;">Maj</span>::string(<span style="color: #ce9178;">"{} is not a number"</span>),
                        <span style="color: #c586c0;">maj_list!</span>(x))
            } <span style="color: #569cd6;">else</span> <span style="color: #569cd6;">if</span> !maj_numberp(y.clone()).to_bool() {
                maj_err(<span style="color: #4ec9b0;">Maj</span>::string(<span style="color: #ce9178;">"{} is not a number"</span>),
                        <span style="color: #c586c0;">maj_list!</span>(y))
            } <span style="color: #569cd6;">else</span> {
                maj_arithm_dispatch(
                    <span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, <span style="color: #4ec9b0;">Maj</span>::nil(),
                    <span style="color: #4ec9b0;">MajArithmFnType</span>::<span style="color: #4ec9b0;">Plus</span>,
                    x, y, rest, <span style="color: #569cd6;">true</span>)
            }
        },
    }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgbad963c" class="outline-3">
<h3 id="orgbad963c"><span class="section-number-3">29.3.</span> <code>(- . rest)</code></h3>
<div class="outline-text-3" id="text-29-3">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #569cd6;">pub</span> <span style="color: #569cd6;">fn</span> <span style="color: #dcdcaa;">maj_arithm_minus</span>(
    <span style="color: #569cd6;">mut</span> <span style="color: #9cdcfe;">state</span>: <span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> <span style="color: #4ec9b0;">MajState</span>,
    <span style="color: #9cdcfe;">env</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;,
    <span style="color: #9cdcfe;">rest</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;
) -&gt; <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt; {
    <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">len</span> = maj_length(rest.clone());
    <span style="color: #569cd6;">if</span> maj_errorp(len.clone()).to_bool() {
        <span style="color: #569cd6;">return</span> len;
    }
    <span style="color: #569cd6;">match</span> len.to_integer().unwrap() {
        0 =&gt; <span style="color: #4ec9b0;">Maj</span>::integer(0),
        1 =&gt; {
            <span style="color: #c586c0;">maj_destructure_args!</span>(rest, x);
            <span style="color: #569cd6;">if</span> !maj_numberp(x.clone()).to_bool() {
                maj_err(<span style="color: #4ec9b0;">Maj</span>::string(<span style="color: #ce9178;">"{} is not a number"</span>),
                        <span style="color: #c586c0;">maj_list!</span>(x))
            } <span style="color: #569cd6;">else</span> {
                maj_negate(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, env, x)
            }
        },
        _ =&gt; {
            <span style="color: #c586c0;">maj_destructure_args!</span>(rest, x, r1, y, rest);
            <span style="color: #569cd6;">if</span> !maj_numberp(x.clone()).to_bool() {
                maj_err(<span style="color: #4ec9b0;">Maj</span>::string(<span style="color: #ce9178;">"{} is not a number"</span>),
                        <span style="color: #c586c0;">maj_list!</span>(x))
            } <span style="color: #569cd6;">else</span> <span style="color: #569cd6;">if</span> !maj_numberp(y.clone()).to_bool() {
                maj_err(<span style="color: #4ec9b0;">Maj</span>::string(<span style="color: #ce9178;">"{} is not a number"</span>),
                        <span style="color: #c586c0;">maj_list!</span>(y))
            } <span style="color: #569cd6;">else</span> {
                maj_arithm_dispatch(
                    <span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, <span style="color: #4ec9b0;">Maj</span>::nil(),
                    <span style="color: #4ec9b0;">MajArithmFnType</span>::<span style="color: #4ec9b0;">Minus</span>,
                    x, y, rest, <span style="color: #569cd6;">true</span>)
            }
        },
    }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgf807765" class="outline-3">
<h3 id="orgf807765"><span class="section-number-3">29.4.</span> <code>(* . rest)</code></h3>
<div class="outline-text-3" id="text-29-4">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #569cd6;">pub</span> <span style="color: #569cd6;">fn</span> <span style="color: #dcdcaa;">maj_arithm_times</span>(
    <span style="color: #569cd6;">mut</span> <span style="color: #9cdcfe;">state</span>: <span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> <span style="color: #4ec9b0;">MajState</span>,
    <span style="color: #9cdcfe;">env</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;,
    <span style="color: #9cdcfe;">rest</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;
) -&gt; <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt; {
    <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">len</span> = maj_length(rest.clone());
    <span style="color: #569cd6;">if</span> maj_errorp(len.clone()).to_bool() {
        <span style="color: #569cd6;">return</span> len;
    }
    <span style="color: #569cd6;">match</span> len.to_integer().unwrap() {
        0 =&gt; <span style="color: #4ec9b0;">Maj</span>::integer(1),
        1 =&gt; {
            <span style="color: #c586c0;">maj_destructure_args!</span>(rest, x);
            <span style="color: #569cd6;">if</span> !maj_numberp(x.clone()).to_bool() {
                maj_err(<span style="color: #4ec9b0;">Maj</span>::string(<span style="color: #ce9178;">"{} is not a number"</span>),
                        <span style="color: #c586c0;">maj_list!</span>(x))
            } <span style="color: #569cd6;">else</span> {
                maj_signum(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, env, x)
            }
        },
        _ =&gt; {
            <span style="color: #c586c0;">maj_destructure_args!</span>(rest, x, r1, y, rest);
            <span style="color: #569cd6;">if</span> !maj_numberp(x.clone()).to_bool() {
                maj_err(<span style="color: #4ec9b0;">Maj</span>::string(<span style="color: #ce9178;">"{} is not a number"</span>),
                        <span style="color: #c586c0;">maj_list!</span>(x))
            } <span style="color: #569cd6;">else</span> <span style="color: #569cd6;">if</span> !maj_numberp(y.clone()).to_bool() {
                maj_err(<span style="color: #4ec9b0;">Maj</span>::string(<span style="color: #ce9178;">"{} is not a number"</span>),
                        <span style="color: #c586c0;">maj_list!</span>(y))
            } <span style="color: #569cd6;">else</span> {
                maj_arithm_dispatch(
                    <span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, <span style="color: #4ec9b0;">Maj</span>::nil(),
                    <span style="color: #4ec9b0;">MajArithmFnType</span>::<span style="color: #4ec9b0;">Multiply</span>,
                    x, y, rest, <span style="color: #569cd6;">true</span>)
            }
        },
    }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org454baf2" class="outline-3">
<h3 id="org454baf2"><span class="section-number-3">29.5.</span> <code>(/ . rest)</code></h3>
<div class="outline-text-3" id="text-29-5">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #569cd6;">pub</span> <span style="color: #569cd6;">fn</span> <span style="color: #dcdcaa;">maj_arithm_divide</span>(
    <span style="color: #569cd6;">mut</span> <span style="color: #9cdcfe;">state</span>: <span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> <span style="color: #4ec9b0;">MajState</span>,
    <span style="color: #9cdcfe;">env</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;,
    <span style="color: #9cdcfe;">rest</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;
) -&gt; <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt; {
    <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">len</span> = maj_length(rest.clone());
    <span style="color: #569cd6;">if</span> maj_errorp(len.clone()).to_bool() {
        <span style="color: #569cd6;">return</span> len;
    }
    <span style="color: #569cd6;">match</span> len.to_integer().unwrap() {
        0 =&gt; <span style="color: #4ec9b0;">Maj</span>::integer(1),
        1 =&gt; {
            <span style="color: #c586c0;">maj_destructure_args!</span>(rest, x);
            <span style="color: #569cd6;">if</span> !maj_numberp(x.clone()).to_bool() {
                maj_err(<span style="color: #4ec9b0;">Maj</span>::string(<span style="color: #ce9178;">"{} is not a number"</span>),
                        <span style="color: #c586c0;">maj_list!</span>(x))
            } <span style="color: #569cd6;">else</span> {
                maj_reciprocal(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, env, x)
            }
        },
        _ =&gt; {
            <span style="color: #c586c0;">maj_destructure_args!</span>(rest, x, r1, y, rest);
            <span style="color: #569cd6;">if</span> !maj_numberp(x.clone()).to_bool() {
                maj_err(<span style="color: #4ec9b0;">Maj</span>::string(<span style="color: #ce9178;">"{} is not a number"</span>),
                        <span style="color: #c586c0;">maj_list!</span>(x))
            } <span style="color: #569cd6;">else</span> <span style="color: #569cd6;">if</span> !maj_numberp(y.clone()).to_bool() {
                maj_err(<span style="color: #4ec9b0;">Maj</span>::string(<span style="color: #ce9178;">"{} is not a number"</span>),
                        <span style="color: #c586c0;">maj_list!</span>(y))
            } <span style="color: #569cd6;">else</span> {
                maj_arithm_dispatch(
                    <span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, <span style="color: #4ec9b0;">Maj</span>::nil(),
                    <span style="color: #4ec9b0;">MajArithmFnType</span>::<span style="color: #4ec9b0;">Divide</span>,
                    x, y, rest, <span style="color: #569cd6;">true</span>)
            }
        },
    }
}
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org847d885" class="outline-2">
<h2 id="org847d885"><span class="section-number-2">30.</span> Funções de streams</h2>
<div class="outline-text-2" id="text-30">
</div>
<div id="outline-container-orgece963d" class="outline-3">
<h3 id="orgece963d"><span class="section-number-3">30.1.</span> Funções auxiliares</h3>
<div class="outline-text-3" id="text-30-1">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #569cd6;">use</span> <span style="color: #569cd6;">crate</span>::<span style="color: #569cd6;">core</span>::<span style="color: #569cd6;">types</span>::{
    <span style="color: #4ec9b0;">MajStreamType</span>,
    <span style="color: #4ec9b0;">MajStreamDirection</span>
};
</pre>
</div>
</div>

<div id="outline-container-org6e22c52" class="outline-4">
<h4 id="org6e22c52"><span class="section-number-4">30.1.1.</span> Desempacotamento de um File</h4>
<div class="outline-text-4" id="text-30-1-1">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #569cd6;">fn</span> <span style="color: #dcdcaa;">get_raw_stream</span>(
    <span style="color: #569cd6;">mut</span> <span style="color: #9cdcfe;">state</span>: <span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> <span style="color: #4ec9b0;">MajState</span>,
    <span style="color: #9cdcfe;">stream</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;,
    <span style="color: #9cdcfe;">expected_dir</span>: <span style="color: #4ec9b0;">MajStreamDirection</span>
) -&gt; <span style="color: #4ec9b0;">Result</span>&lt;<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">std</span>::<span style="color: #569cd6;">fs</span>::<span style="color: #4ec9b0;">File</span>, <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;&gt; {
    <span style="color: #569cd6;">use</span> <span style="color: #569cd6;">std</span>::<span style="color: #569cd6;">io</span>::<span style="color: #4ec9b0;">Seek</span>;
    <span style="color: #569cd6;">if</span> <span style="color: #569cd6;">let</span> <span style="color: #4ec9b0;">Maj</span>::<span style="color: #4ec9b0;">Stream</span>(mstream) = <span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span>*stream.clone() {
        <span style="color: #569cd6;">if</span> mstream.is_internal() {
            <span style="color: #c586c0;">panic!</span>(<span style="color: #ce9178;">"Never try to use *stdin* or *stdout* as ordinary streams!"</span>);
        }

        <span style="color: #569cd6;">if</span> maj_nilp(state.stat_stream(mstream.handle)).to_bool() {
            <span style="color: #4ec9b0;">Err</span>(maj_err(
                <span style="color: #4ec9b0;">Maj</span>::string(<span style="color: #ce9178;">"The stream {} is closed"</span>),
                <span style="color: #c586c0;">maj_list!</span>(stream)))
        }
        <span style="color: #569cd6;">else</span> <span style="color: #569cd6;">if</span> mstream.direction == expected_dir {
            <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">eof_sym</span> = <span style="color: #4ec9b0;">Maj</span>::symbol(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, <span style="color: #ce9178;">"eof"</span>);
            <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">file</span> = state.borrow_stream(mstream.handle);
            <span style="color: #569cd6;">let</span> <span style="color: #569cd6;">mut</span> <span style="color: #9cdcfe;">file</span> = file.unwrap();
            <span style="color: #569cd6;">if</span> expected_dir == <span style="color: #4ec9b0;">MajStreamDirection</span>::<span style="color: #4ec9b0;">In</span> {
                <span style="color: #6a9955;">// </span><span style="color: #6a9955;">Check if eof.</span>
                <span style="color: #6a9955;">// </span><span style="color: #6a9955;">If fails, position is unspecified and should</span>
                <span style="color: #6a9955;">// </span><span style="color: #6a9955;">error out anyway. So we use unwrap.</span>
                <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">length</span> = file.stream_len().unwrap();
                <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">pos</span>    = file.stream_position().unwrap();
                <span style="color: #569cd6;">if</span> pos &gt;= length {
                    <span style="color: #569cd6;">return</span> <span style="color: #4ec9b0;">Err</span>(eof_sym)
                }
            }
            <span style="color: #4ec9b0;">Ok</span>(file)
        }
        <span style="color: #569cd6;">else</span> {
            <span style="color: #4ec9b0;">Err</span>(maj_err(
                <span style="color: #4ec9b0;">Maj</span>::string(<span style="color: #ce9178;">"{} is not an {} stream"</span>),
                <span style="color: #c586c0;">maj_list!</span>(
                    stream,
                <span style="color: #4ec9b0;">Maj</span>::string(
                    <span style="color: #569cd6;">if</span> expected_dir ==
                        <span style="color: #4ec9b0;">MajStreamDirection</span>::<span style="color: #4ec9b0;">In</span> {
                            <span style="color: #ce9178;">"input"</span>
                        } <span style="color: #569cd6;">else</span> {
                            <span style="color: #ce9178;">"output"</span>
                        }))))
        }
    } <span style="color: #569cd6;">else</span> {
        <span style="color: #4ec9b0;">Err</span>(maj_err(
            <span style="color: #4ec9b0;">Maj</span>::string(<span style="color: #ce9178;">"{} is not a stream"</span>),
            <span style="color: #c586c0;">maj_list!</span>(stream)))
    }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org882ec1a" class="outline-4">
<h4 id="org882ec1a"><span class="section-number-4">30.1.2.</span> Testes de stream padrão</h4>
<div class="outline-text-4" id="text-30-1-2">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #569cd6;">fn</span> <span style="color: #dcdcaa;">stdstreamp</span>(<span style="color: #9cdcfe;">x</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;) -&gt; <span style="color: #4ec9b0;">bool</span> {
    <span style="color: #569cd6;">if</span> <span style="color: #569cd6;">let</span> <span style="color: #4ec9b0;">Maj</span>::<span style="color: #4ec9b0;">Stream</span>(mstream) = <span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span>*x.clone() {
        mstream.is_internal()
    } <span style="color: #569cd6;">else</span> {
        <span style="color: #569cd6;">false</span>
    }
}
</pre>
</div>

<div class="org-src-container">
<pre class="src src-rust"><span style="color: #569cd6;">fn</span> <span style="color: #dcdcaa;">stdstreamdirp</span>(<span style="color: #9cdcfe;">x</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;, <span style="color: #9cdcfe;">dir</span>: <span style="color: #4ec9b0;">MajStreamDirection</span>) -&gt; <span style="color: #4ec9b0;">bool</span> {
    <span style="color: #569cd6;">if</span> <span style="color: #569cd6;">let</span> <span style="color: #4ec9b0;">Maj</span>::<span style="color: #4ec9b0;">Stream</span>(mstream) = <span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span>*x.clone() {
        <span style="color: #569cd6;">if</span> !mstream.is_internal() {
            <span style="color: #c586c0;">panic!</span>(<span style="color: #ce9178;">"Not a standard stream being tested"</span>);
        }
        dir == mstream.direction
    } <span style="color: #569cd6;">else</span> {
        <span style="color: #569cd6;">false</span>
    }    
}
</pre>
</div>

<div class="org-src-container">
<pre class="src src-rust"><span style="color: #569cd6;">fn</span> <span style="color: #dcdcaa;">stdstreamtype</span>(<span style="color: #9cdcfe;">x</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;) -&gt; <span style="color: #4ec9b0;">MajStreamType</span> {
    <span style="color: #569cd6;">if</span> <span style="color: #569cd6;">let</span> <span style="color: #4ec9b0;">Maj</span>::<span style="color: #4ec9b0;">Stream</span>(mstream) = <span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span>*x.clone() {
        <span style="color: #569cd6;">if</span> !mstream.is_internal() {
            <span style="color: #c586c0;">panic!</span>(<span style="color: #ce9178;">"Not a standard stream being tested"</span>);
        }
        mstream.stype.clone()
    } <span style="color: #569cd6;">else</span> {
        <span style="color: #c586c0;">panic!</span>(<span style="color: #ce9178;">"Not a standard stream being tested"</span>);
    }
}
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org1403921" class="outline-3">
<h3 id="org1403921"><span class="section-number-3">30.2.</span> <code>(open-stream dir path)</code></h3>
<div class="outline-text-3" id="text-30-2">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #569cd6;">pub</span> <span style="color: #569cd6;">fn</span> <span style="color: #dcdcaa;">maj_open_stream</span>(
    <span style="color: #569cd6;">mut</span> <span style="color: #9cdcfe;">state</span>: <span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> <span style="color: #4ec9b0;">MajState</span>,
    <span style="color: #9cdcfe;">dir</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;,
    <span style="color: #9cdcfe;">path</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;
) -&gt; <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt; {
    <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">path_opt</span> = path.stringify();
    <span style="color: #569cd6;">if</span> path_opt.is_none() {
        <span style="color: #569cd6;">return</span> maj_err(
            <span style="color: #4ec9b0;">Maj</span>::string(<span style="color: #ce9178;">"{} is not a string"</span>),
            <span style="color: #c586c0;">maj_list!</span>(path));
    }

    <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">direction</span> =
        <span style="color: #569cd6;">if</span> maj_eq(<span style="color: #4ec9b0;">Maj</span>::symbol(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, <span style="color: #ce9178;">"in"</span>),
                  dir.clone()).to_bool() {
            <span style="color: #4ec9b0;">MajStreamDirection</span>::<span style="color: #4ec9b0;">In</span>
        } <span style="color: #569cd6;">else</span> <span style="color: #569cd6;">if</span> maj_eq(<span style="color: #4ec9b0;">Maj</span>::symbol(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, <span style="color: #ce9178;">"out"</span>),
                         dir.clone()).to_bool() {
            <span style="color: #4ec9b0;">MajStreamDirection</span>::<span style="color: #4ec9b0;">Out</span>
        } <span style="color: #569cd6;">else</span> {
            <span style="color: #569cd6;">return</span> maj_err(
                <span style="color: #4ec9b0;">Maj</span>::string(<span style="color: #ce9178;">"{} should be one of symbols 'in or 'out"</span>),
                <span style="color: #c586c0;">maj_list!</span>(dir));
        };

    <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">stream</span> =
        state.make_stream(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span>path_opt.unwrap(), direction);

    <span style="color: #569cd6;">match</span> stream {
        <span style="color: #4ec9b0;">Some</span>(obj) =&gt; obj,
        <span style="color: #4ec9b0;">None</span> =&gt; maj_err(
            <span style="color: #4ec9b0;">Maj</span>::string(<span style="color: #ce9178;">"Cannot open stream to path {}"</span>),
            <span style="color: #c586c0;">maj_list!</span>(path)),
    }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orge4b63fe" class="outline-3">
<h3 id="orge4b63fe"><span class="section-number-3">30.3.</span> <code>(close-stream x)</code></h3>
<div class="outline-text-3" id="text-30-3">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #569cd6;">pub</span> <span style="color: #569cd6;">fn</span> <span style="color: #dcdcaa;">maj_close_stream</span>(
    <span style="color: #9cdcfe;">state</span>: <span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> <span style="color: #4ec9b0;">MajState</span>,
    <span style="color: #9cdcfe;">x</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;
) -&gt; <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt; {
    state.close_stream(x)
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orge3ad0b5" class="outline-3">
<h3 id="orge3ad0b5"><span class="section-number-3">30.4.</span> <code>(stat x)</code></h3>
<div class="outline-text-3" id="text-30-4">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #569cd6;">pub</span> <span style="color: #569cd6;">fn</span> <span style="color: #dcdcaa;">maj_stat</span>(<span style="color: #569cd6;">mut</span> <span style="color: #9cdcfe;">state</span>: <span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> <span style="color: #4ec9b0;">MajState</span>, <span style="color: #9cdcfe;">x</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;) -&gt; <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt; {
    <span style="color: #569cd6;">if</span> <span style="color: #569cd6;">let</span> <span style="color: #4ec9b0;">Maj</span>::<span style="color: #4ec9b0;">Stream</span>(mstream) = <span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span>*x.clone() {
        <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">index</span>  = mstream.handle;
        <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">result</span> = state.stat_stream(index);

        <span style="color: #569cd6;">if</span> maj_errorp(result.clone()).to_bool() {
            result
        } <span style="color: #569cd6;">else</span> <span style="color: #569cd6;">if</span> maj_nilp(result.clone()).to_bool() {
            <span style="color: #4ec9b0;">Maj</span>::symbol(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, <span style="color: #ce9178;">"closed"</span>)
        } <span style="color: #569cd6;">else</span> {
            <span style="color: #4ec9b0;">Maj</span>::symbol(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, <span style="color: #ce9178;">"open"</span>)
        }
    } <span style="color: #569cd6;">else</span> {
        maj_err(
            <span style="color: #4ec9b0;">Maj</span>::string(<span style="color: #ce9178;">"Not a stream: {}"</span>),
            <span style="color: #c586c0;">maj_list!</span>(x))
    }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org6b5a5d1" class="outline-3">
<h3 id="org6b5a5d1"><span class="section-number-3">30.5.</span> <code>(read-char stream)</code></h3>
<div class="outline-text-3" id="text-30-5">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #569cd6;">pub</span> <span style="color: #569cd6;">fn</span> <span style="color: #dcdcaa;">maj_read_char</span>(<span style="color: #569cd6;">mut</span> <span style="color: #9cdcfe;">state</span>: <span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> <span style="color: #4ec9b0;">MajState</span>,
                     <span style="color: #9cdcfe;">stream</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;
) -&gt; <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt; {
    <span style="color: #569cd6;">use</span> <span style="color: #569cd6;">std</span>::<span style="color: #569cd6;">io</span>::<span style="color: #4ec9b0;">Read</span>;
    <span style="color: #569cd6;">let</span> <span style="color: #569cd6;">mut</span> <span style="color: #9cdcfe;">buffer</span> = [0; 1];
    <span style="color: #569cd6;">if</span> stdstreamp(stream.clone()) {
        <span style="color: #569cd6;">if</span> stdstreamdirp(stream.clone(), <span style="color: #4ec9b0;">MajStreamDirection</span>::<span style="color: #4ec9b0;">In</span>) {
            <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">peekopt</span> = state.pop_stdin_peeked();
            <span style="color: #569cd6;">match</span> peekopt {
                <span style="color: #4ec9b0;">Some</span>(c) =&gt; {
                    <span style="color: #569cd6;">return</span> <span style="color: #4ec9b0;">Maj</span>::character(c);
                },
                <span style="color: #4ec9b0;">None</span> =&gt; {
                    <span style="color: #569cd6;">use</span> <span style="color: #569cd6;">std</span>::io;
                    <span style="color: #569cd6;">match</span> <span style="color: #569cd6;">io</span>::stdin().read(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> buffer) {
                        <span style="color: #4ec9b0;">Ok</span>(_) =&gt; {
                            <span style="color: #569cd6;">return</span> <span style="color: #4ec9b0;">Maj</span>::character(buffer[0] <span style="color: #569cd6;">as</span> <span style="color: #4ec9b0;">char</span>);
                        },
                        <span style="color: #4ec9b0;">Err</span>(_) =&gt; {
                            <span style="color: #569cd6;">return</span> maj_err(
                                <span style="color: #4ec9b0;">Maj</span>::string(
                                    <span style="color: #ce9178;">"Could not read from stream *stdin*"</span>),
                                <span style="color: #4ec9b0;">Maj</span>::nil());
                        }
                    }
                },
            }
        } <span style="color: #569cd6;">else</span> {
            <span style="color: #569cd6;">return</span> maj_err(
                <span style="color: #4ec9b0;">Maj</span>::string(<span style="color: #ce9178;">"{} is not an input stream"</span>),
                <span style="color: #c586c0;">maj_list!</span>(stream));
        }
    }

    <span style="color: #569cd6;">match</span> get_raw_stream(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state,
                         stream.clone(),
                         <span style="color: #4ec9b0;">MajStreamDirection</span>::<span style="color: #4ec9b0;">In</span>) {
        <span style="color: #4ec9b0;">Ok</span>(<span style="color: #569cd6;">mut</span> file) =&gt; {
            <span style="color: #569cd6;">match</span> file.read(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> buffer) {
                <span style="color: #4ec9b0;">Ok</span>(_) =&gt; {
                    <span style="color: #4ec9b0;">Maj</span>::character(buffer[0] <span style="color: #569cd6;">as</span> <span style="color: #4ec9b0;">char</span>)
                },
                <span style="color: #4ec9b0;">Err</span>(_) =&gt; {
                    maj_err(
                        <span style="color: #4ec9b0;">Maj</span>::string(
                            <span style="color: #ce9178;">"Could not read from stream {}"</span>),
                        <span style="color: #c586c0;">maj_list!</span>(stream))
                }
            }
        },
        <span style="color: #4ec9b0;">Err</span>(expr) =&gt; expr,
    }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgfe70f6b" class="outline-3">
<h3 id="orgfe70f6b"><span class="section-number-3">30.6.</span> <code>(peek-char stream)</code></h3>
<div class="outline-text-3" id="text-30-6">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #569cd6;">pub</span> <span style="color: #569cd6;">fn</span> <span style="color: #dcdcaa;">maj_peek_char</span>(<span style="color: #569cd6;">mut</span> <span style="color: #9cdcfe;">state</span>: <span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> <span style="color: #4ec9b0;">MajState</span>,
                     <span style="color: #9cdcfe;">stream</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;
) -&gt; <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt; {
    <span style="color: #569cd6;">use</span> <span style="color: #569cd6;">std</span>::<span style="color: #569cd6;">io</span>::{ <span style="color: #4ec9b0;">Read</span>, <span style="color: #4ec9b0;">Seek</span>, <span style="color: #4ec9b0;">SeekFrom</span> };
    <span style="color: #569cd6;">let</span> <span style="color: #569cd6;">mut</span> <span style="color: #9cdcfe;">buffer</span> = [0; 1];
    <span style="color: #569cd6;">if</span> stdstreamp(stream.clone()) {
        <span style="color: #569cd6;">if</span> stdstreamdirp(stream.clone(), <span style="color: #4ec9b0;">MajStreamDirection</span>::<span style="color: #4ec9b0;">In</span>) {
            <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">peekopt</span> = state.pop_stdin_peeked();
            <span style="color: #569cd6;">match</span> peekopt {
                <span style="color: #4ec9b0;">Some</span>(c) =&gt; {
                    state.push_stdin_peeked(c);
                    <span style="color: #569cd6;">return</span> <span style="color: #4ec9b0;">Maj</span>::character(c);
                },
                <span style="color: #4ec9b0;">None</span> =&gt; {
                    <span style="color: #569cd6;">use</span> <span style="color: #569cd6;">std</span>::io;
                    <span style="color: #569cd6;">match</span> <span style="color: #569cd6;">io</span>::stdin().read(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> buffer) {
                        <span style="color: #4ec9b0;">Ok</span>(_) =&gt; {
                            state.push_stdin_peeked(buffer[0] <span style="color: #569cd6;">as</span> <span style="color: #4ec9b0;">char</span>);
                            <span style="color: #569cd6;">return</span> <span style="color: #4ec9b0;">Maj</span>::character(buffer[0] <span style="color: #569cd6;">as</span> <span style="color: #4ec9b0;">char</span>);
                        },
                        <span style="color: #4ec9b0;">Err</span>(_) =&gt; {
                            <span style="color: #569cd6;">return</span> maj_err(
                                <span style="color: #4ec9b0;">Maj</span>::string(
                                    <span style="color: #ce9178;">"Could not read from stream *stdin*"</span>),
                                <span style="color: #4ec9b0;">Maj</span>::nil());
                        }
                    }
                },
            }
        } <span style="color: #569cd6;">else</span> {
            <span style="color: #569cd6;">return</span> maj_err(
                <span style="color: #4ec9b0;">Maj</span>::string(<span style="color: #ce9178;">"{} is not an input stream"</span>),
                <span style="color: #c586c0;">maj_list!</span>(stream));
        }
    }

    <span style="color: #569cd6;">match</span> get_raw_stream(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state,
                         stream.clone(),
                         <span style="color: #4ec9b0;">MajStreamDirection</span>::<span style="color: #4ec9b0;">In</span>) {
        <span style="color: #4ec9b0;">Ok</span>(<span style="color: #569cd6;">mut</span> file) =&gt; {
            <span style="color: #569cd6;">match</span> file.read(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> buffer) {
                <span style="color: #4ec9b0;">Ok</span>(_) =&gt; {
                    <span style="color: #6a9955;">// </span><span style="color: #6a9955;">Since a character was read,</span>
                    <span style="color: #6a9955;">// </span><span style="color: #6a9955;">seek back to a point before it.</span>
                    <span style="color: #6a9955;">// </span><span style="color: #6a9955;">If unable, this should fail anyway</span>
                    file.seek(<span style="color: #4ec9b0;">SeekFrom</span>::<span style="color: #4ec9b0;">Current</span>(-1))
                        .unwrap();
                    <span style="color: #4ec9b0;">Maj</span>::character(buffer[0] <span style="color: #569cd6;">as</span> <span style="color: #4ec9b0;">char</span>)
                },
                <span style="color: #4ec9b0;">Err</span>(_) =&gt; {
                    maj_err(
                        <span style="color: #4ec9b0;">Maj</span>::string(
                            <span style="color: #ce9178;">"Could not read from stream {}"</span>),
                        <span style="color: #c586c0;">maj_list!</span>(stream))
                }
            }
        },
        <span style="color: #4ec9b0;">Err</span>(expr) =&gt; expr,
    }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgb718d2a" class="outline-3">
<h3 id="orgb718d2a"><span class="section-number-3">30.7.</span> <code>(write-char c stream)</code></h3>
<div class="outline-text-3" id="text-30-7">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #569cd6;">pub</span> <span style="color: #569cd6;">fn</span> <span style="color: #dcdcaa;">maj_write_char</span>(<span style="color: #569cd6;">mut</span> <span style="color: #9cdcfe;">state</span>: <span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> <span style="color: #4ec9b0;">MajState</span>,
                      <span style="color: #9cdcfe;">c</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;,
                      <span style="color: #9cdcfe;">stream</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;
) -&gt; <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt; {
    <span style="color: #569cd6;">use</span> <span style="color: #569cd6;">std</span>::<span style="color: #569cd6;">io</span>::<span style="color: #4ec9b0;">Write</span>;
    <span style="color: #569cd6;">use</span> <span style="color: #569cd6;">crate</span>::<span style="color: #569cd6;">axioms</span>::<span style="color: #569cd6;">predicates</span>::maj_charp;
    <span style="color: #569cd6;">if</span> !maj_charp(c.clone()).to_bool() {
        <span style="color: #569cd6;">return</span> maj_err(
            <span style="color: #4ec9b0;">Maj</span>::string(<span style="color: #ce9178;">"{} is not a character"</span>),
            <span style="color: #c586c0;">maj_list!</span>(c));
    }
    <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">c</span> = c.to_char().unwrap();

    <span style="color: #569cd6;">if</span> stdstreamp(stream.clone()) {
        <span style="color: #569cd6;">if</span> stdstreamdirp(stream.clone(), <span style="color: #4ec9b0;">MajStreamDirection</span>::<span style="color: #4ec9b0;">Out</span>) {
            <span style="color: #569cd6;">match</span> stdstreamtype(stream) {
                <span style="color: #4ec9b0;">MajStreamType</span>::<span style="color: #4ec9b0;">Stdout</span> =&gt;
                    <span style="color: #c586c0;">print!</span>(<span style="color: #ce9178;">"</span><span style="color: #ce9178; font-style: italic;">{}</span><span style="color: #ce9178;">"</span>, c),
                <span style="color: #4ec9b0;">MajStreamType</span>::<span style="color: #4ec9b0;">Stderr</span> =&gt;
                    <span style="color: #c586c0;">eprint!</span>(<span style="color: #ce9178;">"</span><span style="color: #ce9178; font-style: italic;">{}</span><span style="color: #ce9178;">"</span>, c),
                _ =&gt; <span style="color: #c586c0;">panic!</span>(<span style="color: #ce9178;">"write char to stream of wrong type"</span>),
            };
            <span style="color: #569cd6;">return</span> <span style="color: #4ec9b0;">Maj</span>::nil();
        } <span style="color: #569cd6;">else</span> {
            <span style="color: #569cd6;">return</span> maj_err(
                <span style="color: #4ec9b0;">Maj</span>::string(<span style="color: #ce9178;">"{} is not an output stream"</span>),
                <span style="color: #c586c0;">maj_list!</span>(stream));
        }
    }

    <span style="color: #569cd6;">match</span> get_raw_stream(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state,
                         stream.clone(),
                         <span style="color: #4ec9b0;">MajStreamDirection</span>::<span style="color: #4ec9b0;">Out</span>) {
        <span style="color: #4ec9b0;">Ok</span>(<span style="color: #569cd6;">mut</span> file) =&gt; {
            <span style="color: #569cd6;">match</span> <span style="color: #c586c0;">write!</span>(file, <span style="color: #ce9178;">"</span><span style="color: #ce9178; font-style: italic;">{}</span><span style="color: #ce9178;">"</span>, c) {
                <span style="color: #4ec9b0;">Ok</span>(_) =&gt; {
                    <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">_</span> = file.flush();
                    <span style="color: #4ec9b0;">Maj</span>::nil()
                },
                <span style="color: #4ec9b0;">Err</span>(_) =&gt; {
                    maj_err(
                        <span style="color: #4ec9b0;">Maj</span>::string(
                            <span style="color: #ce9178;">"Could not write to stream {}"</span>),
                        <span style="color: #c586c0;">maj_list!</span>(stream))
                }
            }
        },
        <span style="color: #4ec9b0;">Err</span>(expr) =&gt; expr,
    }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org3eadbe1" class="outline-3">
<h3 id="org3eadbe1"><span class="section-number-3">30.8.</span> <code>(write-string str stream)</code></h3>
<div class="outline-text-3" id="text-30-8">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #569cd6;">pub</span> <span style="color: #569cd6;">fn</span> <span style="color: #dcdcaa;">maj_write_string</span>(<span style="color: #569cd6;">mut</span> <span style="color: #9cdcfe;">state</span>: <span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> <span style="color: #4ec9b0;">MajState</span>,
                        <span style="color: #9cdcfe;">strn</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;,
                        <span style="color: #9cdcfe;">stream</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;
) -&gt; <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt; {
    <span style="color: #569cd6;">use</span> <span style="color: #569cd6;">std</span>::<span style="color: #569cd6;">io</span>::<span style="color: #4ec9b0;">Write</span>;
    <span style="color: #569cd6;">if</span> !maj_stringp(strn.clone()).to_bool() {
        <span style="color: #569cd6;">return</span> maj_err(
            <span style="color: #4ec9b0;">Maj</span>::string(<span style="color: #ce9178;">"{} is not a string"</span>),
            <span style="color: #c586c0;">maj_list!</span>(strn));
    }
    <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">strn</span> = strn.stringify().unwrap();
    
    <span style="color: #569cd6;">if</span> stdstreamp(stream.clone()) {
        <span style="color: #569cd6;">if</span> stdstreamdirp(stream.clone(), <span style="color: #4ec9b0;">MajStreamDirection</span>::<span style="color: #4ec9b0;">Out</span>) {
            <span style="color: #569cd6;">match</span> stdstreamtype(stream) {
                <span style="color: #4ec9b0;">MajStreamType</span>::<span style="color: #4ec9b0;">Stdout</span> =&gt;
                    <span style="color: #c586c0;">print!</span>(<span style="color: #ce9178;">"</span><span style="color: #ce9178; font-style: italic;">{}</span><span style="color: #ce9178;">"</span>, strn),
                <span style="color: #4ec9b0;">MajStreamType</span>::<span style="color: #4ec9b0;">Stderr</span> =&gt;
                    <span style="color: #c586c0;">eprint!</span>(<span style="color: #ce9178;">"</span><span style="color: #ce9178; font-style: italic;">{}</span><span style="color: #ce9178;">"</span>, strn),
                _ =&gt; <span style="color: #c586c0;">panic!</span>(<span style="color: #ce9178;">"write string to stream of wrong type"</span>),
            };
            <span style="color: #569cd6;">return</span> <span style="color: #4ec9b0;">Maj</span>::nil();
        } <span style="color: #569cd6;">else</span> {
            <span style="color: #569cd6;">return</span> maj_err(
                <span style="color: #4ec9b0;">Maj</span>::string(<span style="color: #ce9178;">"{} is not an output stream"</span>),
                <span style="color: #c586c0;">maj_list!</span>(stream));
        }
    }

    <span style="color: #569cd6;">match</span> get_raw_stream(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state,
                         stream.clone(),
                         <span style="color: #4ec9b0;">MajStreamDirection</span>::<span style="color: #4ec9b0;">Out</span>) {
        <span style="color: #4ec9b0;">Ok</span>(<span style="color: #569cd6;">mut</span> file) =&gt; {
            <span style="color: #569cd6;">match</span> <span style="color: #c586c0;">write!</span>(file, <span style="color: #ce9178;">"</span><span style="color: #ce9178; font-style: italic;">{}</span><span style="color: #ce9178;">"</span>, strn) {
                <span style="color: #4ec9b0;">Ok</span>(_) =&gt; {
                    <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">_</span> = file.flush();
                    <span style="color: #4ec9b0;">Maj</span>::nil()
                },
                <span style="color: #4ec9b0;">Err</span>(_) =&gt; {
                    maj_err(
                        <span style="color: #4ec9b0;">Maj</span>::string(
                            <span style="color: #ce9178;">"Could not write to stream {}"</span>),
                        <span style="color: #c586c0;">maj_list!</span>(stream))
                }
            }
        },
        <span style="color: #4ec9b0;">Err</span>(expr) =&gt; expr,
    }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org0705a60" class="outline-3">
<h3 id="org0705a60"><span class="section-number-3">30.9.</span> <code>(write x stream)</code></h3>
<div class="outline-text-3" id="text-30-9">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #569cd6;">pub</span> <span style="color: #569cd6;">fn</span> <span style="color: #dcdcaa;">maj_write</span>(<span style="color: #569cd6;">mut</span> <span style="color: #9cdcfe;">state</span>: <span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> <span style="color: #4ec9b0;">MajState</span>,
                 <span style="color: #9cdcfe;">x</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;,
                 <span style="color: #9cdcfe;">stream</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;
) -&gt; <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt; {
    <span style="color: #569cd6;">use</span> <span style="color: #569cd6;">crate</span>::<span style="color: #569cd6;">printing</span>::maj_format;
    <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">string</span> = <span style="color: #4ec9b0;">Maj</span>::string(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span>maj_format(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span>state, x));
    maj_write_string(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, string, stream)
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgeb9cc1c" class="outline-3">
<h3 id="orgeb9cc1c"><span class="section-number-3">30.10.</span> <span class="todo TODO">TODO</span> <code>(read stream)</code></h3>
</div>
</div>
<div id="outline-container-org8a331f2" class="outline-2">
<h2 id="org8a331f2"><span class="section-number-2">31.</span> Funções de entrada e saída</h2>
<div class="outline-text-2" id="text-31">
</div>
<div id="outline-container-org976e6e6" class="outline-3">
<h3 id="org976e6e6"><span class="section-number-3">31.1.</span> <code>(terpri)</code></h3>
<div class="outline-text-3" id="text-31-1">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #569cd6;">pub</span> <span style="color: #569cd6;">fn</span> <span style="color: #dcdcaa;">maj_terpri</span>(<span style="color: #569cd6;">mut</span> <span style="color: #9cdcfe;">state</span>: <span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> <span style="color: #4ec9b0;">MajState</span>,
                  <span style="color: #9cdcfe;">env</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;) -&gt; <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt; {
    <span style="color: #6a9955;">// </span><span style="color: #6a9955;">Lookup dynamically bound stdout</span>
    <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">stdout</span> = <span style="color: #4ec9b0;">Maj</span>::symbol(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, <span style="color: #ce9178;">"*stdout*"</span>);
    <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">stdout</span> = state.lookup(env.clone(), stdout);
    <span style="color: #569cd6;">if</span> maj_errorp(stdout.clone()).to_bool() {
        <span style="color: #569cd6;">return</span> stdout;
    }

    maj_write_char(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, <span style="color: #4ec9b0;">Maj</span>::character(<span style="color: #ce9178;">'\n'</span>),
                   stdout)
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orga07aa3a" class="outline-3">
<h3 id="orga07aa3a"><span class="section-number-3">31.2.</span> <code>(display x)</code></h3>
<div class="outline-text-3" id="text-31-2">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #569cd6;">pub</span> <span style="color: #569cd6;">fn</span> <span style="color: #dcdcaa;">maj_display</span>(<span style="color: #569cd6;">mut</span> <span style="color: #9cdcfe;">state</span>: <span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> <span style="color: #4ec9b0;">MajState</span>,
                   <span style="color: #9cdcfe;">x</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;,
                   <span style="color: #9cdcfe;">env</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;
) -&gt; <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt; {
    <span style="color: #6a9955;">// </span><span style="color: #6a9955;">Lookup dynamically bound stdout</span>
    <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">stdout</span> = <span style="color: #4ec9b0;">Maj</span>::symbol(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, <span style="color: #ce9178;">"*stdout*"</span>);
    <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">stdout</span> = state.lookup(env.clone(), stdout);
    <span style="color: #569cd6;">if</span> maj_errorp(stdout.clone()).to_bool() {
        <span style="color: #569cd6;">return</span> stdout;
    }

    maj_write(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, x, stdout)
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org243fde1" class="outline-3">
<h3 id="org243fde1"><span class="section-number-3">31.3.</span> <span class="todo TODO">TODO</span> <code>(pretty-display x)</code></h3>
<div class="outline-text-3" id="text-31-3">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #569cd6;">pub</span> <span style="color: #569cd6;">fn</span> <span style="color: #dcdcaa;">maj_pretty_display</span>(<span style="color: #569cd6;">mut</span> <span style="color: #9cdcfe;">state</span>: <span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> <span style="color: #4ec9b0;">MajState</span>,
                          <span style="color: #9cdcfe;">x</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;,
                          <span style="color: #9cdcfe;">env</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;
) -&gt; <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt; {
    <span style="color: #569cd6;">use</span> <span style="color: #569cd6;">crate</span>::<span style="color: #569cd6;">printing</span>::maj_pretty_format;
    <span style="color: #6a9955;">// </span><span style="color: #6a9955;">Lookup dynamically bound stdout</span>
    <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">stdout</span> = <span style="color: #4ec9b0;">Maj</span>::symbol(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, <span style="color: #ce9178;">"*stdout*"</span>);
    <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">stdout</span> = state.lookup(env.clone(), stdout);
    <span style="color: #569cd6;">if</span> maj_errorp(stdout.clone()).to_bool() {
        <span style="color: #569cd6;">return</span> stdout;
    }

    <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">string</span> = maj_pretty_format(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span>state, x);
    <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">string</span> = <span style="color: #4ec9b0;">Maj</span>::string(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span>string);
    maj_write_string(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, string, stdout)
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org13e79a7" class="outline-3">
<h3 id="org13e79a7"><span class="section-number-3">31.4.</span> <code>(print fmt . args)</code></h3>
<div class="outline-text-3" id="text-31-4">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #569cd6;">pub</span> <span style="color: #569cd6;">fn</span> <span style="color: #dcdcaa;">maj_print</span>(
    <span style="color: #569cd6;">mut</span> <span style="color: #9cdcfe;">state</span>: <span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> <span style="color: #4ec9b0;">MajState</span>,
    <span style="color: #9cdcfe;">fmt</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;,
    <span style="color: #9cdcfe;">rest</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;,
    <span style="color: #9cdcfe;">env</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;
) -&gt; <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt; {
    <span style="color: #6a9955;">// </span><span style="color: #6a9955;">Lookup dynamically bound stdout</span>
    <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">stdout</span> = <span style="color: #4ec9b0;">Maj</span>::symbol(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, <span style="color: #ce9178;">"*stdout*"</span>);
    <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">stdout</span> = state.lookup(env.clone(), stdout);
    <span style="color: #569cd6;">if</span> maj_errorp(stdout.clone()).to_bool() {
        <span style="color: #569cd6;">return</span> stdout;
    }

    <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">formatted</span> = maj_format_prim(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span>state, fmt, rest);
    <span style="color: #569cd6;">if</span> maj_errorp(formatted.clone()).to_bool() {
        formatted
    } <span style="color: #569cd6;">else</span> {
        maj_write_string(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, formatted,
                         stdout.clone());
        maj_write_char(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, <span style="color: #4ec9b0;">Maj</span>::character(<span style="color: #ce9178;">'\n'</span>),
                   stdout)
    }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgf195a19" class="outline-3">
<h3 id="orgf195a19"><span class="section-number-3">31.5.</span> <span class="todo TODO">TODO</span> <code>(load path)</code></h3>
<div class="outline-text-3" id="text-31-5">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #569cd6;">pub</span> <span style="color: #569cd6;">fn</span> <span style="color: #dcdcaa;">maj_load</span>(
    <span style="color: #569cd6;">mut</span> <span style="color: #9cdcfe;">state</span>: <span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> <span style="color: #4ec9b0;">MajState</span>,
    <span style="color: #9cdcfe;">env</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;,
    <span style="color: #9cdcfe;">path</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;
) -&gt; <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt; {
    <span style="color: #569cd6;">use</span> <span style="color: #569cd6;">crate</span>::<span style="color: #569cd6;">reader</span>::<span style="color: #569cd6;">parser</span>::maj_parse;
    <span style="color: #569cd6;">use</span> <span style="color: #569cd6;">crate</span>::<span style="color: #569cd6;">reader</span>::<span style="color: #569cd6;">tokenizer</span>::maj_tokenize_file;
    <span style="color: #569cd6;">use</span> <span style="color: #569cd6;">crate</span>::<span style="color: #569cd6;">evaluator</span>::maj_eval;
    <span style="color: #569cd6;">match</span> path.clone().stringify() {
        <span style="color: #4ec9b0;">Some</span>(pathstr) =&gt; {
            <span style="color: #569cd6;">let</span> <span style="color: #569cd6;">mut</span> <span style="color: #9cdcfe;">buffer</span> = <span style="color: #4ec9b0;">String</span>::new();
            <span style="color: #569cd6;">match</span> maj_tokenize_file(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span>pathstr, <span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> buffer) {
                <span style="color: #4ec9b0;">Ok</span>(tokens) =&gt; {
                    <span style="color: #569cd6;">match</span> maj_parse(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, tokens.clone()) {
                        <span style="color: #4ec9b0;">Ok</span>(expressions) =&gt; {
                            <span style="color: #6a9955;">// </span><span style="color: #6a9955;">TODO: Iterate over forms and yield errors</span>
                            <span style="color: #6a9955;">// </span><span style="color: #6a9955;">depending on them</span>
                            <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">results</span> = maj_eval(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, <span style="color: #4ec9b0;">Maj</span>::cons(
                                <span style="color: #4ec9b0;">Maj</span>::do_sym(), expressions), env);
                            <span style="color: #569cd6;">if</span> maj_errorp(results.clone()).to_bool() {
                                maj_err(
                                    <span style="color: #4ec9b0;">Maj</span>::string(
                                        <span style="color: #ce9178;">"On evaluation of file {}: {}"</span>),
                                    <span style="color: #c586c0;">maj_list!</span>(path, results))
                            } <span style="color: #569cd6;">else</span> {
                                results
                            }
                        },
                        <span style="color: #4ec9b0;">Err</span>(msg) =&gt; {
                            maj_err(
                                <span style="color: #4ec9b0;">Maj</span>::string(<span style="color: #ce9178;">"While parsing file {}: {}"</span>),
                                <span style="color: #c586c0;">maj_list!</span>(path, <span style="color: #4ec9b0;">Maj</span>::string(msg)))
                        },
                    }
                },
                <span style="color: #4ec9b0;">Err</span>((line, msg)) =&gt; {
                    <span style="color: #569cd6;">if</span> line != 0 {
                        maj_err(
                            <span style="color: #4ec9b0;">Maj</span>::string(<span style="color: #ce9178;">"While reading file {}:{}: {}"</span>),
                            <span style="color: #c586c0;">maj_list!</span>(path, <span style="color: #4ec9b0;">Maj</span>::integer(line <span style="color: #569cd6;">as</span> <span style="color: #4ec9b0;">i64</span>),
                                      <span style="color: #4ec9b0;">Maj</span>::string(msg)))
                    } <span style="color: #569cd6;">else</span> {
                        maj_err(
                            <span style="color: #4ec9b0;">Maj</span>::string(<span style="color: #ce9178;">"While reading file {}: {}"</span>),
                            <span style="color: #c586c0;">maj_list!</span>(path, <span style="color: #4ec9b0;">Maj</span>::string(msg)))
                    }
                },
            }
        },
        <span style="color: #4ec9b0;">None</span> =&gt; maj_err(<span style="color: #4ec9b0;">Maj</span>::string(<span style="color: #ce9178;">"{} is not a string"</span>),
                        <span style="color: #c586c0;">maj_list!</span>(path)),
    }
}
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org13cc223" class="outline-2">
<h2 id="org13cc223"><span class="section-number-2">32.</span> Funções de vetores</h2>
<div class="outline-text-2" id="text-32">
</div>
<div id="outline-container-org16dba35" class="outline-3">
<h3 id="org16dba35"><span class="section-number-3">32.1.</span> <code>(vec-type vec)</code></h3>
<div class="outline-text-3" id="text-32-1">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #569cd6;">pub</span> <span style="color: #569cd6;">fn</span> <span style="color: #dcdcaa;">maj_vec_type</span>(<span style="color: #569cd6;">mut</span> <span style="color: #9cdcfe;">state</span>: <span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> <span style="color: #4ec9b0;">MajState</span>,
                    <span style="color: #9cdcfe;">vec</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;) -&gt; <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt; {
    <span style="color: #569cd6;">use</span> <span style="color: #569cd6;">crate</span>::<span style="color: #569cd6;">core</span>::<span style="color: #569cd6;">types</span>::<span style="color: #4ec9b0;">MajVector</span>;
    <span style="color: #569cd6;">if</span> !maj_vectorp(vec.clone()).to_bool() {
        <span style="color: #569cd6;">return</span> maj_err(
            <span style="color: #4ec9b0;">Maj</span>::string(<span style="color: #ce9178;">"{} is not a vector"</span>),
            <span style="color: #c586c0;">maj_list!</span>(vec));
    }
    <span style="color: #569cd6;">if</span> <span style="color: #569cd6;">let</span> <span style="color: #4ec9b0;">Maj</span>::<span style="color: #4ec9b0;">Vector</span>(v) = <span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span>*vec {
        <span style="color: #569cd6;">return</span> <span style="color: #4ec9b0;">Maj</span>::symbol(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, <span style="color: #569cd6;">match</span> v {
            <span style="color: #4ec9b0;">MajVector</span>::<span style="color: #4ec9b0;">Integer</span>(_) =&gt; <span style="color: #ce9178;">"integer"</span>,
            <span style="color: #4ec9b0;">MajVector</span>::<span style="color: #4ec9b0;">Float</span>(_)   =&gt; <span style="color: #ce9178;">"float"</span>,
            <span style="color: #4ec9b0;">MajVector</span>::<span style="color: #4ec9b0;">Char</span>(_)    =&gt; <span style="color: #ce9178;">"char"</span>,
            <span style="color: #4ec9b0;">MajVector</span>::<span style="color: #4ec9b0;">Any</span>(_)     =&gt; <span style="color: #ce9178;">"any"</span>,
        });
    }
    <span style="color: #c586c0;">panic!</span>(<span style="color: #ce9178;">"vec-type: Unknown vector type"</span>);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org7ceaa49" class="outline-3">
<h3 id="org7ceaa49"><span class="section-number-3">32.2.</span> <code>(vec-push x vec)</code></h3>
<div class="outline-text-3" id="text-32-2">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #569cd6;">pub</span> <span style="color: #569cd6;">fn</span> <span style="color: #dcdcaa;">maj_vec_push</span>(<span style="color: #569cd6;">mut</span> <span style="color: #9cdcfe;">state</span>: <span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> <span style="color: #4ec9b0;">MajState</span>, <span style="color: #9cdcfe;">x</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;, <span style="color: #9cdcfe;">vec</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;) -&gt; <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt; {
    <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">pos</span> = maj_vec_length(vec.clone());
    <span style="color: #569cd6;">if</span> maj_errorp(pos.clone()).to_bool() {
        <span style="color: #569cd6;">return</span> pos;
    }

    maj_vec_insert(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, pos, x, vec)
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgf44e962" class="outline-3">
<h3 id="orgf44e962"><span class="section-number-3">32.3.</span> <code>(vec-insert pos x vec)</code></h3>
<div class="outline-text-3" id="text-32-3">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #569cd6;">pub</span> <span style="color: #569cd6;">fn</span> <span style="color: #dcdcaa;">maj_vec_insert</span>(<span style="color: #569cd6;">mut</span> <span style="color: #9cdcfe;">state</span>: <span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> <span style="color: #4ec9b0;">MajState</span>,
                      <span style="color: #9cdcfe;">pos</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;,
                      <span style="color: #9cdcfe;">x</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;,
                      <span style="color: #9cdcfe;">vec</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;) -&gt; <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt; {
    <span style="color: #569cd6;">use</span> <span style="color: #569cd6;">crate</span>::<span style="color: #569cd6;">core</span>::<span style="color: #569cd6;">types</span>::<span style="color: #4ec9b0;">MajVector</span>;

    <span style="color: #569cd6;">if</span> !maj_vectorp(vec.clone()).to_bool() {
        <span style="color: #569cd6;">return</span> maj_err(
            <span style="color: #4ec9b0;">Maj</span>::string(<span style="color: #ce9178;">"{} is not a vector"</span>),
            <span style="color: #c586c0;">maj_list!</span>(vec));
    }

    <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">xtype</span> = maj_type(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, x.clone());
    <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">vectype</span> = maj_vec_type(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, vec.clone());
    <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">any</span> = <span style="color: #4ec9b0;">Maj</span>::symbol(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, <span style="color: #ce9178;">"any"</span>);

    <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">index</span> =
        <span style="color: #569cd6;">match</span> pos.clone().to_integer() {
            <span style="color: #4ec9b0;">Some</span>(x) =&gt; {
                <span style="color: #569cd6;">if</span> x &lt; 0 {
                    <span style="color: #569cd6;">return</span> maj_err(
                        <span style="color: #4ec9b0;">Maj</span>::string(
                            <span style="color: #ce9178;">"Index {} is out of bounds in {}"</span>),
                        <span style="color: #c586c0;">maj_list!</span>(pos, vec));
                }
                x <span style="color: #569cd6;">as</span> <span style="color: #4ec9b0;">usize</span>
            },
            <span style="color: #4ec9b0;">None</span> =&gt; {
                <span style="color: #569cd6;">return</span> maj_err(
                    <span style="color: #4ec9b0;">Maj</span>::string(<span style="color: #ce9178;">"{} is not an integer"</span>),
                    <span style="color: #c586c0;">maj_list!</span>(pos));
            },
        };

    <span style="color: #569cd6;">if</span> !maj_eq(vectype.clone(), any).to_bool()
        &amp;&amp; !maj_eq(xtype.clone(), vectype.clone()).to_bool() {
        <span style="color: #569cd6;">return</span> maj_err(
            <span style="color: #4ec9b0;">Maj</span>::string(
                <span style="color: #ce9178;">"{} has type {}, which is incompatible with insertion on vector of type {}"</span>),
            <span style="color: #c586c0;">maj_list!</span>(x, xtype, vectype));
    }

    <span style="color: #569cd6;">if</span> <span style="color: #569cd6;">let</span> <span style="color: #4ec9b0;">Maj</span>::<span style="color: #4ec9b0;">Vector</span>(v) = <span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span>*vec.clone() {
        <span style="color: #569cd6;">match</span> v {
            <span style="color: #4ec9b0;">MajVector</span>::<span style="color: #4ec9b0;">Integer</span>(v) =&gt; {
                <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">val</span> = x.to_integer().unwrap();
                <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">len</span> = v.borrow().len();
                <span style="color: #569cd6;">if</span> index &gt; len {
                    maj_err(
                        <span style="color: #4ec9b0;">Maj</span>::string(
                            <span style="color: #ce9178;">"Index {} is out of bounds in {}"</span>),
                        <span style="color: #c586c0;">maj_list!</span>(pos, vec))
                } <span style="color: #569cd6;">else</span> {
                    v.borrow_mut().insert(index, val);
                    vec
                }
            },
            <span style="color: #4ec9b0;">MajVector</span>::<span style="color: #4ec9b0;">Float</span>(v) =&gt; {
                <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">val</span> = x.to_float().unwrap();
                <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">len</span> = v.borrow().len();
                <span style="color: #569cd6;">if</span> index &gt; len {
                    maj_err(
                        <span style="color: #4ec9b0;">Maj</span>::string(
                            <span style="color: #ce9178;">"Index {} is out of bounds in {}"</span>),
                        <span style="color: #c586c0;">maj_list!</span>(pos, vec))
                } <span style="color: #569cd6;">else</span> {
                    v.borrow_mut().insert(index, val);
                    vec
                }
            },
            <span style="color: #4ec9b0;">MajVector</span>::<span style="color: #4ec9b0;">Char</span>(s) =&gt; {
                <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">val</span> = x.to_char().unwrap();
                <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">len</span> = s.borrow().chars().count();
                <span style="color: #569cd6;">if</span> index &gt; len {
                    maj_err(
                        <span style="color: #4ec9b0;">Maj</span>::string(
                            <span style="color: #ce9178;">"Index {} is out of bounds in {}"</span>),
                        <span style="color: #c586c0;">maj_list!</span>(pos, vec))
                } <span style="color: #569cd6;">else</span> {
                    s.borrow_mut().insert(index, val);
                    vec
                }
            },
            <span style="color: #4ec9b0;">MajVector</span>::<span style="color: #4ec9b0;">Any</span>(v) =&gt; {
                <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">len</span> = v.borrow().len();
                <span style="color: #569cd6;">if</span> index &gt; len {
                    maj_err(
                        <span style="color: #4ec9b0;">Maj</span>::string(
                            <span style="color: #ce9178;">"Index {} is out of bounds in {}"</span>),
                        <span style="color: #c586c0;">maj_list!</span>(pos, vec))
                } <span style="color: #569cd6;">else</span> {
                    v.borrow_mut().insert(index, x.clone());
                    vec
                }
            }
        }
    } <span style="color: #569cd6;">else</span> {
        <span style="color: #c586c0;">panic!</span>(<span style="color: #ce9178;">"vec-insert: Not a vector"</span>);
    }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgf8f51a5" class="outline-3">
<h3 id="orgf8f51a5"><span class="section-number-3">32.4.</span> <code>(vec-coerce vec type)</code></h3>
<div class="outline-text-3" id="text-32-4">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #569cd6;">fn</span> <span style="color: #dcdcaa;">sym_to_vectype</span>(<span style="color: #569cd6;">mut</span> <span style="color: #9cdcfe;">state</span>: <span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> <span style="color: #4ec9b0;">MajState</span>,
                  <span style="color: #9cdcfe;">vtype</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;) -&gt; <span style="color: #4ec9b0;">MajVectorType</span> {
    <span style="color: #569cd6;">if</span> maj_eq(vtype.clone(),
              <span style="color: #4ec9b0;">Maj</span>::symbol(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, <span style="color: #ce9178;">"integer"</span>)).to_bool() {
        <span style="color: #4ec9b0;">MajVectorType</span>::<span style="color: #4ec9b0;">Integer</span>
    } <span style="color: #569cd6;">else</span> <span style="color: #569cd6;">if</span> maj_eq(
        vtype.clone(),
        <span style="color: #4ec9b0;">Maj</span>::symbol(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, <span style="color: #ce9178;">"float"</span>)).to_bool() {
        <span style="color: #4ec9b0;">MajVectorType</span>::<span style="color: #4ec9b0;">Float</span>
    } <span style="color: #569cd6;">else</span> <span style="color: #569cd6;">if</span> maj_eq(
        vtype.clone(),
        <span style="color: #4ec9b0;">Maj</span>::symbol(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, <span style="color: #ce9178;">"char"</span>)).to_bool() {
        <span style="color: #4ec9b0;">MajVectorType</span>::<span style="color: #4ec9b0;">Char</span>
    } <span style="color: #569cd6;">else</span> {
        <span style="color: #4ec9b0;">MajVectorType</span>::<span style="color: #4ec9b0;">Any</span>
    }
}
</pre>
</div>

<div class="org-src-container">
<pre class="src src-rust"><span style="color: #569cd6;">pub</span> <span style="color: #569cd6;">fn</span> <span style="color: #dcdcaa;">maj_vec_coerce</span>(<span style="color: #569cd6;">mut</span> <span style="color: #9cdcfe;">state</span>: <span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> <span style="color: #4ec9b0;">MajState</span>,
                      <span style="color: #9cdcfe;">vtype</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;,
                      <span style="color: #9cdcfe;">vec</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;) -&gt; <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt; {
    <span style="color: #569cd6;">use</span> <span style="color: #569cd6;">crate</span>::<span style="color: #569cd6;">core</span>::<span style="color: #569cd6;">types</span>::<span style="color: #4ec9b0;">MajVector</span>;
    <span style="color: #569cd6;">if</span> !maj_vectorp(vec.clone()).to_bool() {
        <span style="color: #569cd6;">return</span> maj_err(
            <span style="color: #4ec9b0;">Maj</span>::string(<span style="color: #ce9178;">"{} is not a vector"</span>),
            <span style="color: #c586c0;">maj_list!</span>(vec));
    }
    <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">intended_type</span> = sym_to_vectype(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, vtype.clone());
    <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">newvec</span> = <span style="color: #4ec9b0;">Maj</span>::vector(intended_type);
    <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">is_any_intended</span> = maj_eq(vtype.clone(),
                                 <span style="color: #4ec9b0;">Maj</span>::symbol(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, <span style="color: #ce9178;">"any"</span>))
        .to_bool();

    <span style="color: #569cd6;">if</span> <span style="color: #569cd6;">let</span> <span style="color: #4ec9b0;">Maj</span>::<span style="color: #4ec9b0;">Vector</span>(v) = <span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span>*vec {
        <span style="color: #569cd6;">match</span> v {
            <span style="color: #4ec9b0;">MajVector</span>::<span style="color: #4ec9b0;">Integer</span>(v) =&gt; {
                <span style="color: #569cd6;">for</span> <span style="color: #9cdcfe;">n</span> <span style="color: #569cd6;">in</span> v.borrow().iter() {
                    <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">num</span> = <span style="color: #4ec9b0;">Maj</span>::integer(*n);
                    <span style="color: #569cd6;">if</span> !is_any_intended {
                        <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">num</span> = maj_number_coerce(
                            <span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, vtype.clone(), num.clone());
                        <span style="color: #569cd6;">if</span> maj_errorp(num.clone()).to_bool() {
                            <span style="color: #569cd6;">return</span> num;
                        }
                    }
                    <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">result</span> =
                        maj_vec_push(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state,
                                     num.clone(),
                                     newvec.clone());
                    <span style="color: #569cd6;">if</span> maj_errorp(result.clone()).to_bool() {
                        <span style="color: #569cd6;">return</span> result;
                    }
                }
            },
            <span style="color: #4ec9b0;">MajVector</span>::<span style="color: #4ec9b0;">Float</span>(v) =&gt; {
                <span style="color: #569cd6;">for</span> <span style="color: #9cdcfe;">n</span> <span style="color: #569cd6;">in</span> v.borrow().iter() {
                    <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">num</span> = <span style="color: #4ec9b0;">Maj</span>::float(*n);
                    <span style="color: #569cd6;">if</span> !is_any_intended {
                        <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">num</span> = maj_number_coerce(
                            <span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, vtype.clone(), num.clone());
                        <span style="color: #569cd6;">if</span> maj_errorp(num.clone()).to_bool() {
                            <span style="color: #569cd6;">return</span> num;
                        }
                    }
                    <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">result</span> =
                        maj_vec_push(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state,
                                     num.clone(),
                                     newvec.clone());
                    <span style="color: #569cd6;">if</span> maj_errorp(result.clone()).to_bool() {
                        <span style="color: #569cd6;">return</span> result;
                    }
                }
            },
            <span style="color: #4ec9b0;">MajVector</span>::<span style="color: #4ec9b0;">Char</span>(s) =&gt; {
                <span style="color: #569cd6;">for</span> <span style="color: #9cdcfe;">c</span> <span style="color: #569cd6;">in</span> s.borrow().chars() {
                    <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">result</span> =
                        maj_vec_push(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state,
                                     <span style="color: #4ec9b0;">Maj</span>::character(c),
                                     newvec.clone());
                    <span style="color: #569cd6;">if</span> maj_errorp(result.clone()).to_bool() {
                        <span style="color: #569cd6;">return</span> result;
                    }
                }
            },
            <span style="color: #4ec9b0;">MajVector</span>::<span style="color: #4ec9b0;">Any</span>(v) =&gt; {
                <span style="color: #569cd6;">for</span> <span style="color: #9cdcfe;">elt</span> <span style="color: #569cd6;">in</span> v.borrow().iter() {
                    <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">result</span> =
                        maj_vec_push(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state,
                                     elt.clone(),
                                     newvec.clone());
                    <span style="color: #569cd6;">if</span> maj_errorp(result.clone()).to_bool() {
                        <span style="color: #569cd6;">return</span> result;
                    }
                }
            }
        }
    } <span style="color: #569cd6;">else</span> {
        <span style="color: #c586c0;">panic!</span>(<span style="color: #ce9178;">"vec-coerce: Not a vector"</span>);
    }
    newvec
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org95912f7" class="outline-3">
<h3 id="org95912f7"><span class="section-number-3">32.5.</span> <code>(vector . rest)</code></h3>
<div class="outline-text-3" id="text-32-5">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #569cd6;">fn</span> <span style="color: #dcdcaa;">vectype_compatible</span>(<span style="color: #569cd6;">mut</span> <span style="color: #9cdcfe;">state</span>: <span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> <span style="color: #4ec9b0;">MajState</span>,
                      <span style="color: #9cdcfe;">vtype</span>: <span style="color: #4ec9b0;">MajVectorType</span>,
                      <span style="color: #9cdcfe;">xtype</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;) -&gt; <span style="color: #4ec9b0;">bool</span> {
    <span style="color: #569cd6;">match</span> vtype {
        <span style="color: #4ec9b0;">MajVectorType</span>::<span style="color: #4ec9b0;">Any</span> =&gt; <span style="color: #569cd6;">true</span>,
        <span style="color: #4ec9b0;">MajVectorType</span>::<span style="color: #4ec9b0;">Integer</span> =&gt;
            maj_eq(xtype,
                   <span style="color: #4ec9b0;">Maj</span>::symbol(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, <span style="color: #ce9178;">"integer"</span>))
            .to_bool(),
        <span style="color: #4ec9b0;">MajVectorType</span>::<span style="color: #4ec9b0;">Float</span> =&gt;
            maj_eq(xtype,
                   <span style="color: #4ec9b0;">Maj</span>::symbol(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, <span style="color: #ce9178;">"float"</span>))
            .to_bool(),
        <span style="color: #4ec9b0;">MajVectorType</span>::<span style="color: #4ec9b0;">Char</span> =&gt;
            maj_eq(xtype,
                   <span style="color: #4ec9b0;">Maj</span>::symbol(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, <span style="color: #ce9178;">"char"</span>))
            .to_bool(),
    }
}
</pre>
</div>

<div class="org-src-container">
<pre class="src src-rust"><span style="color: #569cd6;">fn</span> <span style="color: #dcdcaa;">best_vectype</span>(<span style="color: #569cd6;">mut</span> <span style="color: #9cdcfe;">state</span>: <span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> <span style="color: #4ec9b0;">MajState</span>,
                <span style="color: #9cdcfe;">xtype</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;) -&gt; <span style="color: #4ec9b0;">MajVectorType</span> {
    <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">integer</span> = <span style="color: #4ec9b0;">Maj</span>::symbol(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, <span style="color: #ce9178;">"integer"</span>);
    <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">float</span>   = <span style="color: #4ec9b0;">Maj</span>::symbol(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, <span style="color: #ce9178;">"float"</span>);
    <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">charsym</span> = <span style="color: #4ec9b0;">Maj</span>::symbol(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, <span style="color: #ce9178;">"char"</span>);
    
    <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">sym</span> =
        <span style="color: #569cd6;">if</span> maj_eq(xtype.clone(), integer).to_bool()
        || maj_eq(xtype.clone(), float).to_bool()
        || maj_eq(xtype.clone(), charsym).to_bool() {
            xtype
        } <span style="color: #569cd6;">else</span> {
            <span style="color: #4ec9b0;">Maj</span>::symbol(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, <span style="color: #ce9178;">"any"</span>)
        };
    sym_to_vectype(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, sym)
}
</pre>
</div>

<div class="org-src-container">
<pre class="src src-rust"><span style="color: #569cd6;">pub</span> <span style="color: #569cd6;">fn</span> <span style="color: #dcdcaa;">maj_vector</span>(<span style="color: #569cd6;">mut</span> <span style="color: #9cdcfe;">state</span>: <span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> <span style="color: #4ec9b0;">MajState</span>, <span style="color: #9cdcfe;">rest</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;) -&gt; <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt; {
    <span style="color: #569cd6;">if</span> maj_nilp(rest.clone()).to_bool() {
        <span style="color: #4ec9b0;">Maj</span>::vector(<span style="color: #4ec9b0;">MajVectorType</span>::<span style="color: #4ec9b0;">Any</span>)
    } <span style="color: #569cd6;">else</span> {
        <span style="color: #569cd6;">let</span> <span style="color: #569cd6;">mut</span> <span style="color: #9cdcfe;">iter</span> = rest.clone();

        <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">first</span> = maj_car(iter.clone());
        <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">fsttype</span> = maj_type(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, first);
        <span style="color: #569cd6;">let</span> <span style="color: #569cd6;">mut</span> <span style="color: #9cdcfe;">vector</span> = <span style="color: #4ec9b0;">Maj</span>::vector(
            best_vectype(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, fsttype));

        <span style="color: #569cd6;">while</span> !maj_nilp(iter.clone()).to_bool() {
            <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">first</span> = maj_car(iter.clone());
            <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">fsttype</span> = maj_type(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, first.clone());

            <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">vtype</span> = maj_vec_type(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, vector.clone());
            <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">vtype</span> = sym_to_vectype(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, vtype);

            <span style="color: #569cd6;">if</span> !vectype_compatible(
                <span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, vtype, fsttype) {
                <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">any</span> = <span style="color: #4ec9b0;">Maj</span>::symbol(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, <span style="color: #ce9178;">"any"</span>);
                vector = maj_vec_coerce(
                    <span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, any, vector);
                <span style="color: #569cd6;">if</span> maj_errorp(vector.clone()).to_bool() {
                    <span style="color: #569cd6;">return</span> vector;
                }
            }
            <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">res</span> =
                maj_vec_push(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, first, vector.clone());
            <span style="color: #569cd6;">if</span> maj_errorp(res.clone()).to_bool() {
                <span style="color: #569cd6;">return</span> res;
            }
            iter = maj_cdr(iter);
        }
        vector
    }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgf5a691b" class="outline-3">
<h3 id="orgf5a691b"><span class="section-number-3">32.6.</span> <code>(vec-length vec)</code></h3>
<div class="outline-text-3" id="text-32-6">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #569cd6;">pub</span> <span style="color: #569cd6;">fn</span> <span style="color: #dcdcaa;">maj_vec_length</span>(<span style="color: #9cdcfe;">vec</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;) -&gt; <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt; {
    <span style="color: #569cd6;">use</span> <span style="color: #569cd6;">crate</span>::<span style="color: #569cd6;">core</span>::<span style="color: #569cd6;">types</span>::<span style="color: #4ec9b0;">MajVector</span>;
    <span style="color: #569cd6;">if</span> <span style="color: #569cd6;">let</span> <span style="color: #4ec9b0;">Maj</span>::<span style="color: #4ec9b0;">Vector</span>(v) = <span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span>*vec.clone() {
        <span style="color: #4ec9b0;">Maj</span>::integer(
            <span style="color: #569cd6;">match</span> v {
                <span style="color: #4ec9b0;">MajVector</span>::<span style="color: #4ec9b0;">Integer</span>(v) =&gt; v.borrow().len(),
                <span style="color: #4ec9b0;">MajVector</span>::<span style="color: #4ec9b0;">Float</span>(v) =&gt; v.borrow().len(),
                <span style="color: #4ec9b0;">MajVector</span>::<span style="color: #4ec9b0;">Char</span>(s) =&gt; s.borrow().chars().count(),
                <span style="color: #4ec9b0;">MajVector</span>::<span style="color: #4ec9b0;">Any</span>(v) =&gt; v.borrow().len(),
            } <span style="color: #569cd6;">as</span> <span style="color: #4ec9b0;">i64</span>)
    } <span style="color: #569cd6;">else</span> {
        maj_err(
            <span style="color: #4ec9b0;">Maj</span>::string(<span style="color: #ce9178;">"{} is not a vector"</span>),
            <span style="color: #c586c0;">maj_list!</span>(vec))
    }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org26b724f" class="outline-3">
<h3 id="org26b724f"><span class="section-number-3">32.7.</span> <code>(vec-pop vec)</code></h3>
<div class="outline-text-3" id="text-32-7">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #569cd6;">pub</span> <span style="color: #569cd6;">fn</span> <span style="color: #dcdcaa;">maj_vec_pop</span>(<span style="color: #9cdcfe;">vec</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;) -&gt; <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt; {
    <span style="color: #569cd6;">use</span> <span style="color: #569cd6;">crate</span>::<span style="color: #569cd6;">core</span>::<span style="color: #569cd6;">types</span>::<span style="color: #4ec9b0;">MajVector</span>;
    <span style="color: #569cd6;">if</span> <span style="color: #569cd6;">let</span> <span style="color: #4ec9b0;">Maj</span>::<span style="color: #4ec9b0;">Vector</span>(vv) = <span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span>*vec.clone() {
        <span style="color: #569cd6;">match</span> vv {
            <span style="color: #4ec9b0;">MajVector</span>::<span style="color: #4ec9b0;">Integer</span>(v) =&gt; {
                <span style="color: #569cd6;">match</span> v.borrow_mut().pop() {
                    <span style="color: #4ec9b0;">Some</span>(val) =&gt; <span style="color: #4ec9b0;">Maj</span>::integer(val),
                    <span style="color: #4ec9b0;">None</span> =&gt; <span style="color: #4ec9b0;">Maj</span>::nil(),
                }
            },
            <span style="color: #4ec9b0;">MajVector</span>::<span style="color: #4ec9b0;">Float</span>(v) =&gt; {
                <span style="color: #569cd6;">match</span> v.borrow_mut().pop() {
                    <span style="color: #4ec9b0;">Some</span>(val) =&gt; <span style="color: #4ec9b0;">Maj</span>::float(val),
                    <span style="color: #4ec9b0;">None</span> =&gt; <span style="color: #4ec9b0;">Maj</span>::nil(),
                }
            },
            <span style="color: #4ec9b0;">MajVector</span>::<span style="color: #4ec9b0;">Char</span>(s) =&gt; {
                <span style="color: #569cd6;">match</span> s.borrow_mut().pop() {
                    <span style="color: #4ec9b0;">Some</span>(val) =&gt; <span style="color: #4ec9b0;">Maj</span>::character(val),
                    <span style="color: #4ec9b0;">None</span> =&gt; <span style="color: #4ec9b0;">Maj</span>::nil(),
                }
            },
            <span style="color: #4ec9b0;">MajVector</span>::<span style="color: #4ec9b0;">Any</span>(v) =&gt; {
                <span style="color: #569cd6;">match</span> v.borrow_mut().pop() {
                    <span style="color: #4ec9b0;">Some</span>(val) =&gt; val,
                    <span style="color: #4ec9b0;">None</span> =&gt; <span style="color: #4ec9b0;">Maj</span>::nil(),
                }
            }
        }
    } <span style="color: #569cd6;">else</span> {
        maj_err(
            <span style="color: #4ec9b0;">Maj</span>::string(<span style="color: #ce9178;">"{} is not a vector"</span>),
            <span style="color: #c586c0;">maj_list!</span>(vec))
    }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgd8d5a46" class="outline-3">
<h3 id="orgd8d5a46"><span class="section-number-3">32.8.</span> <code>(vec-deq vec)</code></h3>
<div class="outline-text-3" id="text-32-8">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #569cd6;">pub</span> <span style="color: #569cd6;">fn</span> <span style="color: #dcdcaa;">maj_vec_deq</span>(<span style="color: #9cdcfe;">vec</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;) -&gt; <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt; {
    <span style="color: #569cd6;">use</span> <span style="color: #569cd6;">crate</span>::<span style="color: #569cd6;">core</span>::<span style="color: #569cd6;">types</span>::<span style="color: #4ec9b0;">MajVector</span>;
    <span style="color: #569cd6;">if</span> <span style="color: #569cd6;">let</span> <span style="color: #4ec9b0;">Maj</span>::<span style="color: #4ec9b0;">Vector</span>(vv) = <span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span>*vec.clone() {
        <span style="color: #569cd6;">match</span> vv {
            <span style="color: #4ec9b0;">MajVector</span>::<span style="color: #4ec9b0;">Integer</span>(v) =&gt; {
                <span style="color: #569cd6;">if</span> v.borrow().is_empty() {
                    <span style="color: #4ec9b0;">Maj</span>::nil()
                } <span style="color: #569cd6;">else</span> {
                    <span style="color: #4ec9b0;">Maj</span>::integer(
                        v.borrow_mut().remove(0))
                }
            },
            <span style="color: #4ec9b0;">MajVector</span>::<span style="color: #4ec9b0;">Float</span>(v) =&gt; {
                <span style="color: #569cd6;">if</span> v.borrow().is_empty() {
                    <span style="color: #4ec9b0;">Maj</span>::nil()
                } <span style="color: #569cd6;">else</span> {
                    <span style="color: #4ec9b0;">Maj</span>::float(
                        v.borrow_mut().remove(0))
                }
            },
            <span style="color: #4ec9b0;">MajVector</span>::<span style="color: #4ec9b0;">Char</span>(s) =&gt; {
                <span style="color: #569cd6;">if</span> s.borrow().is_empty() {
                    <span style="color: #4ec9b0;">Maj</span>::nil()
                } <span style="color: #569cd6;">else</span> {
                    <span style="color: #4ec9b0;">Maj</span>::character(
                        s.borrow_mut().remove(0))
                }
            },
            <span style="color: #4ec9b0;">MajVector</span>::<span style="color: #4ec9b0;">Any</span>(v) =&gt; {
                <span style="color: #569cd6;">if</span> v.borrow().is_empty() {
                    <span style="color: #4ec9b0;">Maj</span>::nil()
                } <span style="color: #569cd6;">else</span> {
                    v.borrow_mut().remove(0)
                }
            }
        }
    } <span style="color: #569cd6;">else</span> {
        maj_err(
            <span style="color: #4ec9b0;">Maj</span>::string(<span style="color: #ce9178;">"{} is not a vector"</span>),
            <span style="color: #c586c0;">maj_list!</span>(vec))
    }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org212cdde" class="outline-3">
<h3 id="org212cdde"><span class="section-number-3">32.9.</span> <code>(vec-at x vec)</code></h3>
<div class="outline-text-3" id="text-32-9">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #569cd6;">pub</span> <span style="color: #569cd6;">fn</span> <span style="color: #dcdcaa;">maj_vec_at</span>(<span style="color: #9cdcfe;">x</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;, <span style="color: #9cdcfe;">vec</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;) -&gt; <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt; {
    <span style="color: #569cd6;">use</span> <span style="color: #569cd6;">crate</span>::<span style="color: #569cd6;">core</span>::<span style="color: #569cd6;">types</span>::<span style="color: #4ec9b0;">MajVector</span>;
    <span style="color: #569cd6;">use</span> <span style="color: #569cd6;">crate</span>::<span style="color: #569cd6;">axioms</span>::<span style="color: #569cd6;">predicates</span>::maj_integerp;

    <span style="color: #569cd6;">if</span> !maj_integerp(x.clone()).to_bool() {
        <span style="color: #569cd6;">return</span> maj_err(
            <span style="color: #4ec9b0;">Maj</span>::string(<span style="color: #ce9178;">"{} is not an integer"</span>),
            <span style="color: #c586c0;">maj_list!</span>(x));
    }

    <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">index</span> = x.to_integer().unwrap() <span style="color: #569cd6;">as</span> <span style="color: #4ec9b0;">usize</span>;

    <span style="color: #569cd6;">if</span> <span style="color: #569cd6;">let</span> <span style="color: #4ec9b0;">Maj</span>::<span style="color: #4ec9b0;">Vector</span>(vv) = <span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span>*vec.clone() {
        <span style="color: #569cd6;">match</span> vv {
            <span style="color: #4ec9b0;">MajVector</span>::<span style="color: #4ec9b0;">Integer</span>(v) =&gt; {
                <span style="color: #569cd6;">match</span> v.borrow().get(index) {
                    <span style="color: #4ec9b0;">Some</span>(val) =&gt; <span style="color: #4ec9b0;">Maj</span>::integer(*val),
                    <span style="color: #4ec9b0;">None</span> =&gt; maj_err(
                        <span style="color: #4ec9b0;">Maj</span>::string(<span style="color: #ce9178;">"Index {} is out of bounds in {}"</span>),
                        <span style="color: #c586c0;">maj_list!</span>(x.clone(), vec)),
                }
            },
            <span style="color: #4ec9b0;">MajVector</span>::<span style="color: #4ec9b0;">Float</span>(v) =&gt; {
                <span style="color: #569cd6;">match</span> v.borrow().get(index) {
                    <span style="color: #4ec9b0;">Some</span>(val) =&gt; <span style="color: #4ec9b0;">Maj</span>::float(*val),
                    <span style="color: #4ec9b0;">None</span> =&gt; maj_err(
                        <span style="color: #4ec9b0;">Maj</span>::string(<span style="color: #ce9178;">"Index {} is out of bounds in {}"</span>),
                        <span style="color: #c586c0;">maj_list!</span>(x.clone(), vec)),
                }
            },
            <span style="color: #4ec9b0;">MajVector</span>::<span style="color: #4ec9b0;">Char</span>(s) =&gt; {
                <span style="color: #569cd6;">match</span> s.borrow().chars().nth(index) {
                    <span style="color: #4ec9b0;">Some</span>(val) =&gt; <span style="color: #4ec9b0;">Maj</span>::character(val),
                    <span style="color: #4ec9b0;">None</span> =&gt; maj_err(
                        <span style="color: #4ec9b0;">Maj</span>::string(<span style="color: #ce9178;">"Index {} is out of bounds in {}"</span>),
                        <span style="color: #c586c0;">maj_list!</span>(x.clone(), vec)),
                }
            },
            <span style="color: #4ec9b0;">MajVector</span>::<span style="color: #4ec9b0;">Any</span>(v) =&gt; {
                <span style="color: #569cd6;">match</span> v.borrow().get(index) {
                    <span style="color: #4ec9b0;">Some</span>(val) =&gt; val.clone(),
                    <span style="color: #4ec9b0;">None</span> =&gt; maj_err(
                        <span style="color: #4ec9b0;">Maj</span>::string(<span style="color: #ce9178;">"Index {} is out of bounds in {}"</span>),
                        <span style="color: #c586c0;">maj_list!</span>(x.clone(), vec)),
                }
            }
        }
    } <span style="color: #569cd6;">else</span> {
        maj_err(
            <span style="color: #4ec9b0;">Maj</span>::string(<span style="color: #ce9178;">"{} is not a vector"</span>),
            <span style="color: #c586c0;">maj_list!</span>(vec))
    }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orga58bee7" class="outline-3">
<h3 id="orga58bee7"><span class="section-number-3">32.10.</span> <code>(vec-set pos x vec)</code></h3>
<div class="outline-text-3" id="text-32-10">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #569cd6;">fn</span> <span style="color: #dcdcaa;">replace_string_char</span>(<span style="color: #9cdcfe;">strn</span>: <span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> <span style="color: #4ec9b0;">String</span>, <span style="color: #9cdcfe;">index</span>: <span style="color: #4ec9b0;">usize</span>, <span style="color: #9cdcfe;">rep</span>: <span style="color: #4ec9b0;">char</span>) {
    <span style="color: #569cd6;">let</span> <span style="color: #569cd6;">mut</span> <span style="color: #9cdcfe;">vec</span> = strn.chars().collect::&lt;<span style="color: #4ec9b0;">Vec</span>&lt;_&gt;&gt;();
    vec[index] = rep;
    *strn = vec.iter().collect::&lt;<span style="color: #4ec9b0;">String</span>&gt;();
}
</pre>
</div>

<div class="org-src-container">
<pre class="src src-rust"><span style="color: #569cd6;">pub</span> <span style="color: #569cd6;">fn</span> <span style="color: #dcdcaa;">maj_vec_set</span>(
    <span style="color: #9cdcfe;">pos</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;, <span style="color: #9cdcfe;">x</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;, <span style="color: #9cdcfe;">vec</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;
) -&gt; <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt; {
    <span style="color: #569cd6;">use</span> <span style="color: #569cd6;">crate</span>::<span style="color: #569cd6;">core</span>::<span style="color: #569cd6;">types</span>::<span style="color: #4ec9b0;">MajVector</span>;
    <span style="color: #569cd6;">use</span> <span style="color: #569cd6;">crate</span>::<span style="color: #569cd6;">axioms</span>::<span style="color: #569cd6;">predicates</span>::{
        maj_integerp,
        maj_floatp,
        maj_charp
    };
    <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">index</span> =
        <span style="color: #569cd6;">match</span> pos.clone().to_integer() {
            <span style="color: #4ec9b0;">Some</span>(x) =&gt; {
                <span style="color: #569cd6;">if</span> x &lt; 0 {
                    <span style="color: #569cd6;">return</span> maj_err(
                        <span style="color: #4ec9b0;">Maj</span>::string(
                            <span style="color: #ce9178;">"Index {} is out of bounds in {}"</span>),
                        <span style="color: #c586c0;">maj_list!</span>(pos, vec));
                }
                x <span style="color: #569cd6;">as</span> <span style="color: #4ec9b0;">usize</span>
            },
            <span style="color: #4ec9b0;">None</span> =&gt; {
                <span style="color: #569cd6;">return</span> maj_err(
                    <span style="color: #4ec9b0;">Maj</span>::string(<span style="color: #ce9178;">"{} is not an integer"</span>),
                    <span style="color: #c586c0;">maj_list!</span>(pos));
            },
        };

    <span style="color: #569cd6;">if</span> <span style="color: #569cd6;">let</span> <span style="color: #4ec9b0;">Maj</span>::<span style="color: #4ec9b0;">Vector</span>(vv) = <span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span>*vec.clone() {
        <span style="color: #569cd6;">match</span> vv {
            <span style="color: #4ec9b0;">MajVector</span>::<span style="color: #4ec9b0;">Integer</span>(v) =&gt; {
                <span style="color: #569cd6;">if</span> !maj_integerp(x.clone()).to_bool() {
                    <span style="color: #569cd6;">return</span> maj_err(
                        <span style="color: #4ec9b0;">Maj</span>::string(
                            <span style="color: #ce9178;">"{} is not type-compatible with vector {}"</span>),
                        <span style="color: #c586c0;">maj_list!</span>(x.clone(), vec.clone()));
                }
                <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">x</span> = x.to_integer().unwrap();
                <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">len</span> = v.borrow().len();
                <span style="color: #569cd6;">if</span> index &gt;= len {
                    maj_err(
                        <span style="color: #4ec9b0;">Maj</span>::string(<span style="color: #ce9178;">"Index {} is out of bounds in {}"</span>),
                        <span style="color: #c586c0;">maj_list!</span>(pos, vec))
                } <span style="color: #569cd6;">else</span> {
                    v.borrow_mut()[index] = x;
                    vec
                }
            },
            <span style="color: #4ec9b0;">MajVector</span>::<span style="color: #4ec9b0;">Float</span>(v) =&gt; {
                <span style="color: #569cd6;">if</span>!maj_floatp(x.clone()).to_bool() {
                    <span style="color: #569cd6;">return</span> maj_err(
                        <span style="color: #4ec9b0;">Maj</span>::string(
                            <span style="color: #ce9178;">"{} is not type-compatible with vector {}"</span>),
                        <span style="color: #c586c0;">maj_list!</span>(x.clone(), vec.clone()));
                }
                <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">x</span> = x.to_float().unwrap();
                <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">len</span> = v.borrow().len();
                <span style="color: #569cd6;">if</span> index &gt;= len {
                    maj_err(
                        <span style="color: #4ec9b0;">Maj</span>::string(<span style="color: #ce9178;">"Index {} is out of bounds in {}"</span>),
                        <span style="color: #c586c0;">maj_list!</span>(pos, vec))
                } <span style="color: #569cd6;">else</span> {
                    v.borrow_mut()[index] = x;
                    vec
                }
            },
            <span style="color: #4ec9b0;">MajVector</span>::<span style="color: #4ec9b0;">Char</span>(s) =&gt; {
                <span style="color: #569cd6;">if</span>!maj_charp(x.clone()).to_bool() {
                    maj_err(
                        <span style="color: #4ec9b0;">Maj</span>::string(
                            <span style="color: #ce9178;">"{} is not type-compatible with vector {}"</span>),
                        <span style="color: #c586c0;">maj_list!</span>(x.clone(), vec.clone()));
                }
                <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">c</span> = x.clone().to_char().unwrap();
                <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">len</span> = s.borrow().len();
                <span style="color: #569cd6;">if</span> index &gt;= len {
                    maj_err(
                        <span style="color: #4ec9b0;">Maj</span>::string(<span style="color: #ce9178;">"Index {} is out of bounds in {}"</span>),
                        <span style="color: #c586c0;">maj_list!</span>(pos, vec))
                } <span style="color: #569cd6;">else</span> {
                    replace_string_char(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> s.borrow_mut(), index, c);
                    vec
                }
            },
            <span style="color: #4ec9b0;">MajVector</span>::<span style="color: #4ec9b0;">Any</span>(v) =&gt; {
                <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">len</span> = v.borrow().len();
                <span style="color: #569cd6;">if</span> index &gt;= len {
                    <span style="color: #569cd6;">return</span> maj_err(
                        <span style="color: #4ec9b0;">Maj</span>::string(<span style="color: #ce9178;">"Index {} is out of bounds in {}"</span>),
                        <span style="color: #c586c0;">maj_list!</span>(pos, vec))
                } <span style="color: #569cd6;">else</span> {
                    v.borrow_mut()[index] = x.clone();
                    vec
                }
            },
        }
    } <span style="color: #569cd6;">else</span> {
        maj_err(
            <span style="color: #4ec9b0;">Maj</span>::string(<span style="color: #ce9178;">"{} is not a vector"</span>),
            <span style="color: #c586c0;">maj_list!</span>(vec))
    }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org67d495f" class="outline-3">
<h3 id="org67d495f"><span class="section-number-3">32.11.</span> <code>(vec-remove vec pos)</code></h3>
<div class="outline-text-3" id="text-32-11">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #569cd6;">pub</span> <span style="color: #569cd6;">fn</span> <span style="color: #dcdcaa;">maj_vec_remove</span>(<span style="color: #9cdcfe;">pos</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;, <span style="color: #9cdcfe;">vec</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;) -&gt; <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt; {
    <span style="color: #569cd6;">use</span> <span style="color: #569cd6;">crate</span>::<span style="color: #569cd6;">core</span>::<span style="color: #569cd6;">types</span>::<span style="color: #4ec9b0;">MajVector</span>;
    <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">index</span> =
        <span style="color: #569cd6;">match</span> pos.clone().to_integer() {
            <span style="color: #4ec9b0;">Some</span>(x) =&gt; {
                <span style="color: #569cd6;">if</span> x &lt; 0 {
                    <span style="color: #569cd6;">return</span> maj_err(
                        <span style="color: #4ec9b0;">Maj</span>::string(
                            <span style="color: #ce9178;">"Index {} is out of bounds in {}"</span>),
                        <span style="color: #c586c0;">maj_list!</span>(pos, vec));
                }
                x <span style="color: #569cd6;">as</span> <span style="color: #4ec9b0;">usize</span>
            },
            <span style="color: #4ec9b0;">None</span> =&gt; {
                <span style="color: #569cd6;">return</span> maj_err(
                    <span style="color: #4ec9b0;">Maj</span>::string(<span style="color: #ce9178;">"{} is not an integer"</span>),
                    <span style="color: #c586c0;">maj_list!</span>(pos));
            },
        };
    <span style="color: #569cd6;">if</span> <span style="color: #569cd6;">let</span> <span style="color: #4ec9b0;">Maj</span>::<span style="color: #4ec9b0;">Vector</span>(vv) = <span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span>*vec {
        <span style="color: #569cd6;">match</span> vv {
            <span style="color: #4ec9b0;">MajVector</span>::<span style="color: #4ec9b0;">Integer</span>(v) =&gt; {
                <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">len</span> = v.borrow().len();
                <span style="color: #569cd6;">if</span> index &gt;= len {
                    maj_err(
                        <span style="color: #4ec9b0;">Maj</span>::string(
                            <span style="color: #ce9178;">"Index {} is out of bounds in {}"</span>),
                        <span style="color: #c586c0;">maj_list!</span>(pos, vec))
                } <span style="color: #569cd6;">else</span> {
                    <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">value</span> = v.borrow_mut().remove(index);
                    <span style="color: #4ec9b0;">Maj</span>::integer(value)
                }
            },
            <span style="color: #4ec9b0;">MajVector</span>::<span style="color: #4ec9b0;">Float</span>(v) =&gt; {
                <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">len</span> = v.borrow().len();
                <span style="color: #569cd6;">if</span> index &gt;= len {
                    maj_err(
                        <span style="color: #4ec9b0;">Maj</span>::string(
                            <span style="color: #ce9178;">"Index {} is out of bounds in {}"</span>),
                        <span style="color: #c586c0;">maj_list!</span>(pos, vec))
                } <span style="color: #569cd6;">else</span> {
                    <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">value</span> = v.borrow_mut().remove(index);
                    <span style="color: #4ec9b0;">Maj</span>::float(value)
                }
            },
            <span style="color: #4ec9b0;">MajVector</span>::<span style="color: #4ec9b0;">Char</span>(s) =&gt; {
                <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">len</span> = s.borrow().chars().count();
                <span style="color: #569cd6;">if</span> index &gt;= len {
                    maj_err(
                        <span style="color: #4ec9b0;">Maj</span>::string(
                            <span style="color: #ce9178;">"Index {} is out of bounds in {}"</span>),
                        <span style="color: #c586c0;">maj_list!</span>(pos, vec))
                } <span style="color: #569cd6;">else</span> {
                    <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">value</span> = s.borrow_mut().remove(index);
                    <span style="color: #4ec9b0;">Maj</span>::character(value)
                }
            },
            <span style="color: #4ec9b0;">MajVector</span>::<span style="color: #4ec9b0;">Any</span>(v) =&gt; {
                <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">len</span> = v.borrow().len();
                <span style="color: #569cd6;">if</span> index &gt;= len {
                    maj_err(
                        <span style="color: #4ec9b0;">Maj</span>::string(
                            <span style="color: #ce9178;">"Index {} is out of bounds in {}"</span>),
                        <span style="color: #c586c0;">maj_list!</span>(pos, vec))
                } <span style="color: #569cd6;">else</span> {
                    v.borrow_mut().remove(index)
                }
            },
        }
    } <span style="color: #569cd6;">else</span> {
        maj_err(<span style="color: #4ec9b0;">Maj</span>::string(<span style="color: #ce9178;">"{} is not a vector"</span>),
                <span style="color: #c586c0;">maj_list!</span>(vec))
    }
}
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org2f40199" class="outline-2">
<h2 id="org2f40199"><span class="section-number-2">33.</span> Funções customizadas</h2>
<div class="outline-text-2" id="text-33">
</div>
<div id="outline-container-orgc4e8ef5" class="outline-3">
<h3 id="orgc4e8ef5"><span class="section-number-3">33.1.</span> <code>(gc)</code></h3>
<div class="outline-text-3" id="text-33-1">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #569cd6;">pub</span> <span style="color: #569cd6;">fn</span> <span style="color: #dcdcaa;">maj_gc</span>() -&gt; <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt; {
    <span style="color: #569cd6;">use</span> <span style="color: #569cd6;">gc</span>::force_collect;
    force_collect();
    <span style="color: #4ec9b0;">Maj</span>::nil()
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org53d9558" class="outline-3">
<h3 id="org53d9558"><span class="section-number-3">33.2.</span> <code>(print-env type)</code></h3>
<div class="outline-text-3" id="text-33-2">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #569cd6;">fn</span> <span style="color: #dcdcaa;">maj_print_env</span>(
    <span style="color: #569cd6;">mut</span> <span style="color: #9cdcfe;">state</span>: <span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> <span style="color: #4ec9b0;">MajState</span>,
    <span style="color: #9cdcfe;">args</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;,
    <span style="color: #9cdcfe;">env</span>: <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt;
) -&gt; <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt; {
    <span style="color: #569cd6;">use</span> <span style="color: #569cd6;">crate</span>::<span style="color: #569cd6;">printing</span>::maj_format_env;
    <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">is_global</span> =
        maj_eq(maj_car(args.clone()),
               <span style="color: #4ec9b0;">Maj</span>::symbol(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, <span style="color: #ce9178;">"global"</span>))
        .to_bool();
    <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">is_lexical</span> =
        maj_eq(maj_car(args.clone()),
               <span style="color: #4ec9b0;">Maj</span>::symbol(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, <span style="color: #ce9178;">"lexical"</span>))
        .to_bool();

    <span style="color: #569cd6;">if</span> is_global {
        <span style="color: #c586c0;">println!</span>(<span style="color: #ce9178;">"</span><span style="color: #ce9178; font-style: italic;">{}</span><span style="color: #ce9178;">"</span>, state);
        <span style="color: #4ec9b0;">Maj</span>::nil()
    } <span style="color: #569cd6;">else</span> <span style="color: #569cd6;">if</span> is_lexical {
        <span style="color: #c586c0;">println!</span>(<span style="color: #ce9178;">"</span><span style="color: #ce9178; font-style: italic;">{}</span><span style="color: #ce9178;">"</span>, maj_format_env(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span>state, env));
        <span style="color: #4ec9b0;">Maj</span>::nil()
    } <span style="color: #569cd6;">else</span> {
        maj_err(<span style="color: #4ec9b0;">Maj</span>::string(<span style="color: #ce9178;">"Unknown environment type {}"</span>),
                <span style="color: #c586c0;">maj_list!</span>(maj_car(args)))
    }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org425fb20" class="outline-3">
<h3 id="org425fb20"><span class="section-number-3">33.3.</span> <code>(stack-state)</code></h3>
<div class="outline-text-3" id="text-33-3">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #569cd6;">fn</span> <span style="color: #dcdcaa;">maj_stack_state</span>() -&gt; <span style="color: #4ec9b0;">Gc</span>&lt;<span style="color: #4ec9b0;">Maj</span>&gt; {
    <span style="color: #569cd6;">match</span> <span style="color: #569cd6;">stacker</span>::remaining_stack() {
        <span style="color: #4ec9b0;">Some</span>(n) =&gt; {
            <span style="color: #c586c0;">println!</span>(<span style="color: #ce9178;">"Remaining stack: </span><span style="color: #ce9178; font-style: italic;">{}</span><span style="color: #ce9178;">B (roughly </span><span style="color: #ce9178; font-style: italic;">{}</span><span style="color: #ce9178;">KB)"</span>,
                     n, n / 1024);
            <span style="color: #569cd6;">use</span> <span style="color: #569cd6;">std</span>::<span style="color: #569cd6;">convert</span>::<span style="color: #4ec9b0;">TryInto</span>;
            <span style="color: #569cd6;">match</span> n.try_into() {
                <span style="color: #4ec9b0;">Ok</span>(n) =&gt; <span style="color: #4ec9b0;">Maj</span>::integer(n),
                <span style="color: #4ec9b0;">Err</span>(_) =&gt; <span style="color: #4ec9b0;">Maj</span>::t()
            }
        },
        <span style="color: #4ec9b0;">None</span> =&gt; {
            <span style="color: #c586c0;">println!</span>(<span style="color: #ce9178;">"Couldn't query stack state"</span>);
            <span style="color: #4ec9b0;">Maj</span>::nil()
        }
    }
}
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org8f8802f" class="outline-2">
<h2 id="org8f8802f"><span class="section-number-2">34.</span> Registro em contexto global</h2>
<div class="outline-text-2" id="text-34">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #569cd6;">pub</span> <span style="color: #569cd6;">fn</span> <span style="color: #dcdcaa;">maj_gen_primitives</span>(<span style="color: #9cdcfe;">state</span>: <span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> <span style="color: #4ec9b0;">MajState</span>) {
    <span style="color: #569cd6;">use</span> <span style="color: #569cd6;">crate</span>::<span style="color: #569cd6;">axioms</span>::{ <span style="color: #4ec9b0;">MajPrimFn</span>, <span style="color: #4ec9b0;">MajPrimArgs</span> };
    <span style="color: #569cd6;">let</span> <span style="color: #9cdcfe;">primitives</span>: <span style="color: #4ec9b0;">Vec</span>&lt;(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #4ec9b0;">str</span>, <span style="color: #4ec9b0;">MajPrimArgs</span>, <span style="color: #4ec9b0;">MajPrimFn</span>)&gt; = <span style="color: #c586c0;">vec!</span>[
        (<span style="color: #ce9178;">"cons"</span>, <span style="color: #4ec9b0;">MajPrimArgs</span>::<span style="color: #4ec9b0;">Required</span>(2), |_, args, _| {
            <span style="color: #c586c0;">maj_destructure_args!</span>(args, first, rest, second);
            maj_cons(first, second)
        }),
        (<span style="color: #ce9178;">"car"</span>, <span style="color: #4ec9b0;">MajPrimArgs</span>::<span style="color: #4ec9b0;">Required</span>(1), |_, args, _| {
            <span style="color: #c586c0;">maj_destructure_args!</span>(args, first);
            maj_car(first)
        }),
        (<span style="color: #ce9178;">"cdr"</span>, <span style="color: #4ec9b0;">MajPrimArgs</span>::<span style="color: #4ec9b0;">Required</span>(1), |_, args, _| {
            <span style="color: #c586c0;">maj_destructure_args!</span>(args, first);
            maj_cdr(first)
        }),
        (<span style="color: #ce9178;">"copy"</span>, <span style="color: #4ec9b0;">MajPrimArgs</span>::<span style="color: #4ec9b0;">Required</span>(1), |_, args, _| {
            <span style="color: #c586c0;">maj_destructure_args!</span>(args, first);
            maj_copy(first)
        }),
        (<span style="color: #ce9178;">"length"</span>, <span style="color: #4ec9b0;">MajPrimArgs</span>::<span style="color: #4ec9b0;">Required</span>(1), |_, args, _| {
            <span style="color: #c586c0;">maj_destructure_args!</span>(args, first);
            maj_length(first)
        }),
        (<span style="color: #ce9178;">"depth"</span>, <span style="color: #4ec9b0;">MajPrimArgs</span>::<span style="color: #4ec9b0;">Required</span>(1), |_, args, _| {
            <span style="color: #c586c0;">maj_destructure_args!</span>(args, first);
            maj_depth(first)
        }),
        (<span style="color: #ce9178;">"type"</span>, <span style="color: #4ec9b0;">MajPrimArgs</span>::<span style="color: #4ec9b0;">Required</span>(1), |<span style="color: #569cd6;">mut</span> state, args, _| {
            <span style="color: #c586c0;">maj_destructure_args!</span>(args, first);
            maj_type(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, first)
        }),
        (<span style="color: #ce9178;">"intern"</span>, <span style="color: #4ec9b0;">MajPrimArgs</span>::<span style="color: #4ec9b0;">Required</span>(1), |<span style="color: #569cd6;">mut</span> state, args, _| {
            <span style="color: #c586c0;">maj_destructure_args!</span>(args, first);
            maj_intern(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, first)
        }),
        (<span style="color: #ce9178;">"name"</span>, <span style="color: #4ec9b0;">MajPrimArgs</span>::<span style="color: #4ec9b0;">Required</span>(1), |<span style="color: #569cd6;">mut</span> state, args, _| {
            <span style="color: #c586c0;">maj_destructure_args!</span>(args, first);
            maj_name(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, first)
        }),
        (<span style="color: #ce9178;">"get-environment"</span>, <span style="color: #4ec9b0;">MajPrimArgs</span>::<span style="color: #4ec9b0;">Required</span>(1),
         |<span style="color: #569cd6;">mut</span> state, args, env| {
            <span style="color: #c586c0;">maj_destructure_args!</span>(args, first);
            maj_get_environment(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, first, env)
        }),
        (<span style="color: #ce9178;">"coin"</span>, <span style="color: #4ec9b0;">MajPrimArgs</span>::<span style="color: #4ec9b0;">None</span>, |_, _, _| maj_coin()),
        (<span style="color: #ce9178;">"sys"</span>, <span style="color: #4ec9b0;">MajPrimArgs</span>::<span style="color: #4ec9b0;">Variadic</span>(1), |_, args, _| {
            <span style="color: #c586c0;">maj_destructure_args!</span>(args, first, rest);
            maj_sys(first, rest)
        }),
        (<span style="color: #ce9178;">"format"</span>, <span style="color: #4ec9b0;">MajPrimArgs</span>::<span style="color: #4ec9b0;">Variadic</span>(1), |state, args, _| {
            <span style="color: #c586c0;">maj_destructure_args!</span>(args, first, rest);
            maj_format_prim(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span>state, first, rest)
        }),
        (<span style="color: #ce9178;">"err"</span>, <span style="color: #4ec9b0;">MajPrimArgs</span>::<span style="color: #4ec9b0;">Variadic</span>(1), |_, args, _| {
            <span style="color: #c586c0;">maj_destructure_args!</span>(args, first, rest);
            maj_err(first, rest)
        }),
        (<span style="color: #ce9178;">"warn"</span>, <span style="color: #4ec9b0;">MajPrimArgs</span>::<span style="color: #4ec9b0;">Variadic</span>(1), |<span style="color: #569cd6;">mut</span> state, args, env| {
            <span style="color: #c586c0;">maj_destructure_args!</span>(args, first, rest);
            maj_warn(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, first, rest, env)
        }),
        (<span style="color: #ce9178;">"list"</span>, <span style="color: #4ec9b0;">MajPrimArgs</span>::<span style="color: #4ec9b0;">Variadic</span>(0),
         |_, args, _| maj_list(args)),
        (<span style="color: #ce9178;">"append"</span>, <span style="color: #4ec9b0;">MajPrimArgs</span>::<span style="color: #4ec9b0;">Variadic</span>(0),
         |_, args, _| maj_append(args)),
        (<span style="color: #ce9178;">"last"</span>, <span style="color: #4ec9b0;">MajPrimArgs</span>::<span style="color: #4ec9b0;">Required</span>(1), |_, args, _| {
            <span style="color: #c586c0;">maj_destructure_args!</span>(args, first);
            maj_last(first)
        }),
        (<span style="color: #ce9178;">"reverse"</span>, <span style="color: #4ec9b0;">MajPrimArgs</span>::<span style="color: #4ec9b0;">Required</span>(1), |_, args, _| {
            <span style="color: #c586c0;">maj_destructure_args!</span>(args, first);
            maj_reverse(first)
        }),
        (<span style="color: #ce9178;">"nth"</span>, <span style="color: #4ec9b0;">MajPrimArgs</span>::<span style="color: #4ec9b0;">Required</span>(2), |_, args, _| {
            <span style="color: #c586c0;">maj_destructure_args!</span>(args, first, rest, second);
            maj_nth(first, second)
        }),
        (<span style="color: #ce9178;">"nthcdr"</span>, <span style="color: #4ec9b0;">MajPrimArgs</span>::<span style="color: #4ec9b0;">Required</span>(2), |_, args, _| {
            <span style="color: #c586c0;">maj_destructure_args!</span>(args, first, rest, second);
            maj_nthcdr(first, second)
        }),
        (<span style="color: #ce9178;">"macroexpand-1"</span>, <span style="color: #4ec9b0;">MajPrimArgs</span>::<span style="color: #4ec9b0;">Required</span>(1),
         |<span style="color: #569cd6;">mut</span> state, args, env| {
             <span style="color: #c586c0;">maj_destructure_args!</span>(args, first);
             <span style="color: #569cd6;">let</span> (result, _) =
                 maj_macroexpand_1(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, first, env);
             result
         }),
        (<span style="color: #ce9178;">"not"</span>, <span style="color: #4ec9b0;">MajPrimArgs</span>::<span style="color: #4ec9b0;">Required</span>(1), |_, args, _| {
            <span style="color: #c586c0;">maj_destructure_args!</span>(args, first);
            maj_not(first)
        }),
        (<span style="color: #ce9178;">"gensym"</span>, <span style="color: #4ec9b0;">MajPrimArgs</span>::<span style="color: #4ec9b0;">None</span>,
         |<span style="color: #569cd6;">mut</span> state, _, _| maj_gensym(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state)),
        (<span style="color: #ce9178;">"iota"</span>, <span style="color: #4ec9b0;">MajPrimArgs</span>::<span style="color: #4ec9b0;">Required</span>(1), |_, args, _| {
            <span style="color: #c586c0;">maj_destructure_args!</span>(args, first);
            maj_iota(first)
         }),

        <span style="color: #6a9955;">// </span><span style="color: #6a9955;">Number functions</span>
        (<span style="color: #ce9178;">"number-coerce"</span>, <span style="color: #4ec9b0;">MajPrimArgs</span>::<span style="color: #4ec9b0;">Required</span>(2),
         |<span style="color: #569cd6;">mut</span> state, args, _| {
             <span style="color: #c586c0;">maj_destructure_args!</span>(args, first, rest, second);
             maj_number_coerce(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, first, second)
         }),
        (<span style="color: #ce9178;">"real-part"</span>, <span style="color: #4ec9b0;">MajPrimArgs</span>::<span style="color: #4ec9b0;">Required</span>(1), |_, args, _| {
            <span style="color: #c586c0;">maj_destructure_args!</span>(args, first);
            maj_real_part(first)
        }),
        (<span style="color: #ce9178;">"imag-part"</span>, <span style="color: #4ec9b0;">MajPrimArgs</span>::<span style="color: #4ec9b0;">Required</span>(1), |_, args, _| {
            <span style="color: #c586c0;">maj_destructure_args!</span>(args, first);
            maj_imag_part(first)
        }),
        (<span style="color: #ce9178;">"numer"</span>, <span style="color: #4ec9b0;">MajPrimArgs</span>::<span style="color: #4ec9b0;">Required</span>(1), |_, args, _| {
            <span style="color: #c586c0;">maj_destructure_args!</span>(args, first);
            maj_numer(first)
        }),
        (<span style="color: #ce9178;">"denom"</span>, <span style="color: #4ec9b0;">MajPrimArgs</span>::<span style="color: #4ec9b0;">Required</span>(1), |_, args, _| {
            <span style="color: #c586c0;">maj_destructure_args!</span>(args, first);
            maj_denom(first)
        }),
        (<span style="color: #ce9178;">"richest-number-type"</span>, <span style="color: #4ec9b0;">MajPrimArgs</span>::<span style="color: #4ec9b0;">Required</span>(2),
         |<span style="color: #569cd6;">mut</span> state, args, _| {
            <span style="color: #c586c0;">maj_destructure_args!</span>(args, first, rest, second);
            maj_richest_number_type(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, first, second)
        }),
        (<span style="color: #ce9178;">"rich-number-coerce"</span>, <span style="color: #4ec9b0;">MajPrimArgs</span>::<span style="color: #4ec9b0;">Required</span>(2),
         |<span style="color: #569cd6;">mut</span> state, args, _| {
             <span style="color: #c586c0;">maj_destructure_args!</span>(args, first, rest, second);
             maj_rich_number_coerce(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, first, second)
         }),
        (<span style="color: #ce9178;">"="</span>, <span style="color: #4ec9b0;">MajPrimArgs</span>::<span style="color: #4ec9b0;">Variadic</span>(2),
         |<span style="color: #569cd6;">mut</span> state, args, env| {
             <span style="color: #c586c0;">maj_destructure_args!</span>(args, first, r, second, rest);
             maj_arithm_eq(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, env, first, second, rest)
         }),
        (<span style="color: #ce9178;">"float="</span>, <span style="color: #4ec9b0;">MajPrimArgs</span>::<span style="color: #4ec9b0;">Required</span>(2),
         |<span style="color: #569cd6;">mut</span> state, args, env| {
             <span style="color: #c586c0;">maj_destructure_args!</span>(args, first, r, second);
             maj_arithm_floateq(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, env, first, second)
         }),
        (<span style="color: #ce9178;">"&gt;"</span>, <span style="color: #4ec9b0;">MajPrimArgs</span>::<span style="color: #4ec9b0;">Variadic</span>(2),
         |<span style="color: #569cd6;">mut</span> state, args, _| {
             <span style="color: #c586c0;">maj_destructure_args!</span>(args, first, r, second, rest);
             maj_arithm_greater(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, first, second, rest)
         }),
        (<span style="color: #ce9178;">"&lt;"</span>, <span style="color: #4ec9b0;">MajPrimArgs</span>::<span style="color: #4ec9b0;">Variadic</span>(2),
         |<span style="color: #569cd6;">mut</span> state, args, _| {
             <span style="color: #c586c0;">maj_destructure_args!</span>(args, first, r, second, rest);
             maj_arithm_lesser(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, first, second, rest)
         }),
        (<span style="color: #ce9178;">"&gt;="</span>, <span style="color: #4ec9b0;">MajPrimArgs</span>::<span style="color: #4ec9b0;">Variadic</span>(2),
         |<span style="color: #569cd6;">mut</span> state, args, env| {
             <span style="color: #c586c0;">maj_destructure_args!</span>(args, first, r, second, rest);
             maj_arithm_geq(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, env, first, second, rest)
         }),
        (<span style="color: #ce9178;">"&lt;="</span>, <span style="color: #4ec9b0;">MajPrimArgs</span>::<span style="color: #4ec9b0;">Variadic</span>(2),
         |<span style="color: #569cd6;">mut</span> state, args, env| {
             <span style="color: #c586c0;">maj_destructure_args!</span>(args, first, r, second, rest);
             maj_arithm_leq(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, env, first, second, rest)
         }),
        (<span style="color: #ce9178;">"+"</span>, <span style="color: #4ec9b0;">MajPrimArgs</span>::<span style="color: #4ec9b0;">Variadic</span>(0),
         |<span style="color: #569cd6;">mut</span> state, args, env| {
             maj_arithm_plus(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, env, args)
         }),
        (<span style="color: #ce9178;">"-"</span>, <span style="color: #4ec9b0;">MajPrimArgs</span>::<span style="color: #4ec9b0;">Variadic</span>(0),
         |<span style="color: #569cd6;">mut</span> state, args, env| {
             maj_arithm_minus(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, env, args)
         }),
        (<span style="color: #ce9178;">"*"</span>, <span style="color: #4ec9b0;">MajPrimArgs</span>::<span style="color: #4ec9b0;">Variadic</span>(0),
         |<span style="color: #569cd6;">mut</span> state, args, env| {
             maj_arithm_times(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, env, args)
         }),
        (<span style="color: #ce9178;">"/"</span>, <span style="color: #4ec9b0;">MajPrimArgs</span>::<span style="color: #4ec9b0;">Variadic</span>(0),
         |<span style="color: #569cd6;">mut</span> state, args, env| {
             maj_arithm_divide(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, env, args)
         }),

        <span style="color: #6a9955;">// </span><span style="color: #6a9955;">Stream functions</span>
        (<span style="color: #ce9178;">"open-stream"</span>, <span style="color: #4ec9b0;">MajPrimArgs</span>::<span style="color: #4ec9b0;">Required</span>(2), |<span style="color: #569cd6;">mut</span> state, args, _| {
            <span style="color: #c586c0;">maj_destructure_args!</span>(args, first, rest, second);
            maj_open_stream(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, first, second)
        }),
        (<span style="color: #ce9178;">"close-stream"</span>, <span style="color: #4ec9b0;">MajPrimArgs</span>::<span style="color: #4ec9b0;">Required</span>(1), |<span style="color: #569cd6;">mut</span> state, args, _| {
            <span style="color: #c586c0;">maj_destructure_args!</span>(args, first);
            maj_close_stream(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, first)
        }),
        (<span style="color: #ce9178;">"stat"</span>, <span style="color: #4ec9b0;">MajPrimArgs</span>::<span style="color: #4ec9b0;">Required</span>(1), |<span style="color: #569cd6;">mut</span> state, args, _| {
            <span style="color: #c586c0;">maj_destructure_args!</span>(args, first);
            maj_stat(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, first)
        }),
        (<span style="color: #ce9178;">"read-char"</span>, <span style="color: #4ec9b0;">MajPrimArgs</span>::<span style="color: #4ec9b0;">Required</span>(1), |<span style="color: #569cd6;">mut</span> state, args, _| {
            <span style="color: #c586c0;">maj_destructure_args!</span>(args, first);
            maj_read_char(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, first)
        }),
        (<span style="color: #ce9178;">"peek-char"</span>, <span style="color: #4ec9b0;">MajPrimArgs</span>::<span style="color: #4ec9b0;">Required</span>(1), |<span style="color: #569cd6;">mut</span> state, args, _| {
            <span style="color: #c586c0;">maj_destructure_args!</span>(args, first);
            maj_peek_char(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, first)
        }),
        (<span style="color: #ce9178;">"write-char"</span>, <span style="color: #4ec9b0;">MajPrimArgs</span>::<span style="color: #4ec9b0;">Required</span>(2), |<span style="color: #569cd6;">mut</span> state, args, _| {
            <span style="color: #c586c0;">maj_destructure_args!</span>(args, first, rest, second);
            maj_write_char(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, first, second)
        }),
        (<span style="color: #ce9178;">"write-string"</span>, <span style="color: #4ec9b0;">MajPrimArgs</span>::<span style="color: #4ec9b0;">Required</span>(2), |<span style="color: #569cd6;">mut</span> state, args, _| {
            <span style="color: #c586c0;">maj_destructure_args!</span>(args, first, rest, second);
            maj_write_string(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, first, second)
        }),
        (<span style="color: #ce9178;">"write"</span>, <span style="color: #4ec9b0;">MajPrimArgs</span>::<span style="color: #4ec9b0;">Required</span>(2), |<span style="color: #569cd6;">mut</span> state, args, _| {
            <span style="color: #c586c0;">maj_destructure_args!</span>(args, first, rest, second);
            maj_write(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, first, second)
        }),
        (<span style="color: #ce9178;">"terpri"</span>, <span style="color: #4ec9b0;">MajPrimArgs</span>::<span style="color: #4ec9b0;">None</span>, |<span style="color: #569cd6;">mut</span> state, _, env| {
            maj_terpri(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, env)
        }),
        (<span style="color: #ce9178;">"display"</span>, <span style="color: #4ec9b0;">MajPrimArgs</span>::<span style="color: #4ec9b0;">Required</span>(1), |<span style="color: #569cd6;">mut</span> state, args, env| {
            <span style="color: #c586c0;">maj_destructure_args!</span>(args, first);
            maj_display(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, first, env)
        }),
        (<span style="color: #ce9178;">"pretty-display"</span>, <span style="color: #4ec9b0;">MajPrimArgs</span>::<span style="color: #4ec9b0;">Required</span>(1),
         |<span style="color: #569cd6;">mut</span> state, args, env| {
             <span style="color: #c586c0;">maj_destructure_args!</span>(args, first);
             maj_pretty_display(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, first, env)
         }),
        (<span style="color: #ce9178;">"print"</span>, <span style="color: #4ec9b0;">MajPrimArgs</span>::<span style="color: #4ec9b0;">Variadic</span>(1), |<span style="color: #569cd6;">mut</span> state, args, env| {
            <span style="color: #c586c0;">maj_destructure_args!</span>(args, first, rest);
            maj_print(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, first, rest, env)
        }),
        (<span style="color: #ce9178;">"load"</span>, <span style="color: #4ec9b0;">MajPrimArgs</span>::<span style="color: #4ec9b0;">Required</span>(1), |<span style="color: #569cd6;">mut</span> state, args, env| {
            <span style="color: #c586c0;">maj_destructure_args!</span>(args, first);
            maj_load(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, env, first)
        }),

        <span style="color: #6a9955;">// </span><span style="color: #6a9955;">Vector functions</span>
        (<span style="color: #ce9178;">"vec-type"</span>, <span style="color: #4ec9b0;">MajPrimArgs</span>::<span style="color: #4ec9b0;">Required</span>(1), |<span style="color: #569cd6;">mut</span> state, args, _| {
            <span style="color: #c586c0;">maj_destructure_args!</span>(args, first);
            maj_vec_type(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, first)
        }),
        (<span style="color: #ce9178;">"vec-push"</span>, <span style="color: #4ec9b0;">MajPrimArgs</span>::<span style="color: #4ec9b0;">Required</span>(2), |<span style="color: #569cd6;">mut</span> state, args, _| {
            <span style="color: #c586c0;">maj_destructure_args!</span>(args, first, rest, second);
            maj_vec_push(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, first, second)
        }),
        (<span style="color: #ce9178;">"vec-insert"</span>, <span style="color: #4ec9b0;">MajPrimArgs</span>::<span style="color: #4ec9b0;">Required</span>(3), |<span style="color: #569cd6;">mut</span> state, args, _| {
            <span style="color: #c586c0;">maj_destructure_args!</span>(args, first, rest, second,
                                  sndrst, third);
            maj_vec_insert(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, first, second, third)
        }),
        (<span style="color: #ce9178;">"vec-coerce"</span>, <span style="color: #4ec9b0;">MajPrimArgs</span>::<span style="color: #4ec9b0;">Required</span>(2), |<span style="color: #569cd6;">mut</span> state, args, _| {
            <span style="color: #c586c0;">maj_destructure_args!</span>(args, first, rest, second);
            maj_vec_coerce(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, first, second)
        }),
        (<span style="color: #ce9178;">"vector"</span>, <span style="color: #4ec9b0;">MajPrimArgs</span>::<span style="color: #4ec9b0;">Variadic</span>(0), |<span style="color: #569cd6;">mut</span> state, args, _| {
            maj_vector(<span style="color: #d4d4d4; background-color: #1e1e1e;">&amp;</span><span style="color: #569cd6;">mut</span> state, args)
        }),
        (<span style="color: #ce9178;">"vec-length"</span>, <span style="color: #4ec9b0;">MajPrimArgs</span>::<span style="color: #4ec9b0;">Required</span>(1), |_, args, _| {
            <span style="color: #c586c0;">maj_destructure_args!</span>(args, first);
            maj_vec_length(first)
        }),
        (<span style="color: #ce9178;">"vec-pop"</span>, <span style="color: #4ec9b0;">MajPrimArgs</span>::<span style="color: #4ec9b0;">Required</span>(1), |_, args, _| {
            <span style="color: #c586c0;">maj_destructure_args!</span>(args, first);
            maj_vec_pop(first)
        }),
        (<span style="color: #ce9178;">"vec-deq"</span>, <span style="color: #4ec9b0;">MajPrimArgs</span>::<span style="color: #4ec9b0;">Required</span>(1), |_, args, _| {
            <span style="color: #c586c0;">maj_destructure_args!</span>(args, first);
            maj_vec_deq(first)
        }),
        (<span style="color: #ce9178;">"vec-at"</span>, <span style="color: #4ec9b0;">MajPrimArgs</span>::<span style="color: #4ec9b0;">Required</span>(2), |_, args, _| {
            <span style="color: #c586c0;">maj_destructure_args!</span>(args, first, rest, second);
            maj_vec_at(first, second)
        }),
        (<span style="color: #ce9178;">"vec-set"</span>, <span style="color: #4ec9b0;">MajPrimArgs</span>::<span style="color: #4ec9b0;">Required</span>(3), |_, args, _| {
            <span style="color: #c586c0;">maj_destructure_args!</span>(args, first, rest, second,
                                  snd_rest, third);
            maj_vec_set(first, second, third)
        }),
        (<span style="color: #ce9178;">"vec-remove"</span>, <span style="color: #4ec9b0;">MajPrimArgs</span>::<span style="color: #4ec9b0;">Required</span>(2), |_, args, _| {
            <span style="color: #c586c0;">maj_destructure_args!</span>(args, first, rest, second);
            maj_vec_remove(first, second)
        }),

        <span style="color: #6a9955;">// </span><span style="color: #6a9955;">Non-standard functions</span>
        (<span style="color: #ce9178;">"gc"</span>, <span style="color: #4ec9b0;">MajPrimArgs</span>::<span style="color: #4ec9b0;">None</span>, |_, _, _| maj_gc()),
        (<span style="color: #ce9178;">"print-env"</span>, <span style="color: #4ec9b0;">MajPrimArgs</span>::<span style="color: #4ec9b0;">Required</span>(1), maj_print_env),
        (<span style="color: #ce9178;">"stack-state"</span>, <span style="color: #4ec9b0;">MajPrimArgs</span>::<span style="color: #4ec9b0;">None</span>, |_, _, _| maj_stack_state()),
    ];

    <span style="color: #569cd6;">for</span> <span style="color: #9cdcfe;">primitive</span> <span style="color: #569cd6;">in</span> primitives.iter() {
        <span style="color: #569cd6;">let</span> (name, arity, f) = primitive;
        state.register_primitive(name, *arity, *f);
    }
}
</pre>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: Lucas S. Vieira</p>
<p class="date">Created: 2022-10-23 dom 23:28</p>
<p class="validation"><a href="https://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
